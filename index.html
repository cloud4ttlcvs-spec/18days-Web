<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>18天生啤 OPS 戰情室 v13</title>
    <!-- Updated viewport meta tag for better mobile behavior, including safe-area insets -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <!-- MarkerCluster CSS for clustering markers on the map -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Leaflet heatmap plugin -->
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <style>
    :root {
      --bg-main: #050816;
      --bg-panel: #0b1020;
      --bg-panel-soft: #111827;
      --bg-chip: #1f2937;
      --border-subtle: #1f2937;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.12);
      --danger: #f97373;
      --warning: #facc15;
      --success: #22c55e;
      --card-radius: 14px;
      --shadow-soft: 0 12px 30px rgba(0, 0, 0, 0.45);
      --transition-fast: 0.15s ease-out;
      --pin-pink: #fb7185;
      --pin-red: #f97373;
      --pin-orange: #fb923c;
      --pin-yellow: #facc15;
      --pin-green: #34d399;
      --pin-blue: #60a5fa;
      --pin-gray: #9ca3af;
    }

    * { box-sizing: border-box; }

    html, body { height: 100%; }

    body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
    color: var(--text-main);

    /* Prevent mobile browsers (e.g., LINE WebView) from automatically scaling text which can cause layout breakage */
    -webkit-text-size-adjust: 100%;
    /* Hide any horizontal overflow that could appear due to rounding or oversized elements */
    overflow-x: hidden;
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 10px 18px;
      border-bottom: 1px solid #111827;
      background: linear-gradient(90deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.88));
      backdrop-filter: blur(16px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      z-index: 20;
      position: sticky;
      top: 0;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }

    .brand-logo {
      width: 28px;
      height: 28px;
      border-radius: 10px;
      background: radial-gradient(circle at 20% 20%, #f97373 0, #fb7185 40%, #0ea5e9 100%);
      box-shadow: 0 0 20px rgba(248, 113, 113, 0.6);
    }

    .brand-text-main {
      font-weight: 600;
      letter-spacing: 0.04em;
      font-size: 15px;
    }

    .brand-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .header-summary {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .summary-pill {
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .summary-pill strong {
      color: var(--text-main);
      font-weight: 600;
    }

    .header-filters {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-shrink: 0;
    }

    .chip-button {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 7px 12px;
      font-size: 12px;
      background: rgba(15,23,42,0.9);
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: background var(--transition-fast), border-color var(--transition-fast), color var(--transition-fast);
      white-space: nowrap;
    }

    /* 特別調整戰情模式按鈕的字體大小與間距，讓圖示更明顯 */
    #mode-switch {
      font-size: 14px;
      padding-left: 12px;
      padding-right: 14px;
    }
    .chip-button--active {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: var(--accent);
    }

    /* 調整地圖模式按鈕字體與圖示大小，使其更顯眼 */
    #mode-switch {
      /* 顯示地圖模式按鈕，原本隱藏戰情模式的設定已移除。 */
      display: inline-flex;
    }

    /* 淺色主題：覆寫顏色變數與背景色 */
    body.light-theme {
      --bg-main: #f7fafe;
      --bg-panel: #ffffff;
      --bg-panel-soft: #f1f5f9;
      --bg-chip: #e5e7eb;
      --border-subtle: #d1d5db;
      --text-main: #1f2937;
      --text-muted: #6b7280;
      --accent-soft: rgba(56, 189, 248, 0.15);
    }

  /* 淺色模式下，將各類卡片和膠囊背景改為米白色，字體改為黑色，強化可讀性 */
  body.light-theme .store-card,
  body.light-theme .panel,
  body.light-theme #detail-panel,
  body.light-theme .map-overlay-inner,
  body.light-theme .region-modal-inner,
  body.light-theme #war-popup,
  body.light-theme .modal-content,
  body.light-theme .war-popup,
  body.light-theme .modal-body {
    /* 統一米白色背景搭配深色文字，使淺色模式更清晰 */
    background: #fff7eb;
    color: #1f2937;
  }

  /* 淺色主題下：通知代送商彈窗與遮罩背景改為淡色 */
  body.light-theme .modal-backdrop {
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(4px);
  }
  body.light-theme .modal {
    background: #fff7eb;
    border-color: #e8dcc9;
    color: #1f2937;
    box-shadow: 0 12px 36px rgba(0, 0, 0, 0.25);
  }
  body.light-theme .modal-title {
    color: #1f2937;
  }
  body.light-theme .modal-body {
    color: #374151;
  }
  body.light-theme .btn-secondary {
    background: #f9f4e7;
    border-color: #e8dcc9;
    color: #1f2937;
  }
  body.light-theme .btn-secondary:hover {
    background: #ede4d3;
    border-color: #e8dcc9;
  }
  body.light-theme .btn-primary {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
  }
  body.light-theme .btn-primary:hover {
    background: #0ea5e9;
    border-color: #0ea5e9;
  }
  /* 淺色主題下：toast 提示背景與文字顏色 */
  body.light-theme .toast {
    background: rgba(255, 247, 235, 0.92);
    border-color: #e8dcc9;
    color: #1f2937;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }
  body.light-theme .panel,
  body.light-theme .region-modal-inner,
  body.light-theme #war-popup,
  body.light-theme .store-card {
    border-color: #e0d9c1;
  }
  body.light-theme .summary-pill {
    background: rgba(255,255,255,0.9);
    border-color: rgba(209,213,219,0.9);
    color: #6b7280;
  }
  body.light-theme .summary-pill strong {
    color: #1f2937;
  }
  /* 淺色模式下 Last Sync 文字改為藍色 */
  body.light-theme .last-sync {
    color: #38bdf8;
  }

  /* 淺色模式下，門市列表標題中的門市數量徽章使用較淡的米色底與深色文字。
     原本的深色徽章在淺色主題下視覺過於突兀，因此針對 span.badge 重新定義。 */
  body.light-theme .panel-title span.badge {
    background: #fbf7ef;
    border-color: #e8dcc9;
    color: #1f2937;
  }
    body.light-theme {
      background: radial-gradient(circle at top, #ffffff 0, #f0f4f8 45%, #e2e8f0 100%);
      color: var(--text-main);
    }
    body.light-theme header {
      background: linear-gradient(90deg, rgba(255,255,255,0.96), rgba(245,247,250,0.88));
      border-bottom-color: var(--border-subtle);
    }
    body.light-theme .panel {
      background: radial-gradient(circle at top left, #f8fafc 0, #e2e8f0 65%);
      border-color: var(--border-subtle);
    }
  /* 淺色模式下：摘要數量膠囊改用米白背景與深色文字 */
  body.light-theme .summary-pill {
    /* 使用稍深的米白底色以與其他 chip 區分層級 */
    /* Use a deeper beige for summary pills to clearly distinguish them from
       the lighter header buttons.  This warmer tone improves visual hierarchy. */
    /* 深米白底色使摘要膠囊在淺色主題中更加凸顯，與功能按鈕形成清晰的層級差異 */
    background: #efe2c8;
    border-color: #e0d2b3;
    color: #1f2937;
  }
  body.light-theme .summary-pill strong {
    color: #1f2937;
  }

/* 淺色模式下：標題列中的各類 chip 按鈕底色使用淡米白，與摘要膠囊有所區分 */
body.light-theme header .chip-button {
  /* Header chips use a slightly lighter beige to differentiate from the summary pills */
  /* 淺米白底色用於標題列功能按鈕，使其顏色比摘要膠囊更淡，形成層級差異 */
  background: #fbf7ef;
  border-color: #eadfd0;
  color: #1f2937;
}
/* 淺色模式下：標題列 chip 按鈕啟用狀態使用略深底色 */
body.light-theme header .chip-button.chip-button--active {
  background: rgba(56,189,248,0.25);
  border-color: var(--accent);
  color: var(--accent);
}


  /* 淺色模式下：搜尋欄和輸入框背景與文字顏色 */
  body.light-theme .search-input {
    background: #fff7eb;
    border-color: #e0d9c1;
    color: #1f2937;
  }
  body.light-theme .search-input::placeholder {
    color: #6b7280;
  }
  body.light-theme .select-input {
    background: #fff7eb;
    border-color: #e0d9c1;
    color: #1f2937;
  }

  /* 淺色模式下：門市列表篩選晶片（紅燈、黃燈、重要客戶、未處理、已處理、全部門市）改為米白背景與深色文字 */
  body.light-theme .filter-chip {
    background: #fff7eb;
    border-color: #e0d9c1;
    color: #1f2937;
  }
  body.light-theme .filter-chip--active {
    background: rgba(56,189,248,0.12);
    border-color: var(--accent);
    color: var(--accent);
  }

  /* 淺色模式下：總覽統計（紅燈、黃燈、重要客戶、未處理、已處理、全部門市）等狀態摘要膠囊改為米白背景與深色文字 */
  body.light-theme .summary-pill {
    background: #fff7eb;
    border-color: #e0d9c1;
    color: #1f2937;
  }
  body.light-theme .summary-pill strong {
    color: #1f2937;
  }

  /* 淺色模式下：搜尋欄、下拉選單、計數篩選按鈕保持米白背景與深色文字 */
  body.light-theme .search-input,
  body.light-theme .select-input,
  body.light-theme .filter-select {
    background: #fff7eb;
    border-color: #e0d9c1;
    color: #1f2937;
  }
  body.light-theme .search-input::placeholder {
    color: #6b7280;
  }

  /* 淺色模式下：chip-button 及其 active 狀態採用米白或 accent 底色，深色文字 */
  body.light-theme .chip-button {
    background: #fff7eb;
    border-color: #e0d9c1;
    color: #1f2937;
  }
  body.light-theme .chip-button--active {
    background: rgba(56,189,248,0.12);
    border-color: var(--accent);
    color: var(--accent);
  }

  /*
    淺色模式下補充配色：
    - 列表與詳細頁中的膠囊、標籤、按鈕改為米白底搭配深色文字。
    - 確保淺色模式各種元件具有一致的視覺語言。
  */
  body.light-theme .metric-pill,
  body.light-theme .mini-kpi-pill,
  body.light-theme .detail-status-chip,
  body.light-theme .detail-map-toggle,
  body.light-theme .tag,
  body.light-theme .store-corner-toggle,
  body.light-theme .icon-button {
    background: #fff7eb;
    border-color: #e0d9c1;
    color: #1f2937;
  }
  body.light-theme .metric-pill strong,
  body.light-theme .mini-kpi-pill strong {
    color: #1f2937;
  }
  /* hover 狀態以 accent 作為視覺提示 */
  body.light-theme .icon-button:hover,
  body.light-theme .store-corner-toggle:hover,
  body.light-theme .detail-map-toggle:hover {
    border-color: var(--accent);
    color: var(--accent);
    box-shadow: 0 0 12px rgba(56,189,248,0.4);
  }
  /* 詳細頁地圖切換鈕 active 狀態 */
  body.light-theme .detail-map-toggle-active {
    background: rgba(56,189,248,0.12);
    border-color: var(--accent);
    color: var(--accent);
  }
  /* 次級按鈕在淺色模式下改用米白底和深色文字 */
  body.light-theme .btn-secondary {
    background: #fff7eb;
    border-color: #e0d9c1;
    color: #1f2937;
  }
  body.light-theme .btn-secondary:hover {
    border-color: var(--accent);
    color: var(--accent);
    box-shadow: 0 0 18px rgba(56,189,248,0.45);
  }

  /*
   * 淺色主題下，門市詳細區的主要與次級按鈕（通知代送商、導航）的顏色
   * 改為更柔和的米白色系，與整體卡片背景一致。
   * 透過區域選擇器 .detail-actions 確保只影響詳細面板底部按鈕。
   */
  body.light-theme .detail-actions .btn-primary {
    background: linear-gradient(135deg, #fde4ca, #f9d7a2);
    border-color: #f5c787;
    color: #523514;
    box-shadow: 0 6px 18px rgba(245, 199, 135, 0.4);
  }
  body.light-theme .detail-actions .btn-secondary {
    background: #fffaf2;
    border-color: #f5c787;
    color: #523514;
    box-shadow: none;
  }
  body.light-theme .detail-actions .btn-primary:hover,
  body.light-theme .detail-actions .btn-secondary:hover {
    transform: translateY(-1px);
    box-shadow: 0 12px 30px rgba(245, 199, 135, 0.5);
  }


  /* 淺色模式下：優先度條底色與文字調整，確保清晰可見 */
  body.light-theme .priority-bar {
    /* 調整優先度條底色並加上邊框，使淺色模式下的進度條清晰可見 */
    background: #e0d9c1;
    border: 1px solid #d1d5db;
  }
  body.light-theme .priority-label {
    color: #6b7280;
  }

  /* 淺色模式下：下拉選單與篩選器改為米白色背景與深色文字 */
  body.light-theme .filter-select,
  body.light-theme .select-input {
    background: #fff7eb;
    border-color: #e0d9c1;
    color: #1f2937;
  }

  /* 淺色模式下：地區下拉選單背景與文字顏色 */
  body.light-theme .region-dropdown {
    background: #fff7eb;
    border-color: #e0d9c1;
    box-shadow: 0 8px 20px rgba(0,0,0,0.05);
  }
  body.light-theme .region-dropdown .region-item {
    color: #1f2937;
  }
  body.light-theme .region-dropdown .region-item:hover {
    background: rgba(56,189,248,0.12);
    color: var(--accent);
  }
  body.light-theme .region-dropdown .region-item.active {
    background: rgba(56,189,248,0.24);
    color: var(--accent);
  }

    body.light-theme .chip-button {
      /* 米白背景和深色文字，使篩選按鈕更清晰 */
      background: #fff7eb;
      border-color: #e0d9c1;
      color: #1f2937;
    }
    body.light-theme .chip-button--active {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: var(--accent);
    }

    main.layout {
      flex: 1;
      display: grid;
      grid-template-columns: 30% 40% 30%;
      gap: 10px;
      padding: 10px;
    }

    .panel {
      background: radial-gradient(circle at top left, #111827 0, #020617 65%);
      border-radius: 18px;
      border: 1px solid #111827;
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .panel-header {
      padding: 8px 12px 6px;
      border-bottom: 1px solid #111827;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      /* 讓列表標題列固定於上方，不隨列表滾動 */
      position: sticky;
      top: 0;
      z-index: 2;
      background: var(--bg-panel);
    }

    .panel-title {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .panel-title span.badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(31, 41, 55, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: var(--accent);
      /* 讓徽章文字置中 */
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .panel-header-controls {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .search-input {
      background: #020617;
      border-radius: 999px;
      border: 1px solid #111827;
      padding: 5px 10px;
      font-size: 11px;
      color: var(--text-main);
      outline: none;
      min-width: 0;
    }

    .search-input::placeholder {
      color: #4b5563;
    }

    .select-input {
      background: #020617;
      border-radius: 999px;
      border: 1px solid #111827;
      padding: 4px 8px;
      font-size: 11px;
      color: var(--text-muted);
      outline: none;
    }

    .panel-body {
      flex: 1;
      padding: 8px;
    }

    .panel-body--detail {
      padding: 0;
    }

    .detail-container-placeholder {
      padding: 14px 12px;
      font-size: 12px;
      color: var(--text-muted);
    }

    /* 左欄：門市列表 */

    .filters-row {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-chip {
      padding: 4px 8px;
      font-size: 11px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid #111827;
      color: var(--text-muted);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background var(--transition-fast), border-color var(--transition-fast), color var(--transition-fast);
      white-space: nowrap;
    }
    .filter-chip--active {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: var(--accent);
    }

    .store-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    /* 門市卡片 */

    .store-card {
      background: linear-gradient(135deg, #020617, #020617 55%, #050816 100%);
      border-radius: 14px;
      border: 1px solid #111827;
      /* Reduce padding and column gap to shrink overall card height on mobile */
      padding: 4px 6px 8px;
      font-size: 11px;
      display: grid;
      /*
         Use flexible column widths to adapt to varying device widths.
         - The first column grows to fill available space for the store name and meta info.
         - The middle column (sales/metrics) has a reasonable minimum width but can grow on larger screens.
         - The right column (action icons) uses clamp() to provide a wider range, ensuring icons never clip
           on narrow devices while avoiding excessive wasted space on large screens.
         This improves responsiveness across phones with very narrow or wide screens.
       */
    /* Adjust column widths: first column flexible, second column (PSD/inv) min 70px max 100px,
       third column (actions) uses a clamp to ensure enough space for up to three icons without forcing
       horizontal scrolling on smaller devices. */
    grid-template-columns: minmax(0, 1fr) minmax(70px, 100px) clamp(130px, 24vw, 170px);
      column-gap: 4px;
      align-items: stretch;
      cursor: pointer;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast), transform var(--transition-fast), background 0.2s ease-out;
      position: relative;
    }

    .store-card:hover {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.7), 0 22px 40px rgba(0, 0, 0, 0.75);
      transform: translateY(-1px);
    }

    .store-card--active {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.8), 0 18px 40px rgba(56, 189, 248, 0.2);
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.14), #020617 55%);
    }

    .store-card-left {
      display: flex;
      flex-direction: column;
      gap: 1px;
      min-width: 0;
    }

    .store-name-row {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-wrap: nowrap;
    }

    .status-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      box-shadow: 0 0 12px rgba(248, 113, 113, 0.6);
      flex-shrink: 0;
    }

    .status-dot--critical {
      background: var(--danger);
    }
    .status-dot--warning {
      background: var(--warning);
      box-shadow: 0 0 12px rgba(250, 204, 21, 0.6);
    }
    .status-dot--normal {
      background: var(--success);
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.6);
    }

    .store-name {
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      /*
       * Increase the store name font size by roughly 10% over the original 14px. 16px provides
       * improved readability while keeping the overall card height stable.  The ellipsis
       * ensures long names do not wrap or push elements to the next line.
       */
      font-size: 16px;
    }

    .store-done-tag {
      font-size: 10px;
      padding: 1px 5px;
      border-radius: 999px;
      border: 1px solid #16a34a;
      color: #4ade80;
      background: rgba(22,163,74,0.18);
      flex-shrink: 0;
    }

    .store-meta {
      font-size: 10px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .store-distance {
      font-size: 10px;
      color: #6b7280;
    }

    .store-card-center {
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 1px;
      text-align: right;
      font-variant-numeric: tabular-nums;
      font-feature-settings: "tnum" 1;
      width: 85px;
      padding-right: 2px;
    }

    .weekly-sales-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      white-space: nowrap;
    }

    .weekly-sales-row {
      display: flex;
      justify-content: flex-end;
      align-items: baseline;
      gap: 6px;
      /* 稍微向右移動，使欄位與左側標題保持距離 */
      margin-left: 6px;
    }

    .weekly-sales-value {
      font-size: 18px;
      font-weight: 700;
      line-height: 1.1;
      display: block;
      white-space: nowrap;
    }

    /* always apply colour classes with highest priority so they override the card's base colour in both light and dark modes */
    .weekly-sales--pink { color: var(--pin-pink) !important; }
    .weekly-sales--red { color: var(--pin-red) !important; }
    .weekly-sales--orange { color: var(--pin-orange) !important; }
    .weekly-sales--yellow { color: var(--pin-yellow) !important; }
    .weekly-sales--green { color: var(--pin-green) !important; }
    .weekly-sales--blue { color: var(--pin-blue) !important; }
    .weekly-sales--gray { color: var(--pin-gray) !important; }

    /*
      在淺色模式下，由於 store-card 和其他容器會設置深色文字顏色，
      導致代表銷售值和漲跌的顏色被覆寫。以下規則提高了選擇器的專一度，
      以 store-card 為父層並加上具體 class 來確保顏色呈現。
    */
    body.light-theme .store-card .weekly-sales-value.weekly-sales--pink { color: var(--pin-pink) !important; }
    body.light-theme .store-card .weekly-sales-value.weekly-sales--red { color: var(--pin-red) !important; }
    body.light-theme .store-card .weekly-sales-value.weekly-sales--orange { color: var(--pin-orange) !important; }
    body.light-theme .store-card .weekly-sales-value.weekly-sales--yellow { color: var(--pin-yellow) !important; }
    body.light-theme .store-card .weekly-sales-value.weekly-sales--green { color: var(--pin-green) !important; }
    body.light-theme .store-card .weekly-sales-value.weekly-sales--blue { color: var(--pin-blue) !important; }
    body.light-theme .store-card .weekly-sales-value.weekly-sales--gray { color: var(--pin-gray) !important; }
    /* 調整銷售漲跌顏色：上漲顯示紅色，下降顯示綠色 */
    body.light-theme .store-card .weekly-sales-trend-up { color: #ef4444 !important; }
    body.light-theme .store-card .weekly-sales-trend-down { color: #10b981 !important; }

    /* In both themes, ensure the up/down trend colours override card base colour */
    .weekly-sales-trend-up {
      /* 上漲顯示紅色 */
      color: #ef4444 !important;
    }
    .weekly-sales-trend-down {
      /* 下跌顯示綠色 */
      color: #10b981 !important;
    }
    /* Also ensure the weekly sales value retains its colour class in light mode */
    body.light-theme .weekly-sales--pink { color: var(--pin-pink) !important; }
    body.light-theme .weekly-sales--red { color: var(--pin-red) !important; }
    body.light-theme .weekly-sales--orange { color: var(--pin-orange) !important; }
    body.light-theme .weekly-sales--yellow { color: var(--pin-yellow) !important; }
    body.light-theme .weekly-sales--green { color: var(--pin-green) !important; }
    body.light-theme .weekly-sales--blue { color: var(--pin-blue) !important; }
    body.light-theme .weekly-sales--gray { color: var(--pin-gray) !important; }

    .weekly-sales-trend {
      font-size: 10px;
      margin-top: 0;
      white-space: nowrap;
    }

    /* 已由前方定義 weekly-sales-trend-up/down 以 !important 控制顏色，此處移除重複定義 */

    .metric-pills {
      display: flex;
      flex-wrap: nowrap;
      gap: 3px;
      margin-top: 1px;
      justify-content: flex-end;
    }

    .metric-pill {
      border-radius: 999px;
      padding: 1px 4px;
      font-size: 9px;
      background: rgba(17,24,39,0.95);
      border: 1px solid rgba(31,41,55,0.9);
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 3px;
      white-space: nowrap;
    }

    .metric-pill strong {
      color: var(--text-main);
      font-weight: 500;
    }

    .store-card-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      /* Remove space-between to avoid large vertical gaps; rely on gap to space items */
      justify-content: flex-start;
      gap: 4px;
      /* Expand the right section to accommodate larger action icons without clipping. */
      width: 160px;
      /* 往左內縮一些，避免圖示被容器右側裁切 */
      padding-right: 10px;
    }

    .action-icons {
      display: flex;
      gap: 6px;
    }

    /* Tour manual sort drag handle */
    .drag-handle {
      cursor: grab;
      font-weight: 700;
      letter-spacing: 1px;
      user-select: none;
      touch-action: none;
    }

    body.dragging .drag-handle {
      cursor: grabbing;
    }

    .store-card--dragging {
      opacity: 0.95;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.55);
      transform: scale(1.01);
    }

    .store-card-placeholder {
      border: 1px dashed rgba(148, 163, 184, 0.55);
      border-radius: 14px;
      background: rgba(2, 6, 23, 0.35);
    }

    .icon-button {
      /* Moderate button size for navigation and notification icons in the store list.
         A width/height of around 2em (~32px on default font) matches the size used
         for the search icon and icons in the detail panel, without overwhelming
         the layout. */
      /* Further reduce the size of the navigation/notification buttons in the store list.
         Align them closer to the magnifying glass/search icon size and the icons used
         inside the bottom sheet. Previously these were 2.2em; now shrink slightly to
         2.6em to retain prominence without overwhelming the card. */
      width: 2.6em;
      height: 2.6em;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--text-muted);
      cursor: pointer;
      transition: background var(--transition-fast), border-color var(--transition-fast), color var(--transition-fast), box-shadow var(--transition-fast);
    }

    .icon-button:hover {
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 0 12px rgba(56, 189, 248, 0.4);
    }

    .tag {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(31,41,55,0.9);
      color: var(--text-muted);
      white-space: nowrap;
    }

    /*
     * 在淺色模式下，當門市標示為已處理時（tag-done 類別），
     * 文字顏色改為深綠色，呼應成功狀態。  深色模式維持原本顏色。
     */
    body.light-theme .tag.tag-done {
      color: #065f46;
    }

    /* Detail button on store card */
    .store-corner-toggle {
      position: relative;
      /* Remove extra margin so the button sits inline with icons */
      margin-top: 0;
      height: 22px;
      min-width: 22px;
      padding: 0 4px;
      font-size: 10px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: rgba(2,6,23,0.95);
      color: #9ca3af;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      cursor: pointer;
      transition: background var(--transition-fast), border-color var(--transition-fast), color var(--transition-fast), box-shadow var(--transition-fast);
    }

    .store-corner-toggle::before {
      content: "▾";
      font-size: 9px;
      opacity: 0.7;
    }

    .store-corner-toggle:hover {
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 0 10px rgba(56,189,248,0.5);
    }

    /* 通用隱藏類 */
    .hidden {
      display: none !important;
    }

    /* 浮動地圖視窗樣式 */
    .map-overlay {
      position: fixed;
      left: 12px;
      right: 12px;
      z-index: 3000;
      pointer-events: auto;
    }
    .map-overlay-inner {
      position: relative;
      border-radius: 14px;
      overflow: hidden;
      background: rgba(15,23,42,0.95);
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      height: 200px;
      transition: height 0.3s ease;
    }
    .map-overlay.expanded .map-overlay-inner {
      height: 300px;
    }
    .map-overlay-controls {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 6px;
      z-index: 10;
    }
    #overlay-map {
      width: 100%;
      height: 100%;
    }

    /* 中欄：地圖 */

    .panel--map .panel-body {
      padding: 8px;
      display: flex;
      flex-direction: column;
    }

    #map {
      width: 100%;
      height: 100%;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 0 0 1px #020617;
    }

    .map-wrapper {
      position: relative;
      border-radius: 14px;
      overflow: hidden;
      min-height: 280px;
    }

    /* 控制浮動地圖視窗內的功能按鈕。位置固定於地圖右上角，橫向排放 */
    .overlay-map-controls {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 6px;
      z-index: 1001;
    }

    .map-control-button {
      padding: 6px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(15,23,42,0.9);
      border: 1px solid #1f2937;
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      backdrop-filter: blur(12px);
      transition: background var(--transition-fast), border-color var(--transition-fast), color var(--transition-fast), box-shadow var(--transition-fast);
      white-space: nowrap;
    }

    .map-control-button:hover {
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 0 16px rgba(56, 189, 248, 0.45);
    }

    .map-control-button span.dot-danger,
    .map-control-button span.dot-warning,
    .map-control-button span.dot-all {
      width: 7px;
      height: 7px;
      border-radius: 999px;
    }
    .map-control-button span.dot-danger {
      background: var(--danger);
      box-shadow: 0 0 10px rgba(248,113,113,0.7);
    }
    .map-control-button span.dot-warning {
      background: var(--warning);
      box-shadow: 0 0 10px rgba(250, 204, 21,0.7);
    }
    .map-control-button span.dot-all {
      background: var(--accent);
      box-shadow: 0 0 10px rgba(56,189,248,0.7);
    }

    /* Collapse button hidden by default (display none on desktop; will be shown on mobile) */
    .map-collapse-button {
      display: none;
    }

    /* Custom war markers for war-room mode */
    .war-marker {
      display: flex;
      align-items: center;
      gap: 2px;
      background: rgba(15, 23, 42, 0.85);
      padding: 2px 4px;
      border-radius: 4px;
      font-size: 10px;
      color: var(--text-main);
      white-space: nowrap;
      pointer-events: none;
    }
    .war-marker-circle {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      box-shadow: 0 0 6px rgba(0,0,0,0.6);
    }
    .war-marker-name {
      margin-right: 2px;
    }
    .war-arrow {
      width: 0;
      height: 0;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
    }
    /* Arrow size and direction classes */
    /* Adjust war-room arrows: red up indicates growth, green down indicates decline */
    .war-arrow.up-small {
      border-bottom: 6px solid var(--danger);
    }

    /* Leaflet tooltip for war map markers should not intercept pointer events */
    .leaflet-tooltip.war-marker-label {
      pointer-events: none;
    }
    .war-arrow.up-medium {
      border-left-width: 6px;
      border-right-width: 6px;
      border-bottom: 9px solid var(--danger);
    }
    .war-arrow.up-large {
      border-left-width: 7px;
      border-right-width: 7px;
      border-bottom: 12px solid var(--danger);
    }
    .war-arrow.down-small {
      border-top: 6px solid var(--success);
    }
    .war-arrow.down-medium {
      border-left-width: 6px;
      border-right-width: 6px;
      border-top: 9px solid var(--success);
    }
    .war-arrow.down-large {
      border-left-width: 7px;
      border-right-width: 7px;
      border-top: 12px solid var(--success);
    }

    /* Text display for war-room growth value next to arrow */
    .war-marker .war-growth-value {
      font-size: 10px;
      margin-left: 2px;
      white-space: nowrap;
    }
    /* Active state for war marker */
    .war-marker--active .war-marker-circle {
      width: 12px;
      height: 12px;
      border: 2px solid var(--warning);
    }
    .war-marker--active .war-arrow {
      filter: drop-shadow(0 0 4px var(--warning));
    }

    /* Mobile layout adjustments: sticky map and size toggle */
    @media (max-width: 1024px) {
      /* Ensure the map panel appears above the list */
      #panel-map {
        order: -1;
        /* Keep the entire panel sticky to the top when scrolling. This makes the map behave like a top header. */
        position: sticky;
        top: 0;
        z-index: 5;
      }
      /* Default map wrapper height on mobile (small preview) */
      .panel--map .map-wrapper {
        /* Reduce the default (collapsed) map height to half of its previous size
           for a more compact view while browsing the store list */
        height: 100px;
        transition: height var(--transition-fast);
      }
      /* When map is expanded show a larger map */
      body.map-expanded #panel-map .map-wrapper {
        height: 60vh;
      }
      /* Hide the legacy collapse button; map size is toggled via header button */
      .map-collapse-button {
        display: none !important;
      }

      /* When the map is not expanded, hide its header so the map preview sits at the top */
      body:not(.map-expanded) #panel-map .panel-header {
        display: none;
      }
    }

    /* Map size toggle button – visible only on mobile */
    #map-size-toggle {
      display: none;
      margin-left: 8px;
      font-size: 14px;
      padding: 6px 12px;
    }

    @media (max-width: 1024px) {
      #map-size-toggle {
        display: inline-flex;
      }
    }

    @media (min-width: 1025px) {
      /* Ensure children align at the start so sticky positioning works correctly */
      main.layout {
        align-items: flex-start;
      }
      #map-size-toggle {
        display: none;
      }

      /* On desktop, keep the map and detail panels sticky beneath the header and
         allow the list to scroll independently. Assume the header height is ~72px. */
      #panel-list {
        height: calc(100vh - 72px);
        overflow-y: auto;
      }
      #panel-map,
      #panel-detail {
        position: sticky;
        top: 72px;
        height: calc(100vh - 72px);
      }
      #panel-map .map-wrapper {
        height: 100%;
      }
      #panel-detail .panel-body {
        height: 100%;
        overflow-y: auto;
      }
    }

    .map-here-button {
      position: absolute;
      bottom: 12px;
      left: 12px;
      /* Increase z-index to ensure the HERE control appears above map and other overlays */
      z-index: 300;
      display: block;
    }

    .here-button {
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(8,47,73,0.92);
      border: 1px solid rgba(56,189,248,0.9);
      color: var(--accent);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      backdrop-filter: blur(14px);
      box-shadow: 0 0 14px rgba(56,189,248,0.55);
      transition: background var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
      white-space: nowrap;
    }

    .here-button:hover {
      background: rgba(8,47,73,1);
      transform: translateY(-1px);
      box-shadow: 0 0 18px rgba(56,189,248,0.8);
    }

    .here-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      border: 2px solid rgba(56,189,248,0.9);
      box-shadow: 0 0 14px rgba(56,189,248,0.9);
    }

    .user-location-marker {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      background: rgba(56,189,248,0.4);
      border: 2px solid rgba(56,189,248,0.95);
      box-shadow: 0 0 18px rgba(56,189,248,0.85);
    }

    /* 右欄：詳細（桌機用） */

    .detail-header {
      padding: 10px 12px 8px;
      border-bottom: 1px solid #111827;
    }

    .detail-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }

    .detail-name {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 15px; /* 詳細頁門市名稱再大一點 */
      font-weight: 600;
      flex-wrap: wrap;
    }

    .detail-status-chip {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      border: 1px solid #1f2937;
      background: rgba(15,23,42,0.95);
      color: var(--text-muted);
      white-space: nowrap;
    }

    .detail-id {
      font-size: 11px;
      color: #6b7280;
    }

    .detail-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .detail-content {
      padding: 0 10px 8px;
    }

    .detail-mini-kpis {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 8px 0 4px;
    }

    .mini-kpi-pill {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(15,23,42,0.95);
      border: 1px solid #111827;
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .mini-kpi-pill strong {
      color: var(--text-main);
      font-weight: 500;
    }

    .detail-pattern-row {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .detail-pattern-label {
      color: #6b7280;
    }

    .detail-pattern-value {
      color: var(--accent);
      font-weight: 500;
    }

    /* 詳細：地圖區塊 */

    .detail-map-section {
      margin-top: 6px;
      margin-bottom: 8px;
    }

    .detail-map-toggle {
      font-size: 11px;
      border-radius: 999px;
      padding: 5px 9px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #9ca3af;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: background var(--transition-fast), border-color var(--transition-fast), color var(--transition-fast), box-shadow var(--transition-fast);
    }

    .detail-map-toggle:hover {
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 0 12px rgba(56,189,248,0.5);
    }

    .detail-map-toggle-active {
      background: rgba(8,47,73,0.92);
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 0 16px rgba(56,189,248,0.8);
    }

    .detail-inline-map {
      margin-top: 6px;
      border-radius: 12px;
      border: 1px solid #111827;
      overflow: hidden;
      height: 150px;
      background: #020617;
    }

    #detail-map {
      width: 100%;
      height: 100%;
    }

    .chart-section {
      background: #020617;
      border-radius: 12px;
      border: 1px solid #111827;
      padding: 6px 8px 4px;
      margin-bottom: 8px;
      height: 150px;
      display: flex;
      flex-direction: column;
    }

    /* 淺色模式下，圖表區塊採用米白背景，邊框與文字顏色同步調整 */
    body.light-theme .chart-section {
      background: #fff7eb;
      border-color: #e0d9c1;
      color: #1f2937;
    }
    body.light-theme .chart-title {
      color: #6b7280;
    }

    .chart-title {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 4px;
      flex: 0 0 auto;
    }

    .chart-section canvas {
      flex: 1 1 auto;
    }

    /*
     * Unified SVG icon styling.  These icons adopt the current text colour and
     * scale automatically with the surrounding text.  A small right margin
     * ensures consistent spacing between the icon and its label.  We set
     * stroke properties to mirror a typical line-icon aesthetic similar to
     * lucide or feather icons.  These rules apply to all inline SVGs used
     * for notification, navigation and check actions.
     */
    .icon-svg {
      /* Increase the base size of inline SVG icons so navigation and notify icons are more legible.
         We use 1.6em here (up from 1.4em) to make the icons stand out clearly on high‑resolution
         displays while still scaling with surrounding text. */
      width: 1.6em;
      height: 1.6em;
      margin-right: 4px;
      stroke-width: 2;
      stroke: currentColor;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
      vertical-align: -0.15em;
    }

    /*
     * Make icons inside the store list action bar larger to match the size
     * used in the detail view.  Without this adjustment the navigation and
     * notification icons appear too small compared to their counterparts in
     * the detail panel.  Using 1.4em ensures they scale relative to the
     * surrounding text but remain visually prominent.
     */
    .action-icons .icon-svg {
      /* Resize icons in the store list action bar to match the moderate size used in
         the detail view.  A size of 1.4em keeps the glyphs clear without
         dominating the card. */
      width: 1.4em;
      height: 1.4em;
    }

    /* 在淺色模式下，將 Chart.js canvas 背景設為米白色，確保圖表區塊與容器一致。
       若圖表本身沒有完全覆蓋整個 canvas，仍能呈現柔和底色。 */
    body.light-theme .chart-section canvas {
      background: #fff7eb;
    }

    .detail-section {
      margin-top: 4px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .detail-section-row {
      display: flex;
      justify-content: space-between;
      gap: 4px;
      margin-bottom: 4px;
    }

    .detail-section-row span:first-child {
      color: #6b7280;
    }

    .detail-section-row span:last-child {
      text-align: right;
      color: var(--text-main);
    }

    .detail-actions {
      margin-top: auto;
      padding: 8px 10px 10px;
      border-top: 1px solid #111827;
      display: flex;
      gap: 6px;
    }

    .btn {
      flex: 1;
      font-size: 13px;
      border-radius: 999px;
      padding: 6px 10px;
      border: 1px solid transparent;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: background var(--transition-fast), border-color var(--transition-fast), color var(--transition-fast), box-shadow var(--transition-fast), transform var(--transition-fast);
    }

    .btn-primary {
      background: linear-gradient(135deg, #0ea5e9, #22c55e);
      border-color: #0ea5e9;
      color: #0b1020;
      font-weight: 600;
      box-shadow: 0 12px 30px rgba(14, 165, 233, 0.45);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(14, 165, 233, 0.6);
    }

    .btn-secondary {
      background: #020617;
      border-color: #111827;
      color: var(--text-muted);
    }

    .btn-secondary:hover {
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 0 18px rgba(56,189,248,0.45);
    }

    .btn-ghost {
      flex: 0;
      padding-inline: 10px;
      background: transparent;
      border-color: transparent;
      color: #6b7280;
      font-size: 11px;
    }

    .btn-ghost:hover {
      color: var(--accent);
    }

    .btn-ghost-active {
      background: rgba(22,163,74,0.18);
      border-color: #16a34a;
      color: #4ade80;
    }

    /* Modal：通知代送商 */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.72);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(12px);
    }

    .modal-backdrop--show {
      display: flex;
    }

    .modal {
      background: #020617;
      border-radius: 18px;
      border: 1px solid #111827;
      box-shadow: 0 20px 60px rgba(0,0,0,0.8);
      padding: 14px 16px 12px;
      max-width: 360px;
      width: 100%;
      font-size: 13px;
    }

    .modal-title {
      font-weight: 600;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal-body {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .modal-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    /* 手機：底部抽屜 */

    .detail-bottom-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.6);
      display: none;
      z-index: 1700;
      backdrop-filter: blur(8px);
    }

    .detail-bottom-backdrop--show {
      display: block;
    }

    .detail-bottom-sheet {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      max-height: 85vh;
      background: #020617;
      border-radius: 16px 16px 0 0;
      border-top: 1px solid #111827;
      box-shadow: 0 -20px 40px rgba(0,0,0,0.85);
      transform: translateY(100%);
      transition: transform 0.25s ease-out;
      display: flex;
      flex-direction: column;
      z-index: 1800;
    }

    .detail-bottom-sheet--open {
      transform: translateY(0);
    }

    .detail-bottom-handle {
      width: 38px;
      height: 4px;
      border-radius: 999px;
      background: #4b5563;
      opacity: 0.7;
      margin: 6px auto 4px;
    }

    /* 淺色模式下調整底部抽屜的配色，使其與其他卡片一致 */
    body.light-theme .detail-bottom-sheet {
      background: #fff7eb;
      border-top-color: #e0d9c1;
      color: #1f2937;
      box-shadow: 0 -12px 36px rgba(0,0,0,0.2);
    }
    body.light-theme .detail-bottom-handle {
      background: #e0d9c1;
      opacity: 0.8;
    }
    body.light-theme .detail-bottom-inner {
      color: #1f2937;
    }
    body.light-theme .detail-bottom-backdrop {
      background: rgba(0,0,0,0.4);
    }

    .detail-bottom-inner {
      flex: 1;
      overflow-y: auto;
    }

    .detail-actions--sheet {
      position: sticky;
      bottom: 0;
      background: linear-gradient(to top, #020617 70%, rgba(2,6,23,0.8) 100%);
    }

    @media (min-width: 1025px) {
      .detail-bottom-sheet,
      .detail-bottom-backdrop {
        display: none !important;
      }
    }

    /* 返回頂端按鈕 */

    .scroll-top-btn {
  position: fixed;
  right: 12px;
  bottom: 16px;
  width: 56px;
  height: 56px;
  border-radius: 999px;

  border: none;
  outline: none;

  background: rgba(15,23,42,0.92);
  color: #e5e7eb;
  font-size: 24px;
  display: none;
  align-items: center;
  justify-content: center;
  cursor: pointer;

  z-index: 1500;
  box-shadow: 0 10px 20px rgba(0,0,0,0.7);

  transition: transform 0.15s ease-out, box-shadow 0.15s ease-out;

  /* 手機點擊高亮關掉 */
  -webkit-tap-highlight-color: transparent;
}

/* Ensure grid items inside store-card do not cause horizontal overflow on narrow screens */
.store-card > * {
    min-width: 0;
}

/* 關掉所有 focus 藍框（含 :focus-visible） */
.scroll-top-btn:focus,
.scroll-top-btn:focus-visible {
  outline: none !important;
  box-shadow: 0 0 0 0 transparent !important;
}

/* Firefox 的內建 focus 邊框 */
.scroll-top-btn::-moz-focus-inner {
  border: 0;
}

/* 按下時微縮一下，保留你原本的質感陰影 */
.scroll-top-btn:active {
  transform: scale(0.92);
  box-shadow: 0 0 0 2px rgba(148,163,184,0.35);
}


    .scroll-top-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 0 14px rgba(56,189,248,0.6);
    }

    /* 呼吸效果：未使用時讓置頂按鈕閃爍提示 */
    @keyframes scrollTopPulse {
      0% { transform: scale(1); box-shadow: 0 0 8px rgba(56,189,248,0.4); }
      50% { transform: scale(1.15); box-shadow: 0 0 16px rgba(56,189,248,0.8); }
      100% { transform: scale(1); box-shadow: 0 0 8px rgba(56,189,248,0.4); }
    }
    .scroll-top-btn.unused {
      animation: scrollTopPulse 1.8s ease-in-out infinite;
    }

    /* 全螢幕戰情地圖覆蓋 */
    #war-map-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 4000;
      background: rgba(15,23,42,1);
      display: none;
      /* 讓戰情地圖可以正常點擊，父元素需允許 pointer 事件 */
      pointer-events: auto;
    }
    #war-map {
      width: 100%;
      height: 100%;
      /* 確保地圖可以接收點擊事件 */
      pointer-events: auto;
      /* 使用漸層作為基底，營造現代感並避免缺少圖磚時出現灰塊 */
      background: linear-gradient(135deg, #111827 0%, #1f2937 100%);
      position: relative;
      overflow: hidden;
    }

    /* 隱藏 Leaflet 的預設縮放和版權控制，避免在自訂地圖上出現無法使用的按鈕 */
    #war-map .leaflet-control-zoom,
    #war-map .leaflet-control-attribution {
      display: none !important;
    }

    body.light-theme #war-map {
      background: linear-gradient(135deg, #f9f7f1 0%, #f5e9d7 100%);
    }

    /* 確保地圖及其子元素均能接受點擊事件，避免被外層遮罩阻擋 */
    #war-map * {
      pointer-events: auto;
    }
    /* 返回按鈕及 HERE 按鈕 */
    #war-back-button {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: rgba(31,41,55,0.92);
      color: #9ca3af;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.7);
      z-index: 5000;
      pointer-events: auto;
    }
    #war-back-button:hover {
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 0 14px rgba(56,189,248,0.6);
    }
    .war-here-button {
      /* 調整位置：置於右下返回鈕上方 */
      position: absolute;
      bottom: 72px;
      right: 16px;
      z-index: 5000;
      pointer-events: auto;
    }

    /* 小型門市卡片彈出窗，顯示在戰情地圖上被點選門市時 */
    .war-popup {
      position: absolute;
      left: 16px;
      right: 16px;
      bottom: 80px;
      background: rgba(15,23,42,0.95);
      border: 1px solid #1f2937;
      border-radius: 14px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.7);
      padding: 10px 14px;
      z-index: 5000;
      display: none;
      pointer-events: auto;
    }
    .war-popup.hidden {
      display: none;
    }

    /* 標記層：以絕對定位繪製可點擊的圓點，用於戰情/地圖模式 */
    #war-marker-layer {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      /* 允許覆蓋層接收點擊事件，圓點將自行處理；沒有 click handler 的位置不會產生效果 */
      pointer-events: auto;
      z-index: 4500;
    }
    .war-marker-dot {
      position: absolute;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      cursor: pointer;
      border: 2px solid rgba(0,0,0,0.2);
      pointer-events: auto; /* 圓點自身可點擊 */
    }

    /* 使用者位置標記 */
    .war-user-dot {
      position: absolute;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      background-color: #38bdf8;
      border: 2px solid rgba(0,0,0,0.2);
      pointer-events: none;
      z-index: 4600;
    }
    .war-popup .popup-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .war-popup .popup-subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* 成長率顏色：綠色代表上漲，紅色代表下降 */
    .popup-growth-positive { color: var(--success); }
    .popup-growth-negative { color: var(--danger); }

    /* 地區下拉選單樣式 */
    .region-dropdown {
      position: fixed;
      top: 66px;
      left: 16px;
      right: 16px;
      background: rgba(15,23,42,0.97);
      border: 1px solid #1f2937;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.7);
      padding: 8px 0;
      z-index: 4500;
      display: none;
      max-height: 50vh;
      overflow-y: auto;
    }
    .region-dropdown .region-item {
      padding: 6px 14px;
      font-size: 12px;
      color: var(--text-main);
      cursor: pointer;
      white-space: nowrap;
    }
    .region-dropdown .region-item:hover {
      background: rgba(56,189,248,0.12);
      color: var(--accent);
    }
    .region-dropdown .region-item.active {
      background: rgba(56,189,248,0.24);
      color: var(--accent);
    }
    .war-here-button .here-button {
      /* 調整尺寸與字型，讓定位按鈕更像 Google 地圖的 Here 圖示 */
      width: 44px;
      height: 44px;
      border-radius: 999px;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      background: rgba(31,41,55,0.92);
      border: 1px solid #1f2937;
      color: var(--accent);
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.6);
    }
    /* 不再使用內部 dot */
    .war-here-button .here-dot {
      display: none;
    }

    /* War mode marker label styling */
    .leaflet-tooltip.war-marker-label {
      background: rgba(15,23,42,0.95);
      color: var(--text-main);
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid #1f2937;
      font-size: 10px;
      pointer-events: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }

    /* 地區消長圖表彈窗 */
    #region-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 5000;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .region-modal-inner {
      background: rgba(15,23,42,0.97);
      border: 1px solid #1f2937;
      border-radius: 12px;
      width: 90%;
      max-width: 650px;
      padding: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.6);
      /* 控制彈窗內容最高高度，避免過高導致需要滾動 */
      /* Allow the region modal to fit within the viewport.  When內容過多時
         將出現內部滾動條以避免覆蓋整個畫面。 */
      /* 限制彈窗最大高度為 80vh，且避免內部出現捲動，
         由 openRegionChart 計算的 canvas 高度將自動調整以適應視窗。 */
      max-height: 80vh;
      overflow-y: hidden;
    }
    .region-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .region-modal-title {
      font-size: 16px;
      color: var(--text-main);
    }
    .region-modal-close {
      background: transparent;
      border: none;
      color: #9ca3af;
      font-size: 20px;
      cursor: pointer;
    }
    #region-chart-canvas {
      width: 100%;
      /* 進一步縮減圖表區固定高度，避免需要上下滑動查看完整內容 */
      height: 210px;
    }

    /* 新增篩選下拉選單樣式 */
    .filter-select {
      background: #020617;
      border-radius: 999px;
      border: 1px solid #111827;
      padding: 4px 8px;
      font-size: 11px;
      color: var(--text-muted);
      outline: none;
      margin-left: 6px;
    }

    /* 巡店模式路線下拉選單選中狀態反白提示 */
    #tour-route-select.highlight {
      background: rgba(56,189,248,0.15);
      border-color: var(--accent);
      color: var(--accent);
    }

    /* 讓標題列能包含絕對定位的按鈕 */
    header {
      position: relative;
    }
    /* 將戰情模式按鈕定位於標題列右下角 */
    #mode-switch {
      position: absolute;
      right: 12px;
      bottom: 6px;
    }

    /* 全部門市列表 overlay */

    .table-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.9);
      display: none;
      /* 提高層級，確保列表在其他覆蓋層之上 */
      z-index: 6000;
      backdrop-filter: blur(10px);
      align-items: center;
      justify-content: center;
    }

    .table-backdrop--show {
      display: flex;
    }

    .table-modal {
      width: min(960px, 95vw);
      max-height: 80vh;
      background: #020617;
      border-radius: 18px;
      border: 1px solid #111827;
      box-shadow: 0 24px 60px rgba(0,0,0,0.85);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Light mode overrides for full table overlay */
    body.light-theme .table-backdrop {
      /* 淡色遮罩讓背後內容微透 */
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(4px);
    }
    body.light-theme .table-modal {
      background: #fff7eb;
      border-color: #e0d9c1;
      color: #1f2937;
      box-shadow: 0 12px 36px rgba(0,0,0,0.25);
    }
    body.light-theme .table-modal-header {
      border-bottom-color: #e0d9c1;
    }
    body.light-theme .table-region-select {
      background: #fff;
      border-color: #e0d9c1;
      color: #1f2937;
    }
    body.light-theme .table-modal-close {
      background: #fff7eb;
      border-color: #e0d9c1;
      color: #1f2937;
    }
    body.light-theme .table-modal-close:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    body.light-theme .store-table th,
    body.light-theme .store-table td {
      background: #fff7eb;
      color: #1f2937;
    }

    .table-modal-header {
      padding: 10px 12px;
      border-bottom: 1px solid #111827;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      /* 增加高度以避免在瀏覽器地址列覆蓋時被裁切 */
      min-height: 72px;
    }

    .table-modal-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-main);
    }

    .table-modal-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .table-header-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    .table-region-select {
      background: #020617;
      border-radius: 999px;
      border: 1px solid #1f2937;
      color: #9ca3af;
      font-size: 11px;
      padding: 4px 8px;
      outline: none;
    }

    .table-modal-close {
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #9ca3af;
      width: 28px;
      height: 28px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
    }

    .table-modal-close:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .table-modal-body {
      padding: 8px 12px 10px;
      overflow: auto;
    }

    .store-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    .store-table thead th {
      position: sticky;
      top: 0;
      background: #020617;
      border-bottom: 1px solid #111827;
      padding: 6px 6px;
      text-align: left;
      color: #9ca3af;
      z-index: 1;
    }

    .store-table tbody tr {
      cursor: pointer;
      transition: background 0.15s ease-out;
    }

    .store-table tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.8);
    }

    .store-table tbody tr:hover {
      background: rgba(56,189,248,0.08);
    }

    /* Ensure that in light mode, colour-coded weekly sales values and growth rates
       retain their inline colours set in JavaScript. Without this, light theme
       overrides may force dark text and hide the red/green colouring. */
    body.light-theme .store-card .weekly-sales-value,
    body.light-theme .store-card .weekly-sales-trend {
      color: inherit !important;
    }

    .store-table tbody td {
      padding: 5px 6px;
      border-bottom: 1px solid #020617;
      color: var(--text-main);
      white-space: nowrap;
    }

    /* ==============================================================
       Light theme overrides for detailed view and card components
       In light theme, ensure detail panels and bottom sheets adopt
       beige backgrounds with dark text for better readability. These
       rules are placed near the end of the stylesheet to override
       earlier declarations. */
    body.light-theme #detail-panel,
    body.light-theme .detail-top,
    body.light-theme .detail-info,
    body.light-theme .detail-icon-row,
    body.light-theme .detail-bottom-sheet,
    body.light-theme .detail-bottom-inner,
    body.light-theme .detail-bottom-handle {
      background: #fff7eb;
      color: #1f2937;
    }
    body.light-theme .detail-bottom-backdrop {
      background: rgba(252, 244, 230, 0.7);
    }
    body.light-theme .detail-bottom-sheet .status-dot {
      /* keep status dot colours; ensure text colour inherits from parents */
      color: inherit;
    }

    .store-table .col-name {
      max-width: 170px;
      /*
       * Increase store name font size to 14px (about 10% larger than the typical 12px)
       * for improved legibility in the full table view.  The max-width prevents names from
       * stretching the table and the cell will still truncate with ellipsis if needed.
       */
      font-size: 14px;
    }

    .store-table .col-sales,
    .store-table .col-trend {
      text-align: right;
      font-variant-numeric: tabular-nums;
      font-feature-settings: "tnum" 1;
    }

    .store-table .col-risk {
      /* 庫存風險欄縮窄以避免表格溢出 */
      min-width: 100px;
    }
    .store-table .col-ztr {
      /* ZTR 狀況欄縮窄以避免橫向滾動 */
      min-width: 80px;
    }

    /* 修正週成長率顏色：正值為綠色，負值為紅色，並提高優先度覆蓋主題色 */
    .store-table .trend-positive {
      /* 上漲顯示紅色 */
      color: #ef4444 !important;
    }

    .store-table .trend-negative {
      /* 下跌顯示綠色 */
      color: #10b981 !important;
    }

    /* 在淺色模式下也保持週成長率的紅綠顏色，而不是被全局文字顏色覆蓋 */
    body.light-theme .store-table .trend-positive {
      color: #ef4444 !important;
    }
    body.light-theme .store-table .trend-negative {
      color: #10b981 !important;
    }

    /* 手機版優化 */

    @media (max-width: 1024px) {
      header {
        padding: 6px 10px;
        flex-wrap: wrap;
        row-gap: 4px;
      }

      .brand-logo {
        width: 22px;
        height: 22px;
      }

      .brand-text-main {
        font-size: 13px;
      }

      .brand-sub {
        display: none;
      }

      .header-summary {
        order: 3;
        width: 100%;
        justify-content: flex-start;
        overflow-x: auto;
        padding-top: 2px;
      }

      .summary-pill {
        padding: 3px 6px;
        font-size: 10px;
      }

      .header-filters {
        order: 2;
        width: 100%;
        justify-content: flex-start;
        overflow-x: auto;
      }

      .chip-button {
        padding: 4px 8px;
        font-size: 10px;
      }

      .app-shell {
        min-height: 100vh;
      }

      main.layout {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 8px;
        gap: 8px;
      }

      #panel-list {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      #panel-list .panel-body {
        flex: 1;
        overflow-y: auto;
      }

      #panel-map {
        flex: 0 0 auto;
      }

      .panel--map .panel-body {
        flex: 0 0 auto;
      }
      .panel--map .map-wrapper {
        height: 260px;
      }

      .panel--map .map-wrapper #map {
        height: 100%;
      }

      #panel-detail {
        display: none;
      }

      .chart-section {
        height: 140px;
      }

      .detail-inline-map {
        height: 150px;
      }

      .table-modal {
        width: 100vw;
        height: 100vh;
        max-height: 100vh;
        border-radius: 0;
        padding-top: 18px;
        box-sizing: border-box;
      }

      .table-modal-body {
        padding-bottom: 18px;
      }

    /* 移除舊的淺色主題文字顏色覆寫，統一由上方規則控制 */
    /* body.light-theme .store-card,
    body.light-theme .store-card * {
      color: #ffffff;
    } */

      /* --- Added styles for upgraded OPS console --- */
      /* War-room mode layout (desktop) */
      body.mode-war main.layout {
        flex-direction: row;
      }
      /* In war-room mode the map occupies ~80% and the list occupies ~20% */
      body.mode-war #panel-map {
        flex: none;
        width: 80%;
      }
      body.mode-war #panel-detail {
        display: none;
      }
      body.mode-war #panel-list {
        position: static;
        flex: none;
        width: 20%;
        max-width: none;
        background: var(--bg-panel);
        border-left: 1px solid var(--border-subtle);
        overflow-y: auto;
        transform: translateX(100%);
        transition: transform 0.3s ease-out;
      }
      /* When drawer-open is active, slide the list into view */
      body.mode-war.drawer-open #panel-list {
        transform: translateX(0);
      }
      body.mode-war #panel-list .panel-header {
        background: var(--bg-panel-soft);
        position: sticky;
        top: 0;
        z-index: 1;
      }
      body.mode-war .panel--map .map-wrapper {
        height: calc(100vh - 120px);
      }

      /* Sparkline for weekly sales trends */
      .sparkline {
        display: flex;
        align-items: flex-end;
        height: 40px;
        gap: 2px;
        margin-top: 4px;
      }
      .sparkline-bar {
        display: block;
        width: 5px;
        background: var(--accent);
        border-radius: 2px 2px 0 0;
      }

      /* Priority score bar */
      .priority-container {
        margin-top: 4px;
      }
      .priority-bar {
        background: #1f2937;
        border-radius: 4px;
        height: 4px;
        overflow: hidden;
        margin-bottom: 2px;
      }
      .priority-progress {
        background: var(--accent);
        height: 100%;
      }
      .priority-label {
        font-size: 10px;
        color: var(--text-muted);
      }

    /* Keep the map and detail panels sticky on desktop.
       They stay under the header while the list scrolls independently. */
    @media (min-width: 1025px) {
      /* Fix the layout height beneath the header and prevent page scrolling */
      main.layout {
        height: calc(100vh - 72px);
        overflow: hidden;
        display: flex;
        align-items: stretch;
      }
      /* Map and detail panels stick to the top and fill available height */
      #panel-map,
      #panel-detail {
        position: sticky;
        top: 0;
        flex: none;
        height: 100%;
        align-self: flex-start;
      }
      #panel-map .map-wrapper {
        height: 100%;
      }
      #panel-detail {
        overflow-y: auto;
      }
      /* List panel takes remaining width and scrolls internally */
      #panel-list {
        height: 100%;
        overflow-y: auto;
        flex: 1;
      }
      #panel-list .panel-body {
        height: 100%;
        overflow-y: auto;
      }
    }

      /* Last sync indicator */
      .last-sync {
        font-size: 11px;
        color: var(--text-muted);
        margin-left: auto;
        padding-left: 8px;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .last-sync[data-stale="true"] {
        color: var(--warning);
        animation: blink 1s infinite;
      }
      @keyframes blink {
        0%, 50% { opacity: 1; }
        50.1%, 100% { opacity: 0.4; }
      }

      /* Toast notifications */
      #toast-container {
        position: fixed;
        top: 12px;
        right: 12px;
        z-index: 2000;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .toast {
        background: rgba(15, 23, 42, 0.92);
        border: 1px solid #1f2937;
        border-radius: 8px;
        padding: 6px 10px;
        color: var(--text-main);
        font-size: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
        opacity: 0;
        transform: translateY(-10px);
        transition: opacity 0.3s ease, transform 0.3s ease;
      }
      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
  <!-- Map tile fix: ensure base map tiles are visible in map mode -->
  <style>
    /* Override any filters or opacity settings on the Leaflet tile pane.
       Without this fix the base map may appear hidden or blurred, leaving only
       colored markers on a dark background. */
    #map .leaflet-tile-pane {
      filter: none !important;
      opacity: 1 !important;
    }

    /* ===== Enhanced UI/UX Effects =====
       These rules add subtle entrance animations, hover lifts and button ripples to
       create a more delightful interaction without altering the underlying layout. */

    /* Animate store cards sliding up and fading in when rendered.  Each card uses
       the --i custom property set in renderStoreList() to stagger the animation. */
    .store-card {
      opacity: 0;
      transform: translateY(8px);
      animation: fadeInUp 0.5s ease-out forwards;
      animation-delay: calc(var(--i) * 0.04s);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .store-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
    }
    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Lift chip buttons on hover and add a shadow to indicate interactivity */
    .chip-button {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .chip-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
    }

    /* Ripple effect container styles for buttons */
    .btn-ripple {
      position: relative;
      overflow: hidden;
    }
    .ripple {
      position: absolute;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.4);
      transform: scale(0);
      animation: ripple-effect 0.6s linear;
      pointer-events: none;
    }
    @keyframes ripple-effect {
      to {
        transform: scale(4);
        opacity: 0;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="brand">
        <!-- 移除裝飾用的燈圖示以節省空間 -->
        <div>
          <div class="brand-text-main">18 Days Draft · OPS CONSOLE</div>
          <div class="brand-sub">銷售熱點 · 缺貨風險 · ZTR 監控</div>
        </div>
      </div>
      <div class="header-summary">
        <div class="summary-pill">
          🔴 <span>紅燈門市 <strong id="summary-critical">–</strong></span>
        </div>
        <div class="summary-pill">
          🟡 <span>黃燈門市 <strong id="summary-warning">–</strong></span>
        </div>
        <div class="summary-pill">
          ⭐ <span>Top10 總銷量 <strong id="summary-top10">–</strong> 箱</span>
        </div>
        <div class="summary-pill">
          ✅ <span>已處理 <strong id="summary-done">–</strong> / 剩餘 <strong id="summary-remaining">–</strong></span>
        </div>
      </div>
      <div id="last-sync" class="last-sync"></div>
      <!-- 地圖模式按鈕：原戰情模式按鈕改為開啟全畫面地圖 -->
      <button id="mode-switch" class="chip-button">🗺️ 地圖模式</button>
      <!-- 隱藏舊的全螢幕地圖按鈕，功能由 mode-switch 按鈕取代 -->
      <button id="full-map-button" class="chip-button" style="display:none;">🗺️ 地圖模式</button>
      <button id="tour-switch" class="chip-button">巡店模式</button>
      <!-- 縣市列表按鈕：從地圖面板移至標題列 -->
      <!-- 地區消長按鈕：顯示各縣市銷售消長圖表 -->
      <button id="drawer-toggle-button" class="chip-button" title="地區消長">地區消長</button>
      <!-- 取消已處理標記按鈕 -->
      <button id="cancel-mark-button" class="chip-button" title="取消全部標記已處理">取消標記</button>
      <!-- 主題切換按鈕：點擊可在深色和淺色之間切換 -->
      <button id="theme-toggle" class="chip-button" title="切換主題" onclick="toggleTheme()">⚙️ 設定</button>
      <!-- 原「放大地圖」按鈕移除，改由點擊浮動地圖視窗放大 -->
      <select id="tour-route-select" class="select-input" style="display:none;margin-left:8px;"></select>
      <div class="header-filters">
        <button class="chip-button chip-button--active" id="tab-hotspots">銷售熱點</button>
        <button class="chip-button" id="tab-alerts">銷售異常</button>
        <button class="chip-button" id="tab-distribution">門市分佈</button>
        <button class="chip-button" id="tab-nearby">鄰近門市</button>
      </div>
    </header>

    <!-- 地區下拉選單，預設隱藏，用於門市分佈篩選 -->
    <div id="region-dropdown" class="region-dropdown"></div>

    <main class="layout">
      <!-- 左：門市列表 -->
      <section class="panel" id="panel-list">
        <div class="panel-header">
          <div class="panel-title">
            <span>門市列表</span>
            <span class="badge" id="store-count-badge">0 門市</span>
          </div>
          <div class="panel-header-controls">
            <input
              type="text"
              id="search-input"
              class="search-input"
              placeholder="搜尋門市名稱或店號"
            />
            <select id="sort-select" class="select-input">
              <option value="severity">按異常程度</option>
              <!-- Set weeklySales as the default selected sort so that the list is sorted by sales first. -->
              <option value="weeklySales" selected>按周銷量</option>
              <option value="distance">按距離</option>
              <option value="storeId">按店號</option>
      <option value="priority">按優先度</option>
            </select>
          </div>
        </div>
        <div class="panel-body">
          <div class="filters-row">
            <button class="filter-chip filter-chip--active" data-filter="all">全部</button>
            <button class="filter-chip" data-filter="critical">
              <span style="color:#f97373;">●</span> 紅燈
            </button>
            <button class="filter-chip" data-filter="warning">
              <span style="color:#facc15;">●</span> 黃燈
            </button>
            <button class="filter-chip" data-filter="green">
              <span style="color:#34d399;">●</span> 綠燈
            </button>

            <!-- New filter chips for task status -->
            <button class="filter-chip" data-filter="undone">
              📝 未處理
            </button>
            <button class="filter-chip" data-filter="done">
              ✅ 已處理
            </button>
            <button class="filter-chip" id="btn-full-table" style="margin-left:auto;">
              📋 全部門市
            </button>
          </div>
          <div class="store-list" id="store-list"></div>
        </div>
      </section>

      <!-- 中：地圖 -->
      <section class="panel panel--map hidden" id="panel-map">
        <div class="panel-header">
          <div class="panel-title">
            <span>銷售熱點地圖</span>
            <span class="badge">MAP VIEW</span>
          </div>
          <div class="panel-header-controls">
            <!-- 列表按鈕已移至標題列，地圖樣式與熱區按鈕移至浮動地圖視窗 -->
          </div>
        </div>
        <div class="panel-body">
          <div class="map-wrapper">
            <div id="map"></div>
            <div class="map-overlay-controls">
              <button class="map-control-button" id="map-filter-all">
                <span class="dot-all"></span> 全部門市
              </button>
              <button class="map-control-button" id="map-filter-alerts">
                <span class="dot-danger"></span> 僅紅黃燈
              </button>
              <button class="map-control-button" id="map-filter-top">
                <span class="dot-warning"></span> Top 銷售
              </button>

            </div>
            <div class="map-here-button">
              <button class="here-button" id="here-button">
                <div class="here-dot"></div>
                <span>Here · 鄰近門市</span>
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- 右：詳細（桌機用） -->
      <section class="panel" id="panel-detail">
        <div class="panel-body panel-body--detail">
          <div id="detail-container">
            <div class="detail-container-placeholder">
              👈 從左側選擇一間門市，或點左下角「📊 詳細」查看銷售型態與圖表。
            </div>
          </div>
        </div>
        <div class="detail-actions" id="detail-actions" style="display:none;">
          <!-- 使用統一風格的 SVG 圖示來取代表情符號，確保深色與淺色模式下都保持一致的視覺效果。 -->
          <button class="btn btn-primary" id="btn-notify">
            <svg class="icon-svg" viewBox="0 0 24 24"><path d="M18 8a6 6 0 0 0-12 0c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
            <span>通知代送商</span>
          </button>
          <button class="btn btn-secondary" id="btn-navigate">
            <svg class="icon-svg" viewBox="0 0 24 24"><path d="M3 11l19-9-9 19-2-8-8-2z"/></svg>
            <span>導航</span>
          </button>
          <button class="btn btn-ghost" id="btn-done">
            <svg class="icon-svg" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
            <span>標記已處理</span>
          </button>
        </div>
      </section>
    </main>

  <!-- Fullscreen map overlay: initially hidden.  Displays a full Leaflet map with markers when activated. -->
  <div id="fullscreen-map-overlay" style="display:none;position:fixed;inset:0;z-index:6000;background:var(--bg-main);flex-direction:column;">
    <div id="fullscreen-map-container" style="flex:1;position:relative;"></div>
    <!-- Close button for fullscreen map -->
    <button id="fullscreen-map-close" class="chip-button" style="position:absolute;top:16px;right:16px;z-index:6001;">✕</button>
  </div>
    <!-- 新增：浮動地圖視窗（預設關閉） -->
    <div id="map-overlay" class="map-overlay hidden">
      <div class="map-overlay-inner">
        <!-- 將控制按鈕移至地圖區塊內部，類似 Google 地圖上的自訂按鈕 -->
        <div id="overlay-map" class="overlay-map">
          <div class="overlay-map-controls">
            <button class="map-control-button" id="overlay-base-toggle" title="切換地圖樣式">🌗</button>
            <button class="map-control-button" id="overlay-heat-toggle" title="切換熱區圖">🔥</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 全螢幕戰情地圖覆蓋（預設隱藏） -->
    <div id="war-map-overlay">
      <div id="war-map"></div>
      <!-- 互動標記層：自訂圓點，提升點擊體驗 -->
      <div id="war-marker-layer"></div>
      <!-- 戰情地圖中的門市小卡彈窗，點擊店鋪時顯示 -->
      <div id="war-popup" class="war-popup hidden"></div>
      <div class="war-here-button">
        <!-- 使用交叉圓環圖示（⌖）作為定位按鈕，類似 Google 地圖的 Here 圖示 -->
        <button class="here-button" id="war-here-button" title="定位目前位置">⌖</button>
      </div>
      <button id="war-back-button" title="返回">←</button>
    </div>

    <!-- 地區消長圖表彈窗（預設隱藏） -->
    <div id="region-modal">
      <div class="region-modal-inner">
        <div class="region-modal-header">
          <div class="region-modal-title">地區銷售消長</div>
          <button class="region-modal-close" id="region-modal-close">×</button>
        </div>
        <canvas id="region-chart-canvas"></canvas>
      </div>
    </div>
  </div>

  <!-- 手機：底部抽屜 -->
  <div class="detail-bottom-backdrop" id="detail-bottom-backdrop"></div>
  <div class="detail-bottom-sheet" id="detail-bottom-sheet">
    <div class="detail-bottom-handle" id="detail-bottom-handle"></div>
    <div class="detail-bottom-inner" id="detail-bottom-inner"></div>
  </div>

  <!-- Modal：通知代送商 -->
  <div class="modal-backdrop" id="modal-backdrop">
    <div class="modal">
      <div class="modal-title">
        <!-- 使用統一 bell 圖示作為標題圖標 -->
        <svg class="icon-svg" viewBox="0 0 24 24"><path d="M18 8a6 6 0 0 0-12 0c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
        <span>通知代送商</span>
      </div>
      <div class="modal-body" id="modal-body"></div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="modal-cancel">捨棄</button>
        <button class="btn btn-primary" id="modal-confirm">通知代送商</button>
      </div>
    </div>
  </div>

  <!-- 全部門市列表 overlay -->
  <div class="table-backdrop" id="table-backdrop">
    <div class="table-modal">
      <div class="table-modal-header">
        <div>
          <!-- 簡化表格標題及說明文字以降低標題列高度 -->
          <div class="table-modal-title">門市列表</div>
          <!-- 調整副標語簡短為「檢視關鍵指標」以節省空間 -->
          <div class="table-modal-sub">檢視關鍵指標</div>
        </div>
        <div class="table-header-controls">
          <select id="table-region-filter" class="table-region-select"></select>
          <!-- 新增：銷售漲跌篩選 -->
          <select id="table-growth-filter" class="table-region-select"></select>
          <!-- 新增：庫存風險篩選 -->
          <select id="table-risk-filter" class="table-region-select"></select>
          <button class="table-modal-close" id="table-close" title="返回">←</button>
        </div>
      </div>
      <div class="table-modal-body">
        <table class="store-table" id="store-table"></table>
      </div>
    </div>
  </div>

  <!-- 返回頂端按鈕 -->
  <button id="scroll-top-btn" class="scroll-top-btn">↑</button>

  <!-- Toast notifications -->
  <div id="toast-container"></div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <!-- MarkerCluster plugin for Leaflet -->
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    const BREAKPOINT_DESKTOP = 1024;
// CSV URL pointing to the published Google Sheet for live data.
// Please ensure the Sheet is set to "Anyone can view" and uses the correct gid.
const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRVxK10bag9WaT5RPkA5BdsNF98cO8d1xH2oqHVemf5vJ6vGBp-Q0LDrel4k1eCS8ht72Tcuc4YwVzM/pub?gid=0&single=true&output=csv';

/**
 * Parse a CSV string into an array of objects.
 * Handles quoted fields, custom mapping for known header names, and converts
 * numeric values where possible.
 *
 * @param {string} csvText - Raw CSV text
 * @returns {Object[]} Array of row objects keyed by column names
 */
function parseCSV(csvText) {
  const lines = csvText.split('\n');
  if (lines.length === 0) return [];
  // Remove BOM if present
  if (lines[0].charCodeAt(0) === 0xFEFF) {
    lines[0] = lines[0].slice(1);
  }
  const headerLine = lines.shift().trim();
  const headers = headerLine.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(h => h.trim());
  const mapping = {
    "store id": "Store_ID",
    "store name": "Store_Name",
    "region": "Region",
    "city": "Region",
    "address": "Address",
    "latitude": "Latitude",
    "longitude": "Longitude",
    "route code": "Route_Code",
    "sales rep id": "Sales_Rep_ID",
    "sales rep name": "Sales_Rep_Name",
    "weekly sales": "Weekly_Sales",
    "weekly growth rate": "Weekly_Growth_Rate",
    "psd value": "PSD_Value",
    "current inventory": "Current_Inventory",
    "ztr status": "ZTR_Status",
    "ztr days": "ZTR_Days",
    "ztr": "ZTR",
    "alert level": "Alert_Level",
    "alert type": "Alert_Type",
    "distance from user": "Distance_From_User",
    "is important": "Is_Important",
    "last delivery date": "Last_Delivery_Date",
    "expiry date": "Expiry_Date",
    "last update": "Last_Update",
    "weekly flow": "Weekly_Flow",
    "sales pattern": "Sales_Pattern"
  };
  const result = [];
  for (let line of lines) {
    if (!line.trim()) continue;
    let rawLine = line;
    // Handle multi-line quoted fields by concatenating lines until quotes balance
    while ((rawLine.match(/"/g) || []).length % 2 === 1) {
      if (lines.length === 0) break;
      rawLine += '\n' + lines.shift();
    }
    const fields = rawLine.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/);
    const record = {};
    let ztrRaw = null;
    fields.forEach((field, index) => {
      let value = field;
      if (value.startsWith('"') && value.endsWith('"')) {
        value = value.slice(1, -1);
        value = value.replace(/""/g, '"');
      }
      value = value.trim();
      const header = headers[index] || `field${index}`;
      const keyMap = mapping[header.toLowerCase()];
      let finalKey;
      if (keyMap) {
        finalKey = keyMap;
      } else {
        finalKey = header.replace(/\s+/g, '_');
        finalKey = finalKey.split('_').map(w => (w.toUpperCase() === 'ID' ? 'ID' : w.charAt(0).toUpperCase() + w.slice(1))).join('_');
      }
      let val = value;
      // Convert numeric strings to numbers where appropriate
      if (val !== '' && !isNaN(val) && !isNaN(parseFloat(val))) {
        val = parseFloat(val);
      }
      if (finalKey === 'Weekly_Growth_Rate') {
        if (typeof val === 'string' && val.includes('%')) {
          const num = parseFloat(val.replace('%', ''));
          if (!isNaN(num)) val = num / 100;
        } else if (typeof val === 'number') {
          if (Math.abs(val) > 1) val = val / 100;
        }
      }
      if (finalKey === 'ZTR') {
        ztrRaw = val;
        return;
      }
      if (finalKey === 'Is_Important' || finalKey === 'ZTR_Status') {
        if (typeof val === 'string') {
          const lower = val.toLowerCase();
          if (['true','yes','y','是'].includes(lower)) val = true;
          else if (['false','no','n','否'].includes(lower)) val = false;
        } else if (typeof val === 'number') {
          val = val !== 0;
        }
      }
      record[finalKey] = val;
    });
    if (ztrRaw !== null) {
      if (typeof ztrRaw === 'string') {
        const ztrLower = ztrRaw.trim().toLowerCase();
        if (['true','yes'].includes(ztrLower)) {
          record.ZTR_Status = true;
          record.ZTR_Days = 0;
        } else if (['false','no',''].includes(ztrLower)) {
          record.ZTR_Status = false;
          record.ZTR_Days = 0;
        } else if (!isNaN(parseFloat(ztrRaw))) {
          const days = parseFloat(ztrRaw);
          record.ZTR_Days = days;
          record.ZTR_Status = days > 0;
        }
      } else if (typeof ztrRaw === 'number') {
        const days = ztrRaw;
        record.ZTR_Days = days;
        record.ZTR_Status = days > 0;
      }
    }
    result.push(record);
  }
  return result;
}

/**
 * Fetch and parse the stores data from the published Google Sheet.
 * If fetching fails, this function throws an error so callers can fallback.
 *
 * @returns {Promise<Object[]>} Resolved stores array
 */
async function loadStoresFromSheet() {
  const res = await fetch(SHEET_CSV_URL);
  if (!res.ok) {
    throw new Error('Network response was not ok');
  }
  const csvText = await res.text();
  const records = parseCSV(csvText);
  // Convert each CSV row to the store object structure expected by the app
  return records.map(row => {
    const store = {
      Store_ID: row.Store_ID || row.StoreId || row.ID || '',
      Store_Name: row.Store_Name || row.StoreName || row.Name || '',
      Region: row.Region || row.City || row.County || '',
      Address: row.Address || '',
      Latitude: typeof row.Latitude === 'number' ? row.Latitude : parseFloat(row.Latitude) || 0,
      Longitude: typeof row.Longitude === 'number' ? row.Longitude : parseFloat(row.Longitude) || 0,
      Route_Code: row.Route_Code || row.Route || row.RouteCode || '',
      Sales_Rep_ID: row.Sales_Rep_ID || row.SalesRepID || '',
      Sales_Rep_Name: row.Sales_Rep_Name || row.SalesRepName || '',
      Weekly_Sales: typeof row.Weekly_Sales === 'number' ? row.Weekly_Sales : parseFloat(row.Weekly_Sales) || 0,
      Weekly_Growth_Rate: typeof row.Weekly_Growth_Rate === 'number' ? row.Weekly_Growth_Rate : parseFloat(row.Weekly_Growth_Rate) || 0,
      PSD_Value: typeof row.PSD_Value === 'number' ? row.PSD_Value : parseFloat(row.PSD_Value) || 0,
      Current_Inventory: typeof row.Current_Inventory === 'number' ? row.Current_Inventory : parseFloat(row.Current_Inventory) || 0,
      ZTR_Days: typeof row.ZTR_Days === 'number' ? row.ZTR_Days : parseFloat(row.ZTR_Days) || 0,
      ZTR_Status: row.ZTR_Status !== undefined ? row.ZTR_Status : (row.ZTR_Days ? parseFloat(row.ZTR_Days) > 0 : false),
      Alert_Level: row.Alert_Level || '',
      Alert_Type: row.Alert_Type || '',
      Is_Important: row.Is_Important !== undefined ? row.Is_Important : (row.Important || false),
      Last_Delivery_Date: row.Last_Delivery_Date || '',
      Expiry_Date: row.Expiry_Date || '',
      Last_Update: row.Last_Update || '',
      Weekly_Flow: Array.isArray(row.Weekly_Flow) ? row.Weekly_Flow : (typeof row.Weekly_Flow === 'string' && row.Weekly_Flow.includes('|') ? row.Weekly_Flow.split('|').map(v => parseFloat(v) || 0) : []),
      Sales_Pattern: row.Sales_Pattern || ''
    };
    return store;
  });
}

    const mockStores = [
      {
        Store_ID: "1001",
        Store_Name: "三星中山",
        Region: "宜蘭縣",
        Address: "宜蘭縣三星鄉中山路一段 100 號",
        Latitude: 24.673,
        Longitude: 121.642,
        Route_Code: "A15",
        Sales_Rep_ID: "1420281",
        Sales_Rep_Name: "陳道平",
        Weekly_Sales: 74,
        Weekly_Growth_Rate: 0.15,
        PSD_Value: 3.9,
        Current_Inventory: 12,
        ZTR_Status: true,
        ZTR_Days: 3,
        Alert_Level: "critical",
        Alert_Type: "缺貨風險",
        Distance_From_User: null,
        Is_Important: true,
        Last_Delivery_Date: "2025-02-20",
        Expiry_Date: "2025-03-01",
        Last_Update: "2025-02-24 09:20",
        Weekly_Flow: [2.4, 0.6, 0.2, 1.5, 2.0, 1.2, 0.8],
        Sales_Pattern: "平日型態"
      },
      {
        Store_ID: "1002",
        Store_Name: "南投魚池",
        Region: "南投縣",
        Address: "南投縣魚池鄉日月潭路 50 號",
        Latitude: 23.883,
        Longitude: 120.917,
        Route_Code: "B08",
        Sales_Rep_ID: "1420320",
        Sales_Rep_Name: "林惠珍",
        Weekly_Sales: 57,
        Weekly_Growth_Rate: -0.12,
        PSD_Value: 2.8,
        Current_Inventory: 55,
        ZTR_Status: false,
        ZTR_Days: 0,
        Alert_Level: "warning",
        Alert_Type: "高庫存風險",
        Distance_From_User: null,
        Is_Important: false,
        Last_Delivery_Date: "2025-02-18",
        Expiry_Date: "2025-03-03",
        Last_Update: "2025-02-24 09:18",
        Weekly_Flow: [0.8, 0.7, 0.6, 0.7, 1.5, 2.0, 1.5],
        Sales_Pattern: "偏假日型態"
      },
      {
        Store_ID: "1003",
        Store_Name: "中正華山",
        Region: "台北市",
        Address: "台北市中正區林森南路 120 號",
        Latitude: 25.042,
        Longitude: 121.529,
        Route_Code: "N12",
        Sales_Rep_ID: "1419988",
        Sales_Rep_Name: "張勝文",
        Weekly_Sales: 33,
        Weekly_Growth_Rate: 0.08,
        PSD_Value: 1.6,
        Current_Inventory: 40,
        ZTR_Status: true,
        ZTR_Days: 7,
        Alert_Level: "warning",
        Alert_Type: "滯銷風險",
        Distance_From_User: null,
        Is_Important: true,
        Last_Delivery_Date: "2025-02-19",
        Expiry_Date: "2025-03-05",
        Last_Update: "2025-02-24 09:10",
        Weekly_Flow: [0.4, 0.5, 0.3, 0.4, 0.7, 0.7, 0.6],
        Sales_Pattern: "一般（無偏向）"
      },
      {
        Store_ID: "1004",
        Store_Name: "高雄美術館",
        Region: "高雄市",
        Address: "高雄市鼓山區美術館路 200 號",
        Latitude: 22.662,
        Longitude: 120.293,
        Route_Code: "S21",
        Sales_Rep_ID: "1420500",
        Sales_Rep_Name: "簡志豪",
        Weekly_Sales: 12,
        Weekly_Growth_Rate: -0.23,
        PSD_Value: 0.6,
        Current_Inventory: 30,
        ZTR_Status: true,
        ZTR_Days: 10,
        Alert_Level: "critical",
        Alert_Type: "滯銷 / 過期風險",
        Distance_From_User: null,
        Is_Important: false,
        Last_Delivery_Date: "2025-02-10",
        Expiry_Date: "2025-02-28",
        Last_Update: "2025-02-24 09:05",
        Weekly_Flow: [0.1, 0.2, 0.1, 0.2, 0.4, 0.4, 0.3],
        Sales_Pattern: "假日型態"
      },
      {
        Store_ID: "1005",
        Store_Name: "台中市政",
        Region: "台中市",
        Address: "台中市西屯區市政路 300 號",
        Latitude: 24.163,
        Longitude: 120.648,
        Route_Code: "C02",
        Sales_Rep_ID: "1420123",
        Sales_Rep_Name: "黃怡君",
        Weekly_Sales: 90,
        Weekly_Growth_Rate: 0.25,
        PSD_Value: 4.5,
        Current_Inventory: 80,
        ZTR_Status: false,
        ZTR_Days: 0,
        Alert_Level: "normal",
        Alert_Type: "",
        Distance_From_User: null,
        Is_Important: true,
        Last_Delivery_Date: "2025-02-22",
        Expiry_Date: "2025-03-08",
        Last_Update: "2025-02-24 09:25",
        Weekly_Flow: [1.2, 1.3, 1.1, 1.2, 2.0, 1.9, 1.3],
        Sales_Pattern: "偏假日型態"
      },
      // ---  新增假門市資料（增加更多縣市方便測試地區消長圖表） ---
      {
        Store_ID: "1006",
        Store_Name: "彰化成功",
        Region: "彰化縣",
        Address: "彰化縣彰化市成功路 50 號",
        Latitude: 24.081,
        Longitude: 120.536,
        Route_Code: "C03",
        Sales_Rep_ID: "1420600",
        Sales_Rep_Name: "李明峰",
        Weekly_Sales: 65,
        Weekly_Growth_Rate: 0.12,
        PSD_Value: 2.5,
        Current_Inventory: 45,
        ZTR_Status: false,
        ZTR_Days: 0,
        Alert_Level: "warning",
        Alert_Type: "高庫存風險",
        Distance_From_User: null,
        Is_Important: false,
        Last_Delivery_Date: "2025-02-22",
        Expiry_Date: "2025-03-10",
        Last_Update: "2025-02-24 09:30",
        Weekly_Flow: [1.0, 1.2, 0.8, 1.0, 1.5, 1.4, 1.1],
        Sales_Pattern: "平日型態"
      },
      {
        Store_ID: "1007",
        Store_Name: "雲林斗六",
        Region: "雲林縣",
        Address: "雲林縣斗六市雲林路 88 號",
        Latitude: 23.707,
        Longitude: 120.543,
        Route_Code: "C04",
        Sales_Rep_ID: "1420610",
        Sales_Rep_Name: "王淑芬",
        Weekly_Sales: 42,
        Weekly_Growth_Rate: -0.08,
        PSD_Value: 1.8,
        Current_Inventory: 32,
        ZTR_Status: true,
        ZTR_Days: 5,
        Alert_Level: "warning",
        Alert_Type: "滯銷風險",
        Distance_From_User: null,
        Is_Important: false,
        Last_Delivery_Date: "2025-02-19",
        Expiry_Date: "2025-03-05",
        Last_Update: "2025-02-24 09:28",
        Weekly_Flow: [0.5, 0.4, 0.4, 0.6, 0.9, 1.1, 0.9],
        Sales_Pattern: "一般（無偏向）"
      },
      {
        Store_ID: "1008",
        Store_Name: "嘉義文化",
        Region: "嘉義市",
        Address: "嘉義市東區文化路 1 段 100 號",
        Latitude: 23.479,
        Longitude: 120.453,
        Route_Code: "C05",
        Sales_Rep_ID: "1420620",
        Sales_Rep_Name: "陳美華",
        Weekly_Sales: 88,
        Weekly_Growth_Rate: 0.07,
        PSD_Value: 3.1,
        Current_Inventory: 60,
        ZTR_Status: false,
        ZTR_Days: 0,
        Alert_Level: "normal",
        Alert_Type: "",
        Distance_From_User: null,
        Is_Important: true,
        Last_Delivery_Date: "2025-02-21",
        Expiry_Date: "2025-03-09",
        Last_Update: "2025-02-24 09:32",
        Weekly_Flow: [1.1, 1.2, 1.0, 1.3, 2.1, 2.0, 1.6],
        Sales_Pattern: "假日型態"
      },
      {
        Store_ID: "1009",
        Store_Name: "嘉義東石",
        Region: "嘉義縣",
        Address: "嘉義縣東石鄉中正路 66 號",
        Latitude: 23.451,
        Longitude: 120.255,
        Route_Code: "C06",
        Sales_Rep_ID: "1420630",
        Sales_Rep_Name: "廖志凱",
        Weekly_Sales: 29,
        Weekly_Growth_Rate: -0.15,
        PSD_Value: 1.2,
        Current_Inventory: 28,
        ZTR_Status: true,
        ZTR_Days: 8,
        Alert_Level: "critical",
        Alert_Type: "滯銷 / 過期風險",
        Distance_From_User: null,
        Is_Important: false,
        Last_Delivery_Date: "2025-02-17",
        Expiry_Date: "2025-03-01",
        Last_Update: "2025-02-24 09:29",
        Weekly_Flow: [0.3, 0.4, 0.2, 0.3, 0.6, 0.7, 0.6],
        Sales_Pattern: "一般（無偏向）"
      },
      {
        Store_ID: "1010",
        Store_Name: "台南安平",
        Region: "臺南市",
        Address: "臺南市安平區安平路 200 號",
        Latitude: 22.995,
        Longitude: 120.187,
        Route_Code: "C07",
        Sales_Rep_ID: "1420640",
        Sales_Rep_Name: "許佳琪",
        Weekly_Sales: 53,
        Weekly_Growth_Rate: 0.20,
        PSD_Value: 2.2,
        Current_Inventory: 38,
        ZTR_Status: false,
        ZTR_Days: 0,
        Alert_Level: "normal",
        Alert_Type: "",
        Distance_From_User: null,
        Is_Important: true,
        Last_Delivery_Date: "2025-02-21",
        Expiry_Date: "2025-03-11",
        Last_Update: "2025-02-24 09:31",
        Weekly_Flow: [0.8, 0.9, 0.7, 1.0, 1.8, 1.9, 1.4],
        Sales_Pattern: "偏假日型態"
      },
      {
        Store_ID: "1011",
        Store_Name: "屏東恆春",
        Region: "屏東縣",
        Address: "屏東縣恆春鎮中山路 78 號",
        Latitude: 22.004,
        Longitude: 120.744,
        Route_Code: "C08",
        Sales_Rep_ID: "1420650",
        Sales_Rep_Name: "李靜雯",
        Weekly_Sales: 38,
        Weekly_Growth_Rate: -0.05,
        PSD_Value: 1.7,
        Current_Inventory: 20,
        ZTR_Status: true,
        ZTR_Days: 6,
        Alert_Level: "critical",
        Alert_Type: "缺貨風險",
        Distance_From_User: null,
        Is_Important: false,
        Last_Delivery_Date: "2025-02-15",
        Expiry_Date: "2025-03-05",
        Last_Update: "2025-02-24 09:27",
        Weekly_Flow: [0.3, 0.4, 0.3, 0.4, 0.7, 0.8, 0.5],
        Sales_Pattern: "一般（無偏向）"
      },
      {
        Store_ID: "1012",
        Store_Name: "花蓮美崙",
        Region: "花蓮縣",
        Address: "花蓮縣花蓮市美崙街 120 號",
        Latitude: 23.978,
        Longitude: 121.615,
        Route_Code: "C09",
        Sales_Rep_ID: "1420660",
        Sales_Rep_Name: "郭于婷",
        Weekly_Sales: 47,
        Weekly_Growth_Rate: 0.03,
        PSD_Value: 1.9,
        Current_Inventory: 24,
        ZTR_Status: false,
        ZTR_Days: 0,
        Alert_Level: "warning",
        Alert_Type: "高庫存風險",
        Distance_From_User: null,
        Is_Important: false,
        Last_Delivery_Date: "2025-02-20",
        Expiry_Date: "2025-03-06",
        Last_Update: "2025-02-24 09:33",
        Weekly_Flow: [0.6, 0.7, 0.5, 0.6, 1.0, 1.1, 0.7],
        Sales_Pattern: "平日型態"
      }
    ];

    let stores = [];
    let activeStoreId = null;
    let activeFilter = "all";
// default sorting: use weekly sales first. When sales are equal,
// a secondary sort on weekly growth rate will be applied in renderStoreList().
let activeSort = "weeklySales";
    let activeTab = "hotspots";
    let map;
    let markers = {};
    // Cluster group to manage marker clustering on the map.  This is
    // initialised in initMap() when the Leaflet map is created.
    let markerCluster;
    let userLocation = null;
    let userLocationMarker = null;

    // Track the timestamp when a store was last focused.  Used to
    // prevent the map from collapsing immediately after being
    // programmatically expanded during a store focus operation.
    let lastFocusTs = 0;

    let weeklyFlowChart = null;
    let patternChart = null;
    let detailMap = null;

    // Register a Chart.js plugin to fill the chart area background.  The
    // plugin reads a `color` option passed via the chart configuration.
    // When rendering the chart, it fills the plot area with the specified
    // color so that the line/area stands out clearly on both light and dark
    // themes.  See renderWeeklyFlowChart and renderPatternChart for usage.
    const chartBackgroundPlugin = {
      id: "customCanvasBackgroundColor",
      beforeDraw: (chart, args, opts) => {
        const { ctx, chartArea } = chart;
        if (!chartArea) return;
        ctx.save();
        ctx.fillStyle = opts && opts.color ? opts.color : "#fff7eb";
        ctx.fillRect(
          chartArea.left,
          chartArea.top,
          chartArea.right - chartArea.left,
          chartArea.bottom - chartArea.top
        );
        ctx.restore();
      }
    };
    // Ensure the plugin is registered once with Chart.js.
    Chart.register(chartBackgroundPlugin);

    let bottomSheetOpen = false;
    let modalOpen = false;
    let tableOpen = false;
    let tableRegionFilter = "all";
    // Additional filters for the full table view
    let tableGrowthFilter = "all";
    let tableRiskFilter = "all";

    let scrollTopBtn = null;

    // Added state variables for war-room and advanced features
    let modeWar = false; // whether war-room mode is active
    let drawerOpen = false; // whether list drawer is open in war-mode
    let heatLayer = []; // custom heat layer circles
    let lightLayer; // reference to default light basemap
    let darkLayer; // dark basemap
    let currentBase = "light"; // current base map key
    let hereCircles = []; // circles drawn around user location
    let routePolyline = null; // current route polyline
    let currentModalStore = null; // store referenced in the notify modal

    // Additional state for war and tour features
    // Custom markers used in war mode (array of Leaflet markers)
    let warMarkers = [];
    // Track whether the map is expanded on mobile. Defaults to false (small map)
    let mapExpanded = false;
    // Retain legacy variable for map collapse (no longer used) for backwards compatibility
    let mapCollapsed = false;
    let tourMode = false; // whether tour mode is active
    let selectedRoute = ""; // currently selected route code in tour mode

    // --- Tour manual ordering (drag-and-drop) ---
    const TOUR_ORDER_STORAGE_PREFIX = "tourOrder:";

    function isTourManualSortAvailable() {
      return !!(tourMode && selectedRoute);
    }

    function getTourOrderStorageKey(routeCode) {
      return `${TOUR_ORDER_STORAGE_PREFIX}${routeCode}`;
    }

    function readTourOrder(routeCode) {
      try {
        const raw = localStorage.getItem(getTourOrderStorageKey(routeCode));
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : null;
      } catch (err) {
        return null;
      }
    }

    function writeTourOrder(routeCode, orderIds) {
      try {
        localStorage.setItem(getTourOrderStorageKey(routeCode), JSON.stringify(orderIds));
      } catch (err) {
        // ignore
      }
    }

    function ensureTourOrder(routeCode) {
      const existing = readTourOrder(routeCode);
      if (existing && existing.length) return existing;
      // Default order: priority desc, then Store_ID asc for stability
      const ids = stores
        .filter(s => s.Route_Code === routeCode)
        .slice()
        .sort((a, b) => {
          const pa = a.__priority ?? computePriority(a);
          const pb = b.__priority ?? computePriority(b);
          if (pb !== pa) return pb - pa;
          return String(a.Store_ID).localeCompare(String(b.Store_ID), "zh-Hant");
        })
        .map(s => s.Store_ID);
      writeTourOrder(routeCode, ids);
      return ids;
    }

    function syncTourManualSortOption() {
      const sortSelect = document.getElementById("sort-select");
      if (!sortSelect) return;

      const existing = sortSelect.querySelector('option[value="manual"]');
      if (isTourManualSortAvailable()) {
        if (!existing) {
          const opt = document.createElement("option");
          opt.value = "manual";
          opt.textContent = "手動排序（拖曳）";
          sortSelect.appendChild(opt);
        }
      } else {
        if (existing) existing.remove();
        if (activeSort === "manual") {
          activeSort = tourMode ? "priority" : "weeklySales";
          sortSelect.value = activeSort;
        }
      }
    }

    // Custom state flags for overlays
    let warOverlayOpen = false; // whether the full-screen war map overlay is visible
    let regionModalOpen = false; // whether the region growth chart modal is visible

    function isDesktop() {
      return window.innerWidth > BREAKPOINT_DESKTOP;
    }

document.addEventListener("DOMContentLoaded", async () => {
      scrollTopBtn = document.getElementById("scroll-top-btn");

      await initializeData();
      initSummary();
      initMap();
      initList();
      initTabs();
      initModal();
      initBottomSheet();
      initFullTable();
      initScrollTopButton();

      // Initialise新控制項：巡店模式、地圖尺寸切換等
      initTourModeControls();
      initMapSizeToggle();

      // 初始化門市分佈下拉選單
      initRegionFilterControls();

      // 當點擊地區消長彈窗背景時，關閉彈窗並回到上一狀態
      const regionModalBg = document.getElementById('region-modal');
      if (regionModalBg) {
        regionModalBg.addEventListener('click', (ev) => {
          // 只有點擊在背景（非內部）且彈窗已開啟時才關閉
          if (ev.target === regionModalBg && regionModalOpen) {
            closeRegionChart();
            // 若歷史狀態中記錄了地區圖表開啟，返回上一層
            history.back();
          }
        });
      }

      // Adjust sticky panel positions based on header height (desktop only)
      updateStickyLayout();
      window.addEventListener('resize', updateStickyLayout);

      // When scrolling the list on mobile, collapse the expanded map automatically.
      const listBody = document.querySelector("#panel-list .panel-body");
      const sizeToggle = document.getElementById("map-size-toggle");
      if (listBody) {
        listBody.addEventListener("scroll", () => {
          // Only act on mobile: if the map is expanded and the user scrolls down, shrink it back
          if (!isDesktop() && document.body.classList.contains("map-expanded") && listBody.scrollTop > 40) {
            // If a focus event just occurred, allow a brief grace period before collapsing to
            // avoid immediately collapsing the map when scrollIntoView is triggered.
            const now = Date.now();
            if (now - lastFocusTs < 500) {
              return;
            }
            document.body.classList.remove("map-expanded");
            mapExpanded = false;
            if (sizeToggle) {
              sizeToggle.textContent = "🔍 放大地圖";
            }
          }
        });
      }

      // Also monitor page scroll on mobile to collapse an expanded map when the user scrolls down the page
      window.addEventListener("scroll", () => {
        if (!isDesktop() && document.body.classList.contains("map-expanded")) {
          const y = window.pageYOffset || document.documentElement.scrollTop || 0;
          if (y > 40) {
            // Same grace period check as for list scroll
            const now = Date.now();
            if (now - lastFocusTs < 500) {
              return;
            }
            document.body.classList.remove("map-expanded");
            mapExpanded = false;
            if (sizeToggle) {
              sizeToggle.textContent = "🔍 放大地圖";
            }
          }
        }
      });

      window.addEventListener("popstate", (e) => {
        const state = e.state || {};
        // Handle the fullscreen map overlay: if the popped state contains
        // fullscreenMap, open the overlay (used when navigating forward).
        // If the overlay is currently open and the state does not contain
        // fullscreenMap, close the overlay.  This ensures that pressing
        // the browser back button closes the map overlay rather than
        // exiting the application entirely.
        if (state.fullscreenMap) {
          // Only open if not already open.  Skip pushing history when restoring the overlay.
          if (!fullscreenMapOpen) {
            openFullscreenMap(true);
          }
          return;
        } else if (fullscreenMapOpen) {
          // Close overlay and restore scrolling
          const overlay = document.getElementById('fullscreen-map-overlay');
          if (overlay) {
            overlay.style.display = 'none';
          }
          document.body.style.overflow = '';
          fullscreenMapOpen = false;
          return;
        }

        // Handle returning from a store detail that originated from the full table (or region chart).
        if (state.fromFullTable) {
          // Close detail sheet if open
          if (bottomSheetOpen) {
            closeBottomSheet();
          }
          const tableBackdrop = document.getElementById('table-backdrop');
          if (state.regionFromChart) {
            // If the table came from the region growth chart, restore the chart view
            // without pushing a new history entry
            openRegionChart(true);
          } else {
            // Otherwise reopen the full table
            if (tableBackdrop) {
              tableBackdrop.classList.add('table-backdrop--show');
            }
            tableOpen = true;
          }
          return;
        }
        const tableBackdrop = document.getElementById("table-backdrop");
        // 處理區域下拉選單返回：如果顯示中且不是 regionDropdown state，則關閉選單並停止後續處理
        const regionDropdownEl = document.getElementById('region-dropdown');
        const distributionBtn = document.getElementById('tab-distribution');
        if (state.regionDropdown) {
          // 若是 regionDropdown 標記，代表剛顯示下拉選單，不做任何事
        } else if (regionDropdownVisible) {
          if (regionDropdownEl) {
            regionDropdownEl.style.display = 'none';
          }
          regionDropdownVisible = false;
          // 更新按鈕文字，若沒有篩選則回復預設
          if (distributionBtn) {
            distributionBtn.textContent = currentRegionFilter ? currentRegionFilter : '門市分佈';
          }
          return;
        }
        // 優先關閉開啟中的模態或抽屜
        if (modalOpen) {
          const backdrop = document.getElementById("modal-backdrop");
          backdrop.classList.remove("modal-backdrop--show");
          modalOpen = false;
          return;
        }
        if (bottomSheetOpen) {
          closeBottomSheet();
          return;
        }
        if (tableOpen) {
          // 關閉列表覆蓋層
          if (tableBackdrop) {
            tableBackdrop.classList.remove("table-backdrop--show");
          }
          tableOpen = false;
          // 如果從地區消長圖表而來，返回時重新打開圖表
          if (state.regionFromChart) {
            // 將滑動滾到頂部，然後重新顯示圖表
            window.scrollTo({ top: 0 });
            // 從表格返回圖表時，不新增歷史紀錄
            openRegionChart(true);
          } else if (state.regionChartOpen) {
            // 直接重新打開圖表，不額外推入歷史
            openRegionChart(true);
          }
          return;
        }
        // 若地區圖表開啟則先關閉
        if (regionModalOpen) {
          closeRegionChart();
          return;
        }
        // 將過去的 war 模式返回邏輯整合為全螢幕地圖邏輯：
        // 若在歷史紀錄中存在 warMode 旗標，實際上應視為開啟全螢幕地圖。
        if (state.warMode) {
          // 若全螢幕地圖尚未開啟，則開啟（不新增歷史）
          if (!fullscreenMapOpen) {
            openFullscreenMap(true);
          }
          return;
        }
        // 若不存在 warMode 旗標，但 war overlay 仍為開啟狀態，則關閉之。
        if (warOverlayOpen) {
          // 自此不再使用 war overlay，直接關閉
          const overlay = document.getElementById('fullscreen-map-overlay');
          if (overlay) overlay.style.display = 'none';
          document.body.style.overflow = '';
          fullscreenMapOpen = false;
          warOverlayOpen = false;
          return;
        }
        // 其他情況無需處理
      });
    });

async function initializeData() {
      try {
        // Attempt to load live data from the published Google Sheet.
        const sheetData = await loadStoresFromSheet();
        // If data is loaded and non-empty, assign to stores.
        if (Array.isArray(sheetData) && sheetData.length > 0) {
          stores = sheetData.map(s => ({ ...s, __done: s.__done || false }));
        } else {
          throw new Error('No data rows found');
        }
      } catch (e) {
        console.warn('Falling back to mock data due to error:', e);
        // Fall back to the mockStores array and auto-generate some clones.
        stores = mockStores.map(s => ({ ...s, __done: s.__done || false }));
        const extraStores = [];
        const suffixes = ["-分店A", "-分店B", "-分店C"];
        suffixes.forEach((suffix, idx) => {
          mockStores.forEach((s, i) => {
            const clone = { ...s };
            clone.Store_ID = s.Store_ID + String.fromCharCode(65 + idx);
            clone.Store_Name = s.Store_Name + suffix;
            clone.Latitude = s.Latitude + 0.05 * (idx - 1);
            clone.Longitude = s.Longitude + 0.05 * (i - 2);
            clone.Weekly_Sales = Math.max(5, s.Weekly_Sales + (i * 5 - idx * 3));
            clone.Current_Inventory = Math.max(5, s.Current_Inventory + (idx * 8 - i * 4));
            clone.__done = false;
            extraStores.push(clone);
          });
        });
        stores = stores.concat(extraStores);
      }
      // Compute derived fields (sales color and priority) for all stores.
      const sortedBySales = [...stores].sort((a, b) => (b.Weekly_Sales || 0) - (a.Weekly_Sales || 0));
      sortedBySales.forEach((store, index) => {
        const percentile = (index + 1) / sortedBySales.length;
        store.__salesColor = getSalesColorByPercentile(percentile);
        store.__priority = computePriority(store);
      });
    }

    // Update sticky panel heights on desktop based on header height
    function updateStickyLayout() {
      // Remove custom heights on mobile
      if (!isDesktop()) {
        const list = document.getElementById("panel-list");
        const mapPanel = document.getElementById("panel-map");
        const detailPanel = document.getElementById("panel-detail");
        if (list) {
          list.style.height = "";
        }
        if (mapPanel) {
          mapPanel.style.top = "";
          mapPanel.style.height = "";
        }
        if (detailPanel) {
          detailPanel.style.top = "";
          detailPanel.style.height = "";
        }
        return;
      }
      const header = document.querySelector("header");
      const h = header ? header.offsetHeight : 72;
      // Add a small offset to reduce overall height and avoid unnecessary scrollbars
      const offset = 16;
      const list = document.getElementById("panel-list");
      const mapPanel = document.getElementById("panel-map");
      const detailPanel = document.getElementById("panel-detail");
      if (list) {
        list.style.height = `calc(100vh - ${h}px - ${offset}px)`;
      }
      if (mapPanel) {
        mapPanel.style.top = `${h}px`;
        mapPanel.style.height = `calc(100vh - ${h}px - ${offset}px)`;
      }
      if (detailPanel) {
        detailPanel.style.top = `${h}px`;
        detailPanel.style.height = `calc(100vh - ${h}px - ${offset}px)`;
      }
    }

    function initSummary() {
      const criticalCount = stores.filter(s => s.Alert_Level === "critical").length;
      const warningCount = stores.filter(s => s.Alert_Level === "warning").length;
      const top10Sum = stores
        .sort((a, b) => b.Weekly_Sales - a.Weekly_Sales)
        .slice(0, 10)
        .reduce((sum, s) => sum + s.Weekly_Sales, 0);

      document.getElementById("summary-critical").textContent = criticalCount;
      document.getElementById("summary-warning").textContent = warningCount;
      document.getElementById("summary-top10").textContent = top10Sum;
      document.getElementById("store-count-badge").textContent = `${stores.length} 門市`;

      // Update done/remaining counts
      const doneCount = stores.filter(s => s.__done).length;
      const remainingCount = stores.length - doneCount;
      const doneEl = document.getElementById("summary-done");
      const remainingEl = document.getElementById("summary-remaining");
      if (doneEl) doneEl.textContent = doneCount;
      if (remainingEl) remainingEl.textContent = remainingCount;

      // Update last sync indicator: use latest Last_Update among stores
      let latestTs = 0;
      stores.forEach(s => {
        if (s.Last_Update) {
          const ts = new Date(s.Last_Update).getTime();
          if (!isNaN(ts) && ts > latestTs) latestTs = ts;
        }
      });
      const lastSyncEl = document.getElementById("last-sync");
      if (lastSyncEl && latestTs > 0) {
        const lastDate = new Date(latestTs);
        // Format as YYYY-MM-DD HH:MM
        const y = lastDate.getFullYear();
        const m = String(lastDate.getMonth() + 1).padStart(2, "0");
        const d = String(lastDate.getDate()).padStart(2, "0");
        const hh = String(lastDate.getHours()).padStart(2, "0");
        const mm = String(lastDate.getMinutes()).padStart(2, "0");
        lastSyncEl.textContent = `Last Sync · ${y}-${m}-${d} ${hh}:${mm}`;
        const now = new Date();
        const diffHours = (now.getTime() - latestTs) / (1000 * 60 * 60);
        if (diffHours > 24) {
          lastSyncEl.setAttribute("data-stale", "true");
        } else {
          lastSyncEl.removeAttribute("data-stale");
        }
      }
    }

    function initMap() {
      map = L.map("map", {
        zoomControl: true,
        attributionControl: false
      }).setView([23.7, 121], 7.3);

      // Initialise base map layers (light and dark) using CartoDB tiles.
      // 參考 v2 版本的設計，選用 CartoDB 的亮色與暗色底圖，視覺上更加乾淨且風格一致。
      lightLayer = L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
        {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap &copy; CARTO"
        }
      );
      darkLayer = L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
        {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap &copy; CARTO"
        }
      );
      // Add light layer by default
      lightLayer.addTo(map);

      // Initialize marker cluster group. 參考 v2 版本，縮小 cluster 半徑並在
      // 放大到 15 級以上時自動展開個別門市。
      markerCluster = L.markerClusterGroup({
        maxClusterRadius: 40,
        disableClusteringAtZoom: 15,
        showCoverageOnHover: false
      });

      stores.forEach(store => {
        const color = getPinColor(store.__salesColor);
        const marker = L.circleMarker([store.Latitude, store.Longitude], {
          radius: 8,
          fillColor: color,
          color: "#ffffff",
          weight: 1,
          opacity: 1,
          fillOpacity: 0.8
        });

        // When clicking a marker, focus and open the store detail panel as before.
        marker.on("click", () => {
          focusStoreOnMap(store.Store_ID);
          openStoreDetail(store.Store_ID);
        });

        // Bind a popup showing store name, sales and growth rate with color-coded indicator.
        (function(s, m) {
          const growthRate = s.Weekly_Growth_Rate || 0;
          const growthPercent = Math.abs(growthRate * 100).toFixed(1) + '%';
          const arrow = growthRate >= 0 ? '▲' : '▼';
          const growthColor = growthRate >= 0 ? '#ef4444' : '#10b981';
          const popupContent = `<strong>${s.Store_Name}</strong><br>` +
            `銷售量：${s.Weekly_Sales} 箱<br>` +
            `增減量：<span style="color:${growthColor}">${arrow} ${growthPercent}</span>`;
          m.bindPopup(popupContent, { offset: [0, -8] });
        })(store, marker);

        markers[store.Store_ID] = marker;
        markerCluster.addLayer(marker);
      });

      // Add cluster group to the map
      markerCluster.addTo(map);

      document.getElementById("map-filter-all").addEventListener("click", () => {
        setMapFilter("all");
      });
      document.getElementById("map-filter-alerts").addEventListener("click", () => {
        setMapFilter("alerts");
      });
      document.getElementById("map-filter-top").addEventListener("click", () => {
        setMapFilter("top");
      });

      document.getElementById("here-button").addEventListener("click", handleHereClick);
    }

    function setMapFilter(mode) {
      // When clustering is enabled, update the cluster group rather than
      // adjusting individual marker opacity.  Remove all markers and
      // selectively re-add those matching the current filter.
      if (!markerCluster) {
        return;
      }
      markerCluster.clearLayers();
      if (mode === "all") {
        stores.forEach(store => {
          markerCluster.addLayer(markers[store.Store_ID]);
        });
      } else if (mode === "alerts") {
        stores.forEach(store => {
          if (store.Alert_Level === "critical" || store.Alert_Level === "warning") {
            markerCluster.addLayer(markers[store.Store_ID]);
          }
        });
      } else if (mode === "top") {
        const topStores = [...stores]
          .sort((a, b) => b.Weekly_Sales - a.Weekly_Sales)
          .slice(0, 3);
        topStores.forEach(store => {
          markerCluster.addLayer(markers[store.Store_ID]);
        });
      }
    }

    function handleHereClick() {
      if (!navigator.geolocation) {
        alert("此瀏覽器不支援定位功能。");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        position => {
          const { latitude, longitude } = position.coords;
          userLocation = { lat: latitude, lng: longitude };
          updateUserLocationOnMap();
          recomputeDistances();
          // Draw concentric circles and update marker visibility based on proximity
          drawHereCircles();
          updateNearbyVisibility();
          if (activeSort === "distance") {
            renderStoreList();
          }
          map.setView([latitude, longitude], 10);
          setActiveTab("nearby");
        },
        error => {
          console.error(error);
          alert("無法取得定位，請確認權限或使用 https 網站。");
        }
      );
    }

    function updateUserLocationOnMap() {
      if (!map || !userLocation) return;

      if (userLocationMarker) {
        map.removeLayer(userLocationMarker);
      }

      const divIcon = L.divIcon({
        className: "",
        html: '<div class="user-location-marker"></div>',
        iconSize: [16, 16]
      });

      userLocationMarker = L.marker([userLocation.lat, userLocation.lng], { icon: divIcon }).addTo(map);
    }

    function recomputeDistances() {
      if (!userLocation) return;
      stores.forEach(store => {
        const km = haversineDistance(userLocation.lat, userLocation.lng, store.Latitude, store.Longitude);
        store.Distance_From_User = km;
      });
    }

    function haversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const toRad = d => (d * Math.PI) / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return Math.round(R * c * 100) / 100;
    }

    function initList() {
      const searchInput = document.getElementById("search-input");
      const sortSelect = document.getElementById("sort-select");
      const filterChips = document.querySelectorAll(".filter-chip[data-filter]");

      // Sync tour-only manual sort option BEFORE setting the select value.
      syncTourManualSortOption();
      // Set the sort select to the current active sort (default weeklySales) on initial load.
      sortSelect.value = activeSort;

      searchInput.addEventListener("input", () => {
        renderStoreList();
      });

      sortSelect.addEventListener("change", e => {
        activeSort = e.target.value;
        // If the user somehow selects manual when not available, fall back safely.
        if (activeSort === "manual" && !isTourManualSortAvailable()) {
          activeSort = tourMode ? "priority" : "weeklySales";
          sortSelect.value = activeSort;
        }
        renderStoreList();
        // After changing sort, scroll the page to the top so the user sees the start of the updated list.
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });

      filterChips.forEach(chip => {
        chip.addEventListener("click", () => {
          filterChips.forEach(c => c.classList.remove("filter-chip--active"));
          chip.classList.add("filter-chip--active");
          activeFilter = chip.getAttribute("data-filter");
          // 重新渲染列表
          renderStoreList();
          // 選擇篩選條件後，自動捲動至頂端
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
      });

      renderStoreList();
    }

    function renderStoreList() {
      const container = document.getElementById("store-list");
      container.innerHTML = "";

      const searchText = document.getElementById("search-input").value.trim();
      let filtered = [...stores];

      if (activeTab === "alerts") {
        filtered = filtered.filter(
          s => s.Alert_Level === "critical" || s.Alert_Level === "warning"
        );
      } else if (activeTab === "nearby" && userLocation) {
        filtered = filtered.filter(s => s.Distance_From_User != null && s.Distance_From_User <= 20);
      }

      if (activeFilter === "critical") {
        filtered = filtered.filter(s => s.Alert_Level === "critical");
      } else if (activeFilter === "warning") {
        filtered = filtered.filter(s => s.Alert_Level === "warning");
      } else if (activeFilter === "green") {
        // 綠燈：篩選正常狀態的門市（非紅燈、黃燈）
        filtered = filtered.filter(s => s.Alert_Level === "normal");
      } else if (activeFilter === "undone") {
        filtered = filtered.filter(s => !s.__done);
      } else if (activeFilter === "done") {
        filtered = filtered.filter(s => s.__done);
      }

      if (searchText) {
        const lower = searchText.toLowerCase();
        filtered = filtered.filter(
          s =>
            s.Store_Name.toLowerCase().includes(lower) ||
            s.Store_ID.toLowerCase().includes(lower)
        );
      }

      // Apply tour mode route filter if active
      if (tourMode && selectedRoute) {
        filtered = filtered.filter(s => s.Route_Code === selectedRoute);
      }
      // Apply region filter if set (門市分佈)
      if (currentRegionFilter && currentRegionFilter !== "") {
        filtered = filtered.filter(s => {
          const region = normalizeRegion(s.Region || '');
          const selected = normalizeRegion(currentRegionFilter || '');
          return region === selected;
        });
      }

      // Tour-only manual ordering (drag-and-drop). When enabled, order stores by the
      // persisted route order and DO NOT apply any automatic sort.
      if (activeSort === "manual" && isTourManualSortAvailable()) {
        const order = ensureTourOrder(selectedRoute).map(String);
        const pos = new Map(order.map((id, i) => [id, i]));
        filtered.sort((a, b) => {
          const ia = pos.get(String(a.Store_ID));
          const ib = pos.get(String(b.Store_ID));
          const pa = ia == null ? 1e9 : ia;
          const pb = ib == null ? 1e9 : ib;
          return pa - pb;
        });
      } else {
        filtered.sort((a, b) => {
        if (activeSort === "severity") {
          const weight = level => (level === "critical" ? 2 : level === "warning" ? 1 : 0);
          const diff = weight(b.Alert_Level) - weight(a.Alert_Level);
          if (diff !== 0) return diff;
          const daysA = a.ZTR_Days || 0;
          const daysB = b.ZTR_Days || 0;
          if (daysB !== daysA) return daysB - daysA;
          return b.Weekly_Sales - a.Weekly_Sales;
        } else if (activeSort === "weeklySales") {
          // Primary sort by weekly sales (descending). When sales are equal,
          // sort by weekly growth rate (descending) so that stores with
          // higher growth appear higher in the list.
          const salesDiff = (b.Weekly_Sales || 0) - (a.Weekly_Sales || 0);
          if (salesDiff !== 0) return salesDiff;
          return (b.Weekly_Growth_Rate || 0) - (a.Weekly_Growth_Rate || 0);
        } else if (activeSort === "distance") {
          const da = a.Distance_From_User ?? Infinity;
          const db = b.Distance_From_User ?? Infinity;
          return da - db;
        } else if (activeSort === "storeId") {
          // When sorting by storeId treat numeric and string IDs consistently and allow numeric comparison for correct ordering.
          const idA = a.Store_ID != null ? String(a.Store_ID) : "";
          const idB = b.Store_ID != null ? String(b.Store_ID) : "";
          return idA.localeCompare(idB, undefined, { numeric: true });
        } else if (activeSort === "priority") {
          return b.__priority - a.__priority;
        }
        return 0;
        });
      }

      filtered.forEach((store, idx) => {
        const card = createStoreCard(store);
        // Set a CSS custom property so each card can stagger its entrance animation
        card.style.setProperty('--i', idx);
        container.appendChild(card);
      });

      // Enable drag-and-drop reordering only in tour-mode manual sort.
      if (activeSort === "manual" && isTourManualSortAvailable()) {
        enableTourDragSorting(container);
      }

      // Enable drag sorting only when tour manual sort is active and a route is selected.
      if (activeSort === "manual" && isTourManualSortAvailable()) {
        enableTourDragSort(container);
      }

      if (!activeStoreId && filtered.length > 0) {
        focusStoreOnMap(filtered[0].Store_ID);
        if (isDesktop()) {
          openStoreDetail(filtered[0].Store_ID);
        }
      } else {
        highlightActiveCard();
      }
    }

    function createStoreCard(store) {
      const card = document.createElement("div");
      card.className = "store-card";
      card.dataset.storeId = store.Store_ID;

      const left = document.createElement("div");
      left.className = "store-card-left";

      const nameRow = document.createElement("div");
      nameRow.className = "store-name-row";

      const dot = document.createElement("div");
      dot.className = "status-dot status-dot--" + (store.Alert_Level || "normal");

      const nameSpan = document.createElement("div");
      nameSpan.className = "store-name";
      nameSpan.textContent = store.Store_Name;

      nameRow.appendChild(dot);
      nameRow.appendChild(nameSpan);

      if (store.__done) {
        const doneSpan = document.createElement("span");
        doneSpan.className = "store-done-tag";
        doneSpan.textContent = "✓";
        nameRow.appendChild(doneSpan);
      }

      const meta = document.createElement("div");
      meta.className = "store-meta";
      meta.textContent = `${store.Route_Code} · ${store.Sales_Rep_Name}(${store.Sales_Rep_ID})`;

      const distance = document.createElement("div");
      distance.className = "store-distance";
      if (store.Distance_From_User != null) {
        distance.textContent = `距離 ${store.Distance_From_User.toFixed(1)} km · ${store.Region}`;
      } else {
        distance.textContent = store.Region;
      }

      left.appendChild(nameRow);
      left.appendChild(meta);
      left.appendChild(distance);

      const center = document.createElement("div");
      center.className = "store-card-center";

      const label = document.createElement("div");
      label.className = "weekly-sales-label";
      label.textContent = "WEEKLY SALES";

      const value = document.createElement("div");
      value.className = "weekly-sales-value weekly-sales--" + store.__salesColor;
      value.textContent = store.Weekly_Sales;
      // 直接設定文字顏色，避免在淺色模式下被父元素覆寫
      value.style.color = getPinColor(store.__salesColor);

      const trend = document.createElement("div");
      trend.className = "weekly-sales-trend";
      const growthPercent = (store.Weekly_Growth_Rate * 100).toFixed(1) + "%";
      if (store.Weekly_Growth_Rate >= 0) {
        // 上漲：紅色箭頭
        trend.classList.add("weekly-sales-trend-up");
        trend.textContent = `▲ ${growthPercent}`;
        // 直接將顏色設置為紅色，並以 !important 覆蓋其他樣式
        trend.style.setProperty('color', '#ef4444', 'important');
      } else {
        // 下跌：綠色箭頭
        trend.classList.add("weekly-sales-trend-down");
        trend.textContent = `▼ ${growthPercent}`;
        trend.style.setProperty('color', '#10b981', 'important');
      }

      const row = document.createElement("div");
      row.className = "weekly-sales-row";
      row.appendChild(value);
      row.appendChild(trend);

      const pills = document.createElement("div");
      pills.className = "metric-pills";

      const pillPSD = document.createElement("div");
      pillPSD.className = "metric-pill";
      pillPSD.innerHTML = `<span>PSD</span><strong>${store.PSD_Value}</strong>`;

      const pillInv = document.createElement("div");
      pillInv.className = "metric-pill";
      pillInv.innerHTML = `<span>庫存</span><strong>${store.Current_Inventory}</strong>`;

      pills.appendChild(pillPSD);
      pills.appendChild(pillInv);

      if (store.ZTR_Status && store.ZTR_Days) {
        const pillZTR = document.createElement("div");
        pillZTR.className = "metric-pill";
        pillZTR.innerHTML = `<span>ZTR</span><strong>${store.ZTR_Days}天</strong>`;
        pills.appendChild(pillZTR);
      }

      center.appendChild(label);
      center.appendChild(row);
      center.appendChild(pills);

      // 移除柱狀小圖示：不再顯示 sparkline

      // Priority score bar and label
      if (store.__priority != null) {
        const priorityContainer = document.createElement("div");
        priorityContainer.className = "priority-container";
        const barContainer = document.createElement("div");
        barContainer.className = "priority-bar";
        const progress = document.createElement("div");
        progress.className = "priority-progress";
        progress.style.width = store.__priority + "%";
        barContainer.appendChild(progress);
        const labelEl = document.createElement("div");
        labelEl.className = "priority-label";
        labelEl.textContent = `優先度 ${store.__priority}`;
        priorityContainer.appendChild(barContainer);
        priorityContainer.appendChild(labelEl);
        center.appendChild(priorityContainer);
      }

      const right = document.createElement("div");
      right.className = "store-card-right";

      const icons = document.createElement("div");
      icons.className = "action-icons";

      // Drag handle (tour mode manual ordering). This is only shown when the
      // user explicitly chooses "手動排序（拖曳）" while in tour mode with a route selected.
      if (activeSort === "manual" && isTourManualSortAvailable()) {
        const dragHandle = document.createElement("button");
        dragHandle.type = "button";
        dragHandle.className = "icon-button drag-handle";
        dragHandle.title = "拖曳排序";
        dragHandle.setAttribute("aria-label", "拖曳排序");
        dragHandle.textContent = "≡";
        // Prevent opening the detail panel when interacting with the handle.
        dragHandle.addEventListener("click", e => e.stopPropagation());
        icons.appendChild(dragHandle);
      }

      const btnNav = document.createElement("button");
      btnNav.className = "icon-button";
      // 統一導航圖示：採用內嵌 SVG，與其他 icon 尺寸一致
      btnNav.innerHTML = '<svg class="icon-svg" viewBox="0 0 24 24"><path d="M3 11l19-9-9 19-2-8-8-2z"/></svg>';
      btnNav.title = "導航";
      btnNav.addEventListener("click", e => {
        e.stopPropagation();
        handleNavigate(store);
      });

      const btnTruck = document.createElement("button");
      btnTruck.className = "icon-button";
      // 統一代送商通知圖示：使用 bell 形狀
      btnTruck.innerHTML = '<svg class="icon-svg" viewBox="0 0 24 24"><path d="M18 8a6 6 0 0 0-12 0c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>';
      btnTruck.title = "配送 / 補貨動作";
      btnTruck.addEventListener("click", e => {
        e.stopPropagation();
        openNotifyModal(store);
      });

      // 新增：地圖按鈕，點擊後開啟浮動地圖視窗
      const btnMap = document.createElement("button");
      btnMap.className = "icon-button";
      // 使用放大鏡圖示取代地圖圖示，增加直覺性
      btnMap.innerHTML = "🔍";
      btnMap.title = "顯示地圖";
      btnMap.addEventListener("click", e => {
        e.stopPropagation();
        openMapOverlay(store, card);
      });

      icons.appendChild(btnNav);
      icons.appendChild(btnTruck);
      icons.appendChild(btnMap);

      const tag = document.createElement("div");
      tag.className = "tag";
      if (store.Alert_Level === "critical") {
        tag.textContent = `🔴 ${store.Alert_Type}`;
      } else if (store.Alert_Level === "warning") {
        tag.textContent = `🟡 ${store.Alert_Type || "注意"}`;
      } else {
        // 將標籤文字設為正常或已處理，同時根據 __done 狀態加入樣式類別
        tag.textContent = store.__done ? "✅ 已處理" : "✅ 正常";
        if (store.__done) {
          tag.classList.add("tag-done");
        }
      }

      right.appendChild(icons);
      right.appendChild(tag);

      card.appendChild(left);
      card.appendChild(center);
      card.appendChild(right);

      // Card click: focus on map and open detail view on all devices
      card.addEventListener("click", () => {
        focusStoreOnMap(store.Store_ID);
        openStoreDetail(store.Store_ID);
      });

      return card;
    }

    // --- Drag-and-drop sorting for Tour Mode (manual ordering) ---
    let tourDragState = null;

    function enableTourDragSorting(container) {
      if (!container) return;
      const handles = container.querySelectorAll('.drag-handle');
      handles.forEach(handle => {
        // Avoid double binding when re-rendering
        if (handle.dataset.bound === "1") return;
        handle.dataset.bound = "1";
        handle.addEventListener('pointerdown', (ev) => {
          const card = handle.closest('.store-card');
          if (!card) return;
          startTourDrag(ev, card, container);
        });
      });
    }

    function startTourDrag(ev, card, container) {
      if (activeSort !== "manual" || !isTourManualSortAvailable()) return;
      // Only left-click / primary touch
      if (ev.button != null && ev.button !== 0) return;
      ev.preventDefault();
      ev.stopPropagation();

      const rect = card.getBoundingClientRect();
      const placeholder = document.createElement('div');
      placeholder.className = 'store-card-placeholder';
      placeholder.style.height = rect.height + 'px';

      // Insert placeholder where the card currently is
      container.insertBefore(placeholder, card);

      // Move the card to body and position it fixed for smooth dragging
      const offsetY = ev.clientY - rect.top;
      const offsetX = ev.clientX - rect.left;
      card.classList.add('store-card--dragging');
      card.style.width = rect.width + 'px';
      card.style.position = 'fixed';
      card.style.left = rect.left + 'px';
      card.style.top = rect.top + 'px';
      card.style.zIndex = '9999';
      card.style.pointerEvents = 'none';
      document.body.appendChild(card);
      document.body.classList.add('dragging');

      tourDragState = {
        pointerId: ev.pointerId,
        card,
        container,
        placeholder,
        offsetY,
        offsetX,
        lastY: ev.clientY
      };

      window.addEventListener('pointermove', onTourDragMove, { passive: false });
      window.addEventListener('pointerup', onTourDragEnd, { passive: false });
      window.addEventListener('pointercancel', onTourDragEnd, { passive: false });
    }

    function onTourDragMove(ev) {
      if (!tourDragState || ev.pointerId !== tourDragState.pointerId) return;
      ev.preventDefault();

      const { card, container, placeholder, offsetY, offsetX } = tourDragState;
      tourDragState.lastY = ev.clientY;

      // Move dragged card
      card.style.top = (ev.clientY - offsetY) + 'px';
      card.style.left = (ev.clientX - offsetX) + 'px';

      // Reposition placeholder based on pointer Y
      const y = ev.clientY;
      const candidates = Array.from(container.children).filter(el => el !== placeholder);
      let inserted = false;
      for (const el of candidates) {
        const r = el.getBoundingClientRect();
        const mid = r.top + r.height / 2;
        if (y < mid) {
          container.insertBefore(placeholder, el);
          inserted = true;
          break;
        }
      }
      if (!inserted) {
        container.appendChild(placeholder);
      }

      // Auto-scroll the list container when near its edges
      const cr = container.getBoundingClientRect();
      const edge = 48;
      if (y < cr.top + edge) {
        container.scrollTop -= 12;
      } else if (y > cr.bottom - edge) {
        container.scrollTop += 12;
      }
    }

    function onTourDragEnd(ev) {
      if (!tourDragState || (ev.pointerId != null && ev.pointerId !== tourDragState.pointerId)) return;
      ev.preventDefault();

      window.removeEventListener('pointermove', onTourDragMove);
      window.removeEventListener('pointerup', onTourDragEnd);
      window.removeEventListener('pointercancel', onTourDragEnd);

      const { card, container, placeholder } = tourDragState;

      // Place the card back into the list at the placeholder position
      container.insertBefore(card, placeholder);
      placeholder.remove();

      // Reset styles
      card.classList.remove('store-card--dragging');
      card.style.position = '';
      card.style.left = '';
      card.style.top = '';
      card.style.width = '';
      card.style.zIndex = '';
      card.style.pointerEvents = '';
      document.body.classList.remove('dragging');

      // Persist the order for this route
      persistTourOrderFromDOM(container);
      tourDragState = null;
    }

    function persistTourOrderFromDOM(container) {
      if (!isTourManualSortAvailable()) return;
      const visibleOrder = Array.from(container.querySelectorAll('.store-card')).map(el => String(el.dataset.storeId || ""))
        .filter(Boolean);
      const fullOrder = ensureTourOrder(selectedRoute).map(String);
      const visibleSet = new Set(visibleOrder);
      let vi = 0;
      const merged = fullOrder.map(id => (visibleSet.has(id) ? visibleOrder[vi++] : id));
      // Append any new IDs not yet in fullOrder
      for (const id of visibleOrder) {
        if (!merged.includes(id)) merged.push(id);
      }
      writeTourOrder(selectedRoute, merged);
    }

    function focusStoreOnMap(storeId) {
      // 在移動裝置點擊門市時，自動捲動至頁面頂端，確保 header 及列表不被遮擋
      try {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } catch (err) {
        /* ignore */
      }
      activeStoreId = storeId;
      highlightActiveCard();
      highlightMarkers(storeId);
      const store = stores.find(s => s.Store_ID === storeId);
      if (!store || !map || !markers[storeId]) {
        return;
      }
      // 不再在行動裝置上自動展開地圖；僅更新路線折線
      drawRoutePolyline(store.Route_Code);
    }

    function openStoreDetail(storeId) {
      const store = stores.find(s => s.Store_ID === storeId);
      if (!store) return;
      if (isDesktop()) {
        renderDetailDesktop(store);
        scrollMapAndDetailIntoView();
      } else {
        renderDetailMobile(store);
      }
    }

    function highlightActiveCard() {
      const cards = document.querySelectorAll(".store-card");
      cards.forEach(card => {
        if (card.dataset.storeId === String(activeStoreId)) {
          card.classList.add("store-card--active");
          card.scrollIntoView({ block: "nearest" });
        } else {
          card.classList.remove("store-card--active");
        }
      });
    }

    function scrollMapAndDetailIntoView() {
      const mapPanel = document.getElementById('panel-map');
      if (mapPanel) {
        mapPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    // ----------------------------------------------
    // Helper functions for war mode and marker highlighting
    // ----------------------------------------------

    // Determine arrow size class based on weekly growth rate
    function getArrowClass(rate) {
      const abs = Math.abs(rate || 0);
      let size = "small";
      if (abs >= 0.2) size = "large";
      else if (abs >= 0.1) size = "medium";
      const dir = rate >= 0 ? "up" : "down";
      return `${dir}-${size}`;
    }

    // Create a custom war marker with the store name and growth arrow
    function createWarMarker(store) {
      const circleColor = getPinColor(store.__salesColor);
      const arrowClass = getArrowClass(store.Weekly_Growth_Rate);
      // Calculate growth value and formatting
      const rate = store.Weekly_Growth_Rate || 0;
      const pct = Math.abs(rate * 100).toFixed(1);
      const sign = rate >= 0 ? '+' : '-';
      // 正負增減色彩：正成長用綠色，負成長用紅色
      const color = rate >= 0 ? 'var(--success)' : 'var(--danger)';
      const html = `
        <div class="war-marker">
          <div class="war-marker-circle" style="background:${circleColor}"></div>
          <div class="war-marker-name">${store.Store_Name}</div>
          <div class="war-arrow ${arrowClass}"></div>
          <span class="war-growth-value" style="color:${color}">${sign}${pct}%</span>
        </div>
      `;
      const icon = L.divIcon({ html: html.trim(), className: "", iconSize: null });
      const m = L.marker([store.Latitude, store.Longitude], { icon: icon });
      // 點擊戰情地圖標記時不立即開啟詳細視窗，而是顯示彈出小卡
      m.on("click", () => {
        handleWarMarkerClick(store);
      });
      return m;
    }

    // Show war markers on the map and hide original circle markers
    function showWarMarkers() {
      // Create war markers if not already created
      if (Object.keys(warMarkers).length === 0) {
        stores.forEach(s => {
          const wm = createWarMarker(s);
          warMarkers[s.Store_ID] = wm;
          wm.addTo(map);
        });
      } else {
        Object.values(warMarkers).forEach(m => {
          if (!map.hasLayer(m)) m.addTo(map);
        });
      }
      // Hide original circle markers
      Object.keys(markers).forEach(id => {
        const m = markers[id];
        if (m) {
          m.setStyle({ opacity: 0, fillOpacity: 0 });
        }
      });
    }

    // Hide war markers and restore original circle markers
    function hideWarMarkers() {
      Object.keys(warMarkers).forEach(id => {
        const m = warMarkers[id];
        if (m && map.hasLayer(m)) {
          map.removeLayer(m);
        }
      });
      // Restore original markers
      Object.keys(markers).forEach(id => {
        const m = markers[id];
        if (m) {
          m.setStyle({ opacity: 1, fillOpacity: 0.85 });
        }
      });
    }

    // Highlight both original and war markers for the active store
    function highlightMarkers(storeId) {
      // reset circle markers to default
      Object.keys(markers).forEach(id => {
        const m = markers[id];
        if (m) {
          const isHidden = m.options.opacity === 0;
          m.setStyle({
            radius: 7,
            weight: 1,
            color: "#020617",
            fillOpacity: isHidden ? 0 : 0.85,
            opacity: isHidden ? 0 : 1
          });
        }
      });
      // reset war markers highlight
      Object.keys(warMarkers).forEach(id => {
        const wm = warMarkers[id];
        if (wm && wm._icon) {
          wm._icon.classList.remove("war-marker--active");
        }
      });
      // highlight selected circle marker
      const cm = markers[storeId];
      if (cm) {
        cm.setStyle({
          radius: 11,
          weight: 3,
          color: "#facc15",
          fillOpacity: 1,
          opacity: 1
        });
      }
      // highlight selected war marker
      const wmSel = warMarkers[storeId];
      if (wmSel && wmSel._icon) {
        wmSel._icon.classList.add("war-marker--active");
      }
    }

    // Initialise tour mode controls and route selection
    function initTourModeControls() {
      const tourBtn = document.getElementById("tour-switch");
      const routeSelect = document.getElementById("tour-route-select");
      if (!tourBtn || !routeSelect) return;
      // Populate route options
      const uniqueRoutes = Array.from(new Set(stores.map(s => s.Route_Code))).filter(r => r).sort();
      routeSelect.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "-- 選擇路線 --";
      routeSelect.appendChild(placeholder);
      uniqueRoutes.forEach(rc => {
        const opt = document.createElement("option");
        opt.value = rc;
        opt.textContent = rc;
        routeSelect.appendChild(opt);
      });
      routeSelect.value = "";
      routeSelect.addEventListener("change", e => {
        selectedRoute = e.target.value;
        // 根據是否有選擇路線來標示下拉選單反白提示
        if (routeSelect.value) {
          routeSelect.classList.add('highlight');
        } else {
          routeSelect.classList.remove('highlight');
        }
        if (tourMode) {
          drawRoutePolyline(selectedRoute);
          // When a route is selected in tour mode, automatically zoom the map
          if (selectedRoute) {
            zoomToRoute(selectedRoute);
          }
          // Tour-only manual sort option appears only when a route is selected
          syncTourManualSortOption();
          renderStoreList();
        }
      });
      tourBtn.addEventListener("click", () => {
        // 點擊巡店模式時，稍作延遲後捲動至頁面頂端
        setTimeout(() => {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }, 100);
        tourMode = !tourMode;
        // Indicate active state on the button
        tourBtn.classList.toggle("chip-button--active", tourMode);
        if (tourMode) {
          // deactivate war mode if it is currently active
          if (modeWar) {
            modeWar = false;
            document.body.classList.remove("mode-war");
            document.body.classList.remove("drawer-open");
            drawerOpen = false;
            hideWarMarkers();
            // reset map-mode button text
            const modeButtons = document.querySelectorAll("#mode-switch");
            modeButtons.forEach(b => {
              b.textContent = "🗺️ 地圖模式";
            });
          }
          routeSelect.style.display = "inline-block";
          // If a route was already selected before activating tour mode, zoom to its stores
          if (selectedRoute) {
            zoomToRoute(selectedRoute);
          }
          // 根據是否有選擇路線來標示下拉選單反白提示（巡店模式啟用時）
          if (selectedRoute) {
            routeSelect.classList.add('highlight');
          } else {
            routeSelect.classList.remove('highlight');
          }
        } else {
          routeSelect.style.display = "none";
          selectedRoute = "";
          drawRoutePolyline(null);
          // 巡店模式關閉時，移除 highlight 樣式
          routeSelect.classList.remove('highlight');
        }
        // Update the availability of the tour-only manual sort option
        syncTourManualSortOption();
        renderStoreList();
      });
    }

    // Initialise map collapse control on mobile
    function initMapCollapseControls() {
      const collapseBtn = document.getElementById("map-collapse-button");
      if (!collapseBtn) return;
      collapseBtn.addEventListener("click", () => {
        mapCollapsed = !mapCollapsed;
        document.body.classList.toggle("map-collapsed", mapCollapsed);
        collapseBtn.textContent = mapCollapsed ? "⬇ 展開" : "⬆ 收合";
      });
    }

    // Initialise map size toggle control on mobile. The button is located in the header and
    // toggles a class on the <body> to switch between a small preview map and a larger map.
    function initMapSizeToggle() {
      const sizeBtn = document.getElementById("map-size-toggle");
      if (!sizeBtn) return;
      sizeBtn.addEventListener("click", () => {
        mapExpanded = !mapExpanded;
        document.body.classList.toggle("map-expanded", mapExpanded);
        // Update button text accordingly
        sizeBtn.textContent = mapExpanded ? "🔍 縮小地圖" : "🔍 放大地圖";
      });
    }

    // Compute and zoom the map to fit all stores in a selected route.
    function zoomToRoute(route) {
      if (!route) return;
      const pts = stores
        .filter(s => s.Route_Code === route)
        .map(s => [s.Latitude, s.Longitude]);
      if (pts.length === 0) return;
      const bounds = L.latLngBounds(pts);
      map.fitBounds(bounds, { padding: [30, 30] });
    }

    function buildDetailInnerHTML(store) {
      const statusLabel =
        store.Alert_Level === "critical"
          ? "紅燈 · 嚴重"
          : store.Alert_Level === "warning"
          ? "黃燈 · 警示"
          : "綠燈 · 正常";

      const statusEmoji =
        store.Alert_Level === "critical"
          ? "🔴"
          : store.Alert_Level === "warning"
          ? "🟡"
          : "🟢";

      const patternText = store.Sales_Pattern || "—";
      const doneTag = store.__done
        ? '<span class="store-done-tag">✓ 已處理</span>'
        : "";

      return `
        <div class="detail-header">
          <div class="detail-title-row">
            <div class="detail-name">
              <div class="status-dot status-dot--${store.Alert_Level || "normal"}"></div>
              <span>${store.Store_Name}</span>
              ${doneTag}
            </div>
            <div class="detail-status-chip">
              ${statusEmoji} <span>${statusLabel}</span>
            </div>
          </div>
          <div class="detail-id">店號 ${store.Store_ID}</div>
          <div class="detail-sub">
            ${store.Route_Code} · ${store.Sales_Rep_Name}(${store.Sales_Rep_ID}) · ${store.Region}
          </div>
        </div>
        <div class="detail-content">
          <div class="detail-mini-kpis">
            <div class="mini-kpi-pill">
              <span>本週銷量</span>
              <strong>${store.Weekly_Sales}</strong>
            </div>
            <div class="mini-kpi-pill">
              <span>PSD</span>
              <strong>${store.PSD_Value}</strong>
            </div>
            <div class="mini-kpi-pill">
              <span>庫存</span>
              <strong>${store.Current_Inventory}</strong>
            </div>
          </div>

          <div class="detail-pattern-row">
            <span class="detail-pattern-label">銷售型態：</span>
            <span class="detail-pattern-value">${patternText}</span>
          </div>

          <div class="detail-map-section">
            <button class="detail-map-toggle" data-role="view-map">
              🔍 門市位置
            </button>
            <div class="detail-inline-map" data-map-slot="detail" style="display:none;">
              <div id="detail-map"></div>
            </div>
          </div>

          <div class="chart-section">
            <div class="chart-title">PSD Weekly flow（週一～週日）</div>
            <canvas data-chart-canvas="flow"></canvas>
          </div>

          <div class="chart-section">
            <div class="chart-title">銷售型態 · 平日 vs 假日</div>
            <canvas data-chart-canvas="pattern"></canvas>
          </div>

          <div class="detail-section">
            <div class="detail-section-row">
              <span>地址</span>
              <span>${store.Address}</span>
            </div>
            <div class="detail-section-row">
              <span>門市距離</span>
              <span>${store.Distance_From_User != null ? store.Distance_From_User.toFixed(2) + " km" : "尚未定位"}</span>
            </div>
            <div class="detail-section-row">
              <span>資料更新時間</span>
              <span>${store.Last_Update}</span>
            </div>
          </div>
        </div>
      `;
    }

    function renderDetailDesktop(store) {
      const container = document.getElementById("detail-container");
      const actions = document.getElementById("detail-actions");
      actions.style.display = "flex";
        container.innerHTML = buildDetailInnerHTML(store);
        // Move actions into the detail content area so they appear below charts
        const detailContent = container.querySelector(".detail-content");
        if (detailContent) {
          detailContent.appendChild(actions);
        } else {
          container.appendChild(actions);
        }
        actions.style.marginTop = "8px";
        actions.style.borderTop = "none";

      const btnNotify = document.getElementById("btn-notify");
      const btnNavigate = document.getElementById("btn-navigate");
      const btnDone = document.getElementById("btn-done");

      btnNotify.onclick = () => openNotifyModal(store);
      btnNavigate.onclick = () => handleNavigate(store);
      btnDone.onclick = () => handleMarkDone(store);

      if (store.__done) {
        btnDone.classList.add("btn-ghost-active");
      } else {
        btnDone.classList.remove("btn-ghost-active");
      }

      initCharts(container, store);
      initDetailMapToggle(container, store);
    }

    function renderDetailMobile(store) {
      // 隱藏戰情模式彈窗（若存在），以免與詳細頁重疊
      hideWarPopup();
      // Hide desktop actions when showing mobile bottom sheet
      const actionsEl = document.getElementById("detail-actions");
      if (actionsEl) actionsEl.style.display = "none";
      const sheet = document.getElementById("detail-bottom-sheet");
      const inner = document.getElementById("detail-bottom-inner");

      // 使用字元符號表示導航，避免圖片載入失敗
      inner.innerHTML = `
        ${buildDetailInnerHTML(store)}
        <div class="detail-actions detail-actions--sheet">
          <button class="btn btn-primary" data-role="notify">
            <svg class="icon-svg" viewBox="0 0 24 24"><path d="M18 8a6 6 0 0 0-12 0c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
            <span>通知代送商</span>
          </button>
          <button class="btn btn-secondary" data-role="navigate">
            <svg class="icon-svg" viewBox="0 0 24 24"><path d="M3 11l19-9-9 19-2-8-8-2z"/></svg>
            <span>導航</span>
          </button>
          <button class="btn btn-ghost" data-role="done">
            <svg class="icon-svg" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
            <span>標記已處理</span>
          </button>
        </div>
      `;

      const notifyBtn = inner.querySelector('[data-role="notify"]');
      const navBtn = inner.querySelector('[data-role="navigate"]');
      const doneBtn = inner.querySelector('[data-role="done"]');

      if (notifyBtn) notifyBtn.onclick = () => openNotifyModal(store);
      if (navBtn) navBtn.onclick = () => handleNavigate(store);
      if (doneBtn) {
        doneBtn.onclick = () => handleMarkDone(store);
        if (store.__done) {
          doneBtn.classList.add("btn-ghost-active");
        }
      }

      initCharts(sheet, store);
      initDetailMapToggle(sheet, store);
      openBottomSheet();
    }

    function initCharts(rootEl, store) {
      if (weeklyFlowChart) weeklyFlowChart.destroy();
      if (patternChart) patternChart.destroy();
      weeklyFlowChart = null;
      patternChart = null;

      renderWeeklyFlowChart(rootEl, store);
      renderPatternChart(rootEl, store);
    }

    function renderWeeklyFlowChart(rootEl, store) {
      const canvas = rootEl.querySelector('canvas[data-chart-canvas="flow"]');
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      if (weeklyFlowChart) weeklyFlowChart.destroy();

      const labels = ["週一", "週二", "週三", "週四", "週五", "週六", "週日"];
      const data = store.Weekly_Flow || [];

      // Determine theme-related colours.  In light theme use darker text and a
      // soft card background; in dark theme use muted greys.  The card
      // background will be passed into the customCanvasBackgroundColor plugin.
      const isLight = document.body.classList.contains('light-theme');
      const bgColor = isLight ? '#fff7eb' : '#020617';
      const xTickColor = isLight ? '#6b7280' : '#9ca3af';
      const yTickColor = isLight ? '#6b7280' : '#6b7280';
      const gridColor = isLight ? 'rgba(0,0,0,0.08)' : 'rgba(75,85,99,0.3)';

      weeklyFlowChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "PSD",
              data,
              borderColor: "#f97373",
              // Do not fill area under the line in light mode so that the
              // underlying beige background is visible.  In dark mode the
              // fill remains transparent as well for consistency.
              fill: false,
              borderWidth: 2,
              pointRadius: 4,
              pointHoverRadius: 6,
              pointBackgroundColor: "#f97373",
              tension: 0.3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'nearest', intersect: false },
          onClick: function(evt, activeEls) {
            // 點擊圖表時顯示該點的 PSD 值
            if (activeEls && activeEls.length > 0) {
              const el = activeEls[0];
              const chart = this;
              chart.tooltip.setActiveElements([
                { datasetIndex: el.datasetIndex, index: el.index }
              ], { x: evt.offsetX, y: evt.offsetY });
              chart.update();
            }
          },
          plugins: {
            // Apply the custom background plugin with the computed colour
            customCanvasBackgroundColor: { color: bgColor },
            legend: { display: false },
            tooltip: {
              enabled: true,
              mode: 'nearest',
              intersect: false,
              callbacks: {
                // 自訂提示內容，顯示 PSD 值
                label: function(context) {
                  const value = context.parsed.y;
                  return ` PSD：${value}`;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                color: xTickColor,
                font: { size: 10 }
              },
              grid: { display: false }
            },
            y: {
              ticks: {
                color: yTickColor,
                font: { size: 10 }
              },
              grid: {
                color: gridColor,
                borderDash: [4, 4]
              }
            }
          }
        }
      });
    }

    function renderPatternChart(rootEl, store) {
      const canvas = rootEl.querySelector('canvas[data-chart-canvas="pattern"]');
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      if (patternChart) patternChart.destroy();

      const wf = store.Weekly_Flow || [];
      const weekday = wf.slice(0, 4).reduce((s, v) => s + v, 0);
      const weekend = wf.slice(4).reduce((s, v) => s + v, 0);

      // Compute theme colours for the doughnut chart.  In light mode the
      // legend should use darker text and the plot area should be filled
      // with a soft beige; in dark mode fall back to existing colours.
      const isLight = document.body.classList.contains('light-theme');
      const bgColor = isLight ? '#fff7eb' : '#020617';
      const legendColor = isLight ? '#6b7280' : '#9ca3af';

      patternChart = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: ["平日（一～四）", "假日（五～日）"],
          datasets: [
            {
              data: [weekday, weekend],
              backgroundColor: ["#16a34a", "#ef4444"],
              borderWidth: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            customCanvasBackgroundColor: { color: bgColor },
            legend: {
              position: "bottom",
              labels: {
                color: legendColor,
                font: { size: 10 }
              }
            }
          },
          cutout: "55%"
        }
      });
    }

    function initDetailMapToggle(rootEl, store) {
      const btn = rootEl.querySelector(".detail-map-toggle");
      const mapWrap = rootEl.querySelector(".detail-inline-map");
      if (!btn || !mapWrap) return;

      btn.addEventListener("click", () => {
        const isOpen = mapWrap.style.display === "block";
        if (isOpen) {
          mapWrap.style.display = "none";
          btn.classList.remove("detail-map-toggle-active");
        } else {
          mapWrap.style.display = "block";
          btn.classList.add("detail-map-toggle-active");
          setTimeout(() => {
            renderDetailMap(store);
          }, 50);
        }
      });
    }

    function renderDetailMap(store) {
      const mapContainer = document.getElementById("detail-map");
      if (!mapContainer) return;

      if (detailMap) {
        detailMap.remove();
        detailMap = null;
      }

      detailMap = L.map("detail-map", {
        zoomControl: false,
        attributionControl: false
      }).setView([store.Latitude, store.Longitude], 12);

      L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
        {
          maxZoom: 19
        }
      ).addTo(detailMap);

      L.circleMarker([store.Latitude, store.Longitude], {
        radius: 7,
        fillColor: getPinColor(store.__salesColor),
        color: "#020617",
        weight: 1,
        opacity: 1,
        fillOpacity: 0.9
      }).addTo(detailMap);

      setTimeout(() => {
        detailMap.invalidateSize();
      }, 100);
    }

    function initTabs() {
      const tabMap = {
        hotspots: document.getElementById("tab-hotspots"),
        alerts: document.getElementById("tab-alerts"),
        distribution: document.getElementById("tab-distribution"),
        nearby: document.getElementById("tab-nearby")
      };

      Object.entries(tabMap).forEach(([key, btn]) => {
        // 分佈頁籤的點擊改為顯示區域下拉選單，由 initRegionFilterControls() 處理
        if (key === 'distribution') return;
        btn.addEventListener("click", () => {
          setActiveTab(key);
          // 切換頁籤時捲動至頂端
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
      });
    }

    function setActiveTab(tabKey) {
      activeTab = tabKey;
      ["hotspots", "alerts", "distribution", "nearby"].forEach(key => {
        const el = document.getElementById("tab-" + key);
        if (!el) return;
        if (key === tabKey) {
          el.classList.add("chip-button--active");
        } else {
          el.classList.remove("chip-button--active");
        }
      });

      if (tabKey === "hotspots") {
        activeSort = "weeklySales";
        document.getElementById("sort-select").value = "weeklySales";
      } else if (tabKey === "alerts") {
        activeSort = "severity";
        document.getElementById("sort-select").value = "severity";
      } else if (tabKey === "nearby") {
        activeSort = "distance";
        document.getElementById("sort-select").value = "distance";
      }

      renderStoreList();
    }

    function initModal() {
      const backdrop = document.getElementById("modal-backdrop");
      const cancelBtn = document.getElementById("modal-cancel");
      const confirmBtn = document.getElementById("modal-confirm");

      cancelBtn.addEventListener("click", () => {
        backdrop.classList.remove("modal-backdrop--show");
        modalOpen = false;
      });

      confirmBtn.addEventListener("click", () => {
        // 按下通知後，自動標記已處理並給予提示
        if (currentModalStore) {
          // 執行送出通知（示意），並標記已處理
          showToast(`已將門市【${currentModalStore.Store_Name}】異常通知傳送給 ${currentModalStore.Sales_Rep_ID} ${currentModalStore.Sales_Rep_Name}（模擬）`);
          handleMarkDone(currentModalStore);
        } else {
          showToast("已呼叫通知 API（目前為示意）");
        }
        backdrop.classList.remove("modal-backdrop--show");
        modalOpen = false;
      });
    }

    function openNotifyModal(store) {
      const backdrop = document.getElementById("modal-backdrop");
      const body = document.getElementById("modal-body");
      currentModalStore = store;
      body.innerHTML = `
        系統偵測：門市 <strong>${store.Store_Name}</strong> 庫存不足 / 異常狀態（${store.Alert_Type || "需留意"}）。<br/><br/>
        目前庫存 <strong>${store.Current_Inventory}</strong>，PSD <strong>${store.PSD_Value}</strong>。<br/>
        是否要發送 LINE 通知給代送商 <strong>${store.Sales_Rep_Name}</strong>？
      `;
      backdrop.classList.add("modal-backdrop--show");
      modalOpen = true;
      history.pushState({ modalOpen: true }, "");
    }

    function handleNavigate(store) {
      const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(
        store.Address
      )}`;
      window.open(url, "_blank");
    }

    function handleMarkDone(store) {
      store.__done = !store.__done;
      renderStoreList();

      // Update summary counts when marking done
      initSummary();

      if (isDesktop()) {
        renderDetailDesktop(store);
      } else {
        renderDetailMobile(store);
      }
    }

    function initBottomSheet() {
      const backdrop = document.getElementById("detail-bottom-backdrop");
      const sheet = document.getElementById("detail-bottom-sheet");
      const handle = document.getElementById("detail-bottom-handle");

      backdrop.addEventListener("click", () => {
        closeBottomSheet();
      });

      handle.addEventListener("click", () => {
        closeBottomSheet();
      });
    }

    function openBottomSheet() {
      const backdrop = document.getElementById("detail-bottom-backdrop");
      const sheet = document.getElementById("detail-bottom-sheet");
      backdrop.classList.add("detail-bottom-backdrop--show");
      sheet.classList.add("detail-bottom-sheet--open");
      if (!bottomSheetOpen) {
        bottomSheetOpen = true;
        history.pushState({ bottomSheetOpen: true }, "");
      }
    }

    function closeBottomSheet() {
      const backdrop = document.getElementById("detail-bottom-backdrop");
      const sheet = document.getElementById("detail-bottom-sheet");
      backdrop.classList.remove("detail-bottom-backdrop--show");
      sheet.classList.remove("detail-bottom-sheet--open");
      bottomSheetOpen = false;
      // 若目前仍處於戰情模式，且之前點擊過門市，則回復顯示戰情彈窗
      if (warOverlayOpen && lastWarPopupStore) {
        showWarPopup(lastWarPopupStore);
      }
    }

    function initFullTable() {
      const btnOpen = document.getElementById("btn-full-table");
      const backdrop = document.getElementById("table-backdrop");
      const btnClose = document.getElementById("table-close");
      const tableEl = document.getElementById("store-table");
      const regionSelect = document.getElementById("table-region-filter");
      const growthSelect = document.getElementById("table-growth-filter");
      const riskSelect = document.getElementById("table-risk-filter");

      if (!btnOpen || !backdrop || !btnClose || !tableEl || !regionSelect || !growthSelect || !riskSelect) return;

      // Populate region options
      const regions = [...new Set(stores.map(s => s.Region))].sort((a, b) =>
        a.localeCompare(b, "zh-Hant")
      );
      regionSelect.innerHTML =
        `<option value="all">全部縣市</option>` +
        regions.map(r => `<option value="${r}">${r}</option>`).join("");
      // Populate growth options
      growthSelect.innerHTML =
        `<option value="all">銷售漲跌</option>` +
        `<option value="up">銷售上漲</option>` +
        `<option value="down">銷售下降</option>`;
      // Populate risk options
      riskSelect.innerHTML =
        `<option value="all">庫存風險</option>` +
        `<option value="oos">缺貨</option>` +
        `<option value="expiry">過期</option>` +
        `<option value="slow">滯銷</option>` +
        `<option value="overstock">高庫存</option>`;

      regionSelect.addEventListener("change", () => {
        tableRegionFilter = regionSelect.value;
        renderFullTable(tableEl);
      });
      growthSelect.addEventListener("change", () => {
        tableGrowthFilter = growthSelect.value;
        renderFullTable(tableEl);
      });
      riskSelect.addEventListener("change", () => {
        tableRiskFilter = riskSelect.value;
        renderFullTable(tableEl);
      });

      btnOpen.addEventListener("click", () => {
        tableRegionFilter = "all";
        tableGrowthFilter = "all";
        tableRiskFilter = "all";
        regionSelect.value = "all";
        growthSelect.value = "all";
        riskSelect.value = "all";
        renderFullTable(tableEl);
        backdrop.classList.add("table-backdrop--show");
        tableOpen = true;
        history.pushState({ tableOpen: true }, "");
      });

      const closeTable = () => {
        backdrop.classList.remove("table-backdrop--show");
        tableOpen = false;
      };

      btnClose.addEventListener("click", () => {
        closeTable();
      });

      backdrop.addEventListener("click", e => {
        if (e.target === backdrop) {
          closeTable();
        }
      });
    }

    function renderFullTable(tableEl) {
      let data = stores.filter(s => {
        // Region filter
        if (tableRegionFilter !== "all" && s.Region !== tableRegionFilter) {
          return false;
        }
        // Growth filter: 'up' requires non-negative growth rate, 'down' requires negative growth
        if (tableGrowthFilter === "up" && s.Weekly_Growth_Rate < 0) {
          return false;
        }
        if (tableGrowthFilter === "down" && s.Weekly_Growth_Rate >= 0) {
          return false;
        }
        // Risk filter: match Alert_Type keywords
        if (tableRiskFilter !== "all") {
          const type = s.Alert_Type || '';
          if (tableRiskFilter === 'oos' && !type.includes('缺貨')) return false;
          if (tableRiskFilter === 'expiry' && !type.includes('過期')) return false;
          if (tableRiskFilter === 'slow' && !type.includes('滯銷')) return false;
          if (tableRiskFilter === 'overstock' && !type.includes('高庫存')) return false;
        }
      return true;
      });
      // 對資料進行排序
      if (tableSortBy) {
        if (tableSortBy === 'distance') {
          data.sort((a, b) => {
            const dA = (a.Distance_From_User != null ? a.Distance_From_User : Number.POSITIVE_INFINITY);
            const dB = (b.Distance_From_User != null ? b.Distance_From_User : Number.POSITIVE_INFINITY);
            return dA - dB;
          });
        } else if (tableSortBy === 'sales') {
          data.sort((a, b) => {
            return (b.Weekly_Sales || 0) - (a.Weekly_Sales || 0);
          });
        } else if (tableSortBy === 'growth') {
          data.sort((a, b) => {
            return (b.Weekly_Growth_Rate || 0) - (a.Weekly_Growth_Rate || 0);
          });
        }
      }

      tableEl.innerHTML = `
        <thead>
          <tr>
            <th class="col-name">門市</th>
            <th class="col-sales">WEEKLY SALES</th>
            <th class="col-trend">銷售漲跌</th>
            <th class="col-risk">庫存風險</th>
            <th class="col-ztr">ZTR 狀況</th>
          </tr>
        </thead>
        <tbody>
          ${data.map(fullTableRowHtml).join("")}
        </tbody>
      `;

      const rows = tableEl.querySelectorAll("tbody tr");
      const backdrop = document.getElementById("table-backdrop");

      rows.forEach(row => {
        row.addEventListener("click", () => {
          const id = row.getAttribute("data-store-id");
          if (!id) return;
          // Determine whether this table was opened from the region growth chart.
          const currentState = history.state || {};
          const fromRegion = currentState.regionChartOpen || currentState.regionFromChart;
          // Push a state so that pressing back will restore the table (or region chart) before returning to the list.
          history.pushState({ fromFullTable: true, regionFromChart: fromRegion }, "");
          focusStoreOnMap(id);
          openStoreDetail(id);
          backdrop.classList.remove("table-backdrop--show");
          tableOpen = false;
        });
      });
    }

    function fullTableRowHtml(store) {
      const growth = (store.Weekly_Growth_Rate * 100).toFixed(1);
      const isUp = store.Weekly_Growth_Rate >= 0;
      const trendClass = isUp ? "trend-positive" : "trend-negative";
      const arrow = isUp ? "▲" : "▼";
      const trendText = `${arrow} ${growth}%`;

      const riskLabel =
        store.Alert_Level === "critical"
          ? `🔴 ${store.Alert_Type || "嚴重"}`
          : store.Alert_Level === "warning"
          ? `🟡 ${store.Alert_Type || "警示"}`
          : store.__done
          ? "✅ 已處理"
          : "✅ 正常";
      const ztrText = store.ZTR_Status
        ? `ZTR ${store.ZTR_Days || 0} 天`
        : "—";

      return `
        <tr data-store-id="${store.Store_ID}">
          <td class="col-name">${store.Store_Name}</td>
          <td class="col-sales">${store.Weekly_Sales}</td>
          <td class="col-trend ${trendClass}">${trendText}</td>
          <td class="col-risk">${riskLabel}</td>
          <td class="col-ztr">${ztrText}</td>
        </tr>
      `;
    }

    function initScrollTopButton() {
      if (!scrollTopBtn) return;

      const listBody = document.querySelector("#panel-list .panel-body");

      // If the user hasn't used the scroll-to-top button before, apply a breathing animation
      if (!localStorage.getItem("scrollTopUsed")) {
        scrollTopBtn.classList.add("unused");
      } else {
        scrollTopBtn.classList.remove("unused");
      }

      function handleScrollVisibility() {
        const listScrollTop = listBody ? listBody.scrollTop : 0;
        const winScrollTop =
          window.pageYOffset || document.documentElement.scrollTop || 0;

        if (listScrollTop > 200 || winScrollTop > 200) {
          scrollTopBtn.style.display = "flex";
        } else {
          scrollTopBtn.style.display = "none";
        }
      }

      window.addEventListener("scroll", handleScrollVisibility);
      if (listBody) {
        listBody.addEventListener("scroll", handleScrollVisibility);
      }

      scrollTopBtn.addEventListener("click", () => {
        const listBody = document.querySelector("#panel-list .panel-body");
        if (listBody) {
          listBody.scrollTo({ top: 0, behavior: "smooth" });
        }
        window.scrollTo({ top: 0, behavior: "smooth" });
        // User has used the button; remove breathing animation and remember in localStorage
        scrollTopBtn.classList.remove("unused");
        localStorage.setItem("scrollTopUsed", "true");
      });

      handleScrollVisibility();
    }

    // Initialize war-room controls and map toggles
    function initWarModeControls() {
      // Bind events to war-mode toggle buttons (duplicate IDs may exist)
      const modeBtns = document.querySelectorAll("#mode-switch");
      modeBtns.forEach(btn => {
        btn.addEventListener("click", () => {
          modeWar = !modeWar;
          document.body.classList.toggle("mode-war", modeWar);
          // When entering war mode ensure a base tile layer is visible.
          // Some users reported that the war-mode map only shows colored dots on a dark background.
          // To fix this we explicitly add the dark tile layer when in war mode and restore the light layer when leaving.
          if (modeWar) {
            if (darkLayer && !map.hasLayer(darkLayer)) {
              // Remove light layer if present
              if (lightLayer && map.hasLayer(lightLayer)) {
                map.removeLayer(lightLayer);
              }
              darkLayer.addTo(map);
            }
          } else {
            if (lightLayer && !map.hasLayer(lightLayer)) {
              // Remove dark layer if present
              if (darkLayer && map.hasLayer(darkLayer)) {
                map.removeLayer(darkLayer);
              }
              lightLayer.addTo(map);
            }
          }
          if (modeWar) {
            // Entering war mode: open the list drawer by default and show war markers
            document.body.classList.add("drawer-open");
            drawerOpen = true;
            showWarMarkers();
          } else {
            // Leaving war mode: close drawer and hide war markers
            document.body.classList.remove("drawer-open");
            drawerOpen = false;
            hideWarMarkers();
          }
          // update text on all mode buttons
          modeBtns.forEach(b => {
            b.textContent = modeWar ? "標準模式" : "戰情模式";
          });
          // 在切換模式後重新計算地圖尺寸，避免容器大小變化導致地圖顯示異常
          setTimeout(() => {
            if (typeof map !== 'undefined' && map) {
              map.invalidateSize();
            }
          }, 100);
        });
      });
      // Drawer button(s)
      const drawerBtns = document.querySelectorAll("#drawer-toggle-button");
      drawerBtns.forEach(btn => {
        btn.addEventListener("click", () => {
          // If not in war mode, open the region growth chart instead of the full table
          if (!modeWar) {
            openRegionChart();
            return;
          }
          // In war mode: toggle the drawer open/close as before
          drawerOpen = !drawerOpen;
          document.body.classList.toggle("drawer-open", drawerOpen);
        });
      });
const baseBtn = document.getElementById("base-toggle-button");
      if (baseBtn) {
        baseBtn.addEventListener("click", () => {
          if (currentBase === "light") {
            if (lightLayer) map.removeLayer(lightLayer);
            if (darkLayer) darkLayer.addTo(map);
            currentBase = "dark";
          } else {
            if (darkLayer) map.removeLayer(darkLayer);
            if (lightLayer) lightLayer.addTo(map);
            currentBase = "light";
          }
        });
      }
      const heatBtn = document.getElementById("heat-toggle-button");
      if (heatBtn) {
        heatBtn.addEventListener("click", () => {
          // If no heat circles drawn, create them
          if (heatLayer.length === 0) {
            // Determine maximum weekly sales to normalize intensity
            const maxSales = Math.max(...stores.map(s => s.Weekly_Sales || 1));
            stores.forEach(store => {
              const intensity = Math.max(store.Weekly_Sales || 1, 1) / maxSales;
              // Larger radius for bigger impact; adjust to kilometers (~5000 m)
              const circle = L.circle([store.Latitude, store.Longitude], {
                radius: 5000,
                color: 'transparent',
                fillColor: '#f97373',
                fillOpacity: Math.min(intensity * 2, 1)
              });
              circle.addTo(map);
              heatLayer.push(circle);
            });
            // Hide the regular circle markers while heat layer is active
            Object.values(markers).forEach(m => m.setStyle({ opacity: 0, fillOpacity: 0 }));
          } else {
            // Remove custom heat circles and restore markers
            heatLayer.forEach(c => map.removeLayer(c));
            heatLayer = [];
            setMapFilter(activeFilter);
          }
        });
      }
    }

    function getSalesColorByPercentile(p) {
      if (p <= 0.1) return "pink";
      if (p <= 0.25) return "red";
      if (p <= 0.4) return "orange";
      if (p <= 0.6) return "yellow";
      if (p <= 0.75) return "green";
      if (p <= 0.9) return "blue";
      return "gray";
    }

    function getPinColor(key) {
      switch (key) {
        case "pink": return "#fb7185";
        case "red": return "#f97373";
        case "orange": return "#fb923c";
        case "yellow": return "#facc15";
        case "green": return "#34d399";
        case "blue": return "#60a5fa";
        case "gray": return "#9ca3af";
        default: return "#6b7280";
      }
    }

    // Compute a simple priority score (0–100) based on PSD, inventory, ZTR and growth
    function computePriority(store) {
      let score = 0;
      // Risk of out-of-stock: low inventory relative to PSD value
      if (store.PSD_Value != null && store.PSD_Value > 0 && store.Current_Inventory != null) {
        const ratio = store.Current_Inventory / store.PSD_Value;
        if (ratio < 1) {
          score += (1 - ratio) * 40;
        }
        // Oversupply risk: very high inventory relative to PSD
        if (ratio > 2) {
          score += (Math.min(ratio, 5) - 2) * 20;
        }
      }
      // ZTR risk: more days without sale increases priority
      if (store.ZTR_Status && store.ZTR_Days) {
        score += Math.min(store.ZTR_Days / 7, 1) * 30;
      }
      // Negative growth increases priority (falling sales)
      if (store.Weekly_Growth_Rate < 0) {
        score += Math.min(-store.Weekly_Growth_Rate * 50, 20);
      }
      // Ensure within [0,100] and integer
      return Math.round(Math.min(score, 100));
    }

    // Display a toast message at top-right
    function showToast(message) {
      const container = document.getElementById("toast-container");
      if (!container) return;
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.textContent = message;
      container.appendChild(toast);
      // Trigger transition
      requestAnimationFrame(() => {
        toast.classList.add("show");
      });
      // Hide after 3 seconds
      setTimeout(() => {
        toast.classList.remove("show");
        setTimeout(() => {
          if (toast.parentElement === container) {
            container.removeChild(toast);
          }
        }, 300);
      }, 3000);
    }

    // Draw 5km and 10km circles around user location to aid spatial awareness
    function drawHereCircles() {
      if (!map || !userLocation) return;
      // remove existing circles
      if (hereCircles && hereCircles.length) {
        hereCircles.forEach(c => map.removeLayer(c));
      }
      hereCircles = [];
      const radii = [5000, 10000];
      radii.forEach(rad => {
        const circle = L.circle([userLocation.lat, userLocation.lng], {
          radius: rad,
          color: "#38bdf8",
          weight: 1,
          fillOpacity: 0,
          dashArray: "4 4"
        }).addTo(map);
        hereCircles.push(circle);
      });
    }

    // Update marker visibility based on distance to user (within 10km remains bright)
    function updateNearbyVisibility() {
      if (!map) return;
      stores.forEach(store => {
        const marker = markers[store.Store_ID];
        if (!marker) return;
        if (!userLocation || store.Distance_From_User == null) {
          marker.setStyle({ opacity: 1, fillOpacity: 0.85 });
        } else if (store.Distance_From_User <= 10) {
          marker.setStyle({ opacity: 1, fillOpacity: 0.9 });
        } else {
          marker.setStyle({ opacity: 0.3, fillOpacity: 0.3 });
        }
      });
    }

    // Draw a polyline connecting stores of a given route code
    function drawRoutePolyline(routeCode) {
      if (!map) return;
      // Remove existing polyline
      if (routePolyline) {
        map.removeLayer(routePolyline);
        routePolyline = null;
      }
      if (!routeCode) return;
      const routeStores = stores.filter(s => s.Route_Code === routeCode);
      if (routeStores.length < 2) return;
      // Sort route stores roughly north-to-south or by store ID
      routeStores.sort((a, b) => {
        // sort by latitude descending then longitude ascending
        if (a.Latitude !== b.Latitude) return b.Latitude - a.Latitude;
        return a.Longitude - b.Longitude;
      });
      const latlngs = routeStores.map(s => [s.Latitude, s.Longitude]);
      routePolyline = L.polyline(latlngs, {
        color: "#38bdf8",
        weight: 2,
        opacity: 0.7,
        dashArray: "4 2"
      }).addTo(map);
    }
    // --- 浮動地圖視窗功能 ---
    let overlayMap = null;
    let overlayMarker = null;
    let overlayHeatCircles = [];
    let overlayCurrentBase = 'light';
    // Keep track of temporary markers added to the overlay map (for other stores)
    let overlayMarkers = [];

    function openMapOverlay(store, card) {
      const overlayEl = document.getElementById('map-overlay');
      const rect = card.getBoundingClientRect();
      const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
      // Reset positioning
      overlayEl.style.top = '';
      overlayEl.style.bottom = '';
      if (rect.top > viewportHeight / 2) {
        overlayEl.style.bottom = (viewportHeight - rect.top + 10) + 'px';
      } else {
        overlayEl.style.top = (rect.bottom + 10) + 'px';
      }
      overlayEl.classList.remove('hidden');
      // Initialize overlay map if not created
      if (!overlayMap) {
        overlayMap = L.map('overlay-map', {
          zoomControl: true,
          attributionControl: false
        });
        // 使用開放地圖瓦片
        const light = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 });
        const dark = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 });
        overlayMap.__lightLayer = light;
        overlayMap.__darkLayer = dark;
        light.addTo(overlayMap);
      }
      // Switch base layer based on current selection
      if (overlayCurrentBase === 'light') {
        if (overlayMap.__darkLayer) overlayMap.removeLayer(overlayMap.__darkLayer);
        if (overlayMap.__lightLayer) overlayMap.addLayer(overlayMap.__lightLayer);
      } else {
        if (overlayMap.__lightLayer) overlayMap.removeLayer(overlayMap.__lightLayer);
        if (overlayMap.__darkLayer) overlayMap.addLayer(overlayMap.__darkLayer);
      }
      // Remove existing markers representing other stores
      if (overlayMarkers.length > 0) {
        overlayMarkers.forEach(m => {
          if (overlayMap && overlayMap.hasLayer(m)) {
            overlayMap.removeLayer(m);
          }
        });
        overlayMarkers = [];
      }
      // Add markers for all stores (except the selected one) using risk-based colors
      stores.forEach(s => {
        if (!s.Latitude || !s.Longitude) return;
        if (s.Store_ID === store.Store_ID) return;
        let color = '#22c55e';
        const type = s.Alert_Type || '';
        if (type.includes('缺貨')) {
          color = '#f97373'; // 缺貨風險
        } else if (type.includes('過期')) {
          color = '#a855f7'; // 過期風險
        } else if (type.includes('滯銷')) {
          color = '#facc15'; // 滯銷風險
        } else if (type.includes('高庫存')) {
          color = '#38bdf8'; // 高庫存風險
        }
        const m = L.circleMarker([s.Latitude, s.Longitude], {
          radius: 5,
          color: color,
          fillColor: color,
          fillOpacity: 0.85,
          weight: 1
        });
        m.addTo(overlayMap);
        overlayMarkers.push(m);
      });
      // Set view and marker for selected store
      if (overlayMarker) {
        overlayMap.removeLayer(overlayMarker);
      }
      overlayMarker = L.marker([store.Latitude, store.Longitude]).addTo(overlayMap);
      overlayMap.setView([store.Latitude, store.Longitude], 14);
      // Clear heat circles on map overlay
      if (overlayHeatCircles.length > 0) {
        overlayHeatCircles.forEach(c => overlayMap.removeLayer(c));
        overlayHeatCircles = [];
      }
      // Invalidate map size after display and re-center on the selected store
      // Some devices may experience tearing when the map container is shown; delaying
      // the invalidate and setView calls helps Leaflet recalculate dimensions
      setTimeout(() => {
        if (overlayMap) {
          overlayMap.invalidateSize();
          // After invalidation, explicitly re-center on the selected store without animation
          overlayMap.setView([store.Latitude, store.Longitude], 14, { animate: false });
        }
      }, 100);
    }

    function closeMapOverlay() {
      const overlayEl = document.getElementById('map-overlay');
      if (!overlayEl.classList.contains('hidden')) {
        overlayEl.classList.add('hidden');
        overlayEl.classList.remove('expanded');
        if (overlayMap && overlayMarker) {
          overlayMap.removeLayer(overlayMarker);
          overlayMarker = null;
        }
        if (overlayMap && overlayHeatCircles.length > 0) {
          overlayHeatCircles.forEach(c => overlayMap.removeLayer(c));
          overlayHeatCircles = [];
        }
        // Remove any extra overlay markers for other stores
        if (overlayMap && overlayMarkers.length > 0) {
          overlayMarkers.forEach(m => {
            if (overlayMap.hasLayer(m)) overlayMap.removeLayer(m);
          });
          overlayMarkers = [];
        }
      }
    }

    function toggleOverlayExpansion() {
      const overlayEl = document.getElementById('map-overlay');
      overlayEl.classList.toggle('expanded');
    }

    function toggleOverlayBase() {
      overlayCurrentBase = overlayCurrentBase === 'light' ? 'dark' : 'light';
      if (!overlayMap) return;
      if (overlayCurrentBase === 'light') {
        if (overlayMap.__darkLayer) overlayMap.removeLayer(overlayMap.__darkLayer);
        if (overlayMap.__lightLayer) overlayMap.addLayer(overlayMap.__lightLayer);
      } else {
        if (overlayMap.__lightLayer) overlayMap.removeLayer(overlayMap.__lightLayer);
        if (overlayMap.__darkLayer) overlayMap.addLayer(overlayMap.__darkLayer);
      }
    }

    // ------- 地區消長圖表 -------
    let regionChart = null;

    function openRegionChart(noHistory) {
      const modal = document.getElementById('region-modal');
      const canvas = document.getElementById('region-chart-canvas');
      if (!modal || !canvas) return;
      modal.style.display = 'flex';
      // 記錄狀態並推入歷史堆疊，方便返回上一頁；
      // 當 noHistory 為 true 時，僅開啟圖表但不新增瀏覽器歷史紀錄，
      // 用於從 popstate 回到圖表頁面時避免重複 pushState 造成返回兩次即離開網站。
      regionModalOpen = true;
      if (!noHistory) {
        history.pushState({ regionChartOpen: true }, "");
      }
      // Prepare aggregated sales and growth by county (computed from stores)
      const countyOrder = [
        '基隆市','臺北市','新北市','桃園市','新竹市','新竹縣','苗栗縣',
        '臺中市','彰化縣','南投縣','雲林縣','嘉義市','嘉義縣',
        '臺南市','高雄市','屏東縣','宜蘭縣','花蓮縣','臺東縣',
        '澎湖縣','金門縣','連江縣'
      ];

      if (!Array.isArray(stores) || stores.length === 0) {
        showToast('資料尚未載入，請稍後再試');
        return;
      }

      const regionMap = {};
      stores.forEach(s => {
        const region = normalizeRegion(s.Region);
        if (!region) return;

        const sales = parseNumeric(
          s.Weekly_Sales ?? s.weekly_sales ?? s['Weekly Sales'] ?? s['WEEKLY SALES']
        );
        if (!Number.isFinite(sales)) return;

        const rate = parseRate(
          s.Weekly_Growth_Rate ?? s.weekly_growth_rate ?? s['Weekly Growth Rate'] ?? s['WEEKLY GROWTH RATE']
        );
        const delta = Number.isFinite(rate) ? (sales * rate) : 0;

        if (!regionMap[region]) regionMap[region] = { sales: 0, growth: 0 };
        regionMap[region].sales += sales;
        regionMap[region].growth += delta;
      });

      const knownLabels = countyOrder.filter(r => regionMap[r]);
      const extraLabels = Object.keys(regionMap)
        .filter(r => !countyOrder.includes(r))
        .sort((a, b) => a.localeCompare(b, 'zh-Hant'));
      const labels = knownLabels.concat(extraLabels);

      const salesData = labels.map(r => regionMap[r].sales);
      const growthData = labels.map(r => regionMap[r].growth);

// 根據縣市數量計算圖表高度，使每個條形有足夠高度顯示，無需垂直捲動。
      if (canvas) {
        /*
         * 為區域消長圖表動態計算高度，使所有縣市能在一頁呈現而不需要滾動。
         * 先預留 60px 上下邊距，再將可用高度（視窗 80%）除以縣市數量得到每條 bar 的預估高度。
         * 為避免條形過粗或過薄，將 bar 高度限制在 8~28px 之間。最後計算總高。
         */
        const viewportMax = window.innerHeight * 0.8;
        const tentativePerBar = (viewportMax - 60) / labels.length;
        const perBar = Math.max(Math.min(tentativePerBar, 28), 8);
        const newHeight = perBar * labels.length + 60;
        canvas.style.height = newHeight + 'px';
        // 每條 bar 的厚度減去 4px 間距，並設定為 dataset barThickness。
        canvas.dataset.barThickness = Math.max(perBar - 4, 4).toFixed(2);
      }
      // Destroy existing chart if present
      if (regionChart) {
        regionChart.destroy();
      }
      const ctx = canvas.getContext('2d');
      // 根據計算出的 barThickness 設定條形高度，使圖表一次呈現所有縣市
      const barThicknessValue = parseFloat(canvas.dataset.barThickness || '0');
      // 依照主題決定背景、文字顏色
      const isLight = document.body.classList.contains('light-theme');
      const bgColor = isLight ? '#fff7eb' : '#020617';
      const xTickColor = isLight ? '#6b7280' : '#9ca3af';
      const yTickColor = isLight ? '#6b7280' : '#6b7280';
      const gridColor = isLight ? 'rgba(0,0,0,0.08)' : 'rgba(75,85,99,0.3)';
      // 確保在暗色模式下 canvas 背景與主題一致，避免顯示淺色背景
      canvas.style.background = bgColor;
      regionChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: '銷售量',
              data: salesData,
              backgroundColor: 'rgba(56,189,248,0.7)',
              borderColor: 'rgba(56,189,248,1)',
              borderWidth: 1,
              barThickness: barThicknessValue || undefined
            },
            {
              label: '增減量',
              data: growthData,
              backgroundColor: 'rgba(248,113,113,0.7)',
              borderColor: 'rgba(248,113,113,1)',
              borderWidth: 1,
              barThickness: barThicknessValue || undefined
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          scales: {
            x: {
              beginAtZero: true,
              ticks: {
                color: xTickColor,
                font: { size: 10 }
              },
              grid: {
                color: gridColor
              }
            },
            y: {
              ticks: {
                color: yTickColor,
                font: { size: 10 }
              },
              grid: {
                display: false
              }
            }
          },
          plugins: {
            customCanvasBackgroundColor: { color: bgColor },
            legend: {
              labels: {
                color: xTickColor,
                font: { size: 11 }
              }
            }
          }
        }
      });
      // 點擊圖表上的長條或縣市名稱可開啟對應的全部門市表格並排序
      canvas.onclick = function(evt) {
        if (!regionChart) return;
        const tableEl = document.getElementById('store-table');
        const tableBackdrop = document.getElementById('table-backdrop');
        const regionSelect = document.getElementById('table-region-filter');
        const growthSelect = document.getElementById('table-growth-filter');
        const riskSelect = document.getElementById('table-risk-filter');
        // 先判斷是否點擊了長條（資料點）
        const points = regionChart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
        let clickedRegion = null;
        let sortBy = '';
        if (points && points.length > 0) {
          const first = points[0];
          const datasetIndex = first.datasetIndex;
          const index = first.index;
          clickedRegion = regionChart.data.labels[index] || '';
          // 根據資料集決定排序：0 為銷售量，1 為增減量
          if (datasetIndex === 0) {
            sortBy = 'sales';
          } else if (datasetIndex === 1) {
            sortBy = 'growth';
          }
        } else {
          // 若未點擊到長條，判定是否點擊在縣市名稱區域
          try {
            const scaleY = regionChart.scales.y;
            const rect = canvas.getBoundingClientRect();
            const y = evt.clientY - rect.top;
            const value = scaleY.getValueForPixel(y);
            const idx = Math.round(value);
            if (idx >= 0 && idx < regionChart.data.labels.length) {
              clickedRegion = regionChart.data.labels[idx] || '';
              sortBy = 'distance';
            }
          } catch (er) {
            // ignore
          }
        }
        if (!clickedRegion) return;
        // 不論是否開啟，都先關閉圖表，以免表格被遮擋
        closeRegionChart();
        // 更新全表篩選與排序
        // 將臺替換成台以符合 stores 中的 Region
        const regionFilterRaw = clickedRegion.replace('臺','台');
        tableRegionFilter = regionFilterRaw;
        tableGrowthFilter = 'all';
        tableRiskFilter = 'all';
        tableSortBy = sortBy;
        if (regionSelect) regionSelect.value = regionFilterRaw || 'all';
        if (growthSelect) growthSelect.value = 'all';
        if (riskSelect) riskSelect.value = 'all';
        renderFullTable(tableEl);
        if (tableBackdrop) {
          tableBackdrop.classList.add('table-backdrop--show');
          tableOpen = true;
          // 推入表格狀態並保存來自區域圖表的縣市，用於返回時重新顯示圖表
          history.pushState({ tableOpen: true, regionFromChart: clickedRegion }, '');
        }
      };
    }

    function closeRegionChart() {
      const modal = document.getElementById('region-modal');
      if (modal) {
        modal.style.display = 'none';
      }
      regionModalOpen = false;
    }

  /**
   * 建立門市分佈用的地區下拉選單內容。
   * 依 stores 中出現的縣市生成清單，第一項為「全部縣市」。
   */
  function buildRegionDropdown() {
    const dropdown = document.getElementById('region-dropdown');
    if (!dropdown) return;
    // 清空列表
    dropdown.innerHTML = '';
    // 建立「全部縣市」項目
    const allItem = document.createElement('div');
    allItem.className = 'region-item';
    allItem.dataset.value = '';
    allItem.textContent = '全部縣市';
    dropdown.appendChild(allItem);
    // 收集出現的縣市（取代台為臺以統一排序）
    const seen = new Set();
    stores.forEach(s => {
      if (!s.Region) return;
      // Normalize region: unify 台 to 臺 and trim whitespace
      const name = normalizeRegion(s.Region);
      if (name) seen.add(name);
    });
    // Convert to array and sort by zh-Hant locale.  Always sort alphabetically; do not rely on a static countyOrder
    const regions = Array.from(seen);
    const ordered = regions.sort((a, b) => a.localeCompare(b, 'zh-Hant'));
    ordered.forEach(region => {
      const item = document.createElement('div');
      item.className = 'region-item';
      item.dataset.value = region;
      item.textContent = region;
      dropdown.appendChild(item);
    });
    // 標記當前選擇的項目為 active
    dropdown.querySelectorAll('.region-item').forEach(el => {
      const val = el.dataset.value || '';
      el.classList.toggle('active', normalizeRegion(currentRegionFilter) === val);
    });
  }

  /**
   * 切換區域下拉選單顯示/隱藏。
   */
  function toggleRegionDropdown() {
    const dropdown = document.getElementById('region-dropdown');
    if (!dropdown) return;
    if (!regionDropdownVisible) {
      buildRegionDropdown();
      dropdown.style.display = 'block';
      regionDropdownVisible = true;
      // 推入歷史狀態，使返回可關閉選單
      history.pushState({ regionDropdown: true }, "");
    } else {
      // 關閉下拉選單：透過 history.back() 讓 popstate 處理
      history.back();
    }
  }

  /**
   * 初始化區域下拉選單的事件處理，包括項目選擇與點擊外部關閉。
   */
  function initRegionFilterControls() {
    const dropdown = document.getElementById('region-dropdown');
    const distributionBtn = document.getElementById('tab-distribution');
    if (!dropdown || !distributionBtn) return;
    // 根據當前篩選值初始化按鈕文字
    distributionBtn.textContent = currentRegionFilter ? currentRegionFilter : '門市分佈';
    // 點擊門市分佈按鈕時顯示/隱藏下拉選單
    distributionBtn.addEventListener('click', () => {
      // 將標籤設為活動狀態
      setActiveTab('distribution');
      // 切換下拉選單
      toggleRegionDropdown();
      // 頁面滾動至頂部
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    // 點擊下拉清單項目
    dropdown.addEventListener('click', e => {
      const item = e.target.closest('.region-item');
      if (!item) return;
      const value = item.dataset.value || '';
      currentRegionFilter = value;
      // 更新活動狀態
      dropdown.querySelectorAll('.region-item').forEach(el => {
        el.classList.toggle('active', el.dataset.value === value);
      });
      // 更新門市分佈按鈕文字
      distributionBtn.textContent = value ? value : '門市分佈';
      // 重新渲染列表與摘要
      renderStoreList();
      initSummary();
      // 選擇地區後，自動捲動至頂端
      window.scrollTo({ top: 0, behavior: 'smooth' });
      // 若下拉選單正在顯示，使用 history.back() 關閉並更新標誌
      if (regionDropdownVisible) {
        history.back();
      }
    });
    // 點擊外部區域關閉下拉選單
    document.addEventListener('click', e => {
      if (!dropdown.contains(e.target) && !distributionBtn.contains(e.target)) {
        if (regionDropdownVisible) {
          history.back();
        }
      }
    });
  }

    // ------- 全螢幕戰情模式 -------
    let warMap = null;
    // 儲存戰情模式中最後點選的門市資訊，以便返回後重新顯示彈窗
    let selectedWarStore = null;
    // 用於在戰情模式返回時還原最後顯示的小卡
    let lastWarPopupStore = null;

    /**
     * 更新戰情模式中自訂標記層的位置與內容。將每家門市轉換為螢幕座標並繪製可點擊的圓點。
     */
    function updateWarMarkerLayer() {
      // When using the custom map, we manually position markers relative to the overall
      // lat/lon bounds rather than relying on Leaflet. This function clears
      // existing marker elements and re-adds them based on the stored bounds.
      const overlay = document.getElementById('war-marker-layer');
      const mapContainer = document.getElementById('war-map');
      if (!overlay || !mapContainer) return;
      // 使用固定的台灣邊界進行經緯度轉換，若動態邊界尚未計算或範圍極小，則採用預設值
      let minLat = (warMinLat != null && warMaxLat != null && (warMaxLat - warMinLat) > 0.1) ? warMinLat : TAIWAN_MIN_LAT;
      let maxLat = (warMaxLat != null && warMaxLat - warMinLat > 0.1) ? warMaxLat : TAIWAN_MAX_LAT;
      let minLon = (warMinLon != null && warMaxLon != null && (warMaxLon - warMinLon) > 0.1) ? warMinLon : TAIWAN_MIN_LON;
      let maxLon = (warMaxLon != null && warMaxLon - warMinLon > 0.1) ? warMaxLon : TAIWAN_MAX_LON;

      // If map bounds have not yet been computed, derive them from all store
      // coordinates. Fall back to Taiwan constants if stores have invalid
      // coordinates. This ensures markers display correctly even without
      // dynamic geolocation.
      if (warMinLat === null || warMaxLat === null || warMinLon === null || warMaxLon === null) {
        let minLatAll = Infinity, maxLatAll = -Infinity, minLonAll = Infinity, maxLonAll = -Infinity;
        stores.forEach(s => {
          if (!s.Latitude || !s.Longitude) return;
          const latVal = parseFloat(s.Latitude);
          const lonVal = parseFloat(s.Longitude);
          if (latVal < minLatAll) minLatAll = latVal;
          if (latVal > maxLatAll) maxLatAll = latVal;
          if (lonVal < minLonAll) minLonAll = lonVal;
          if (lonVal > maxLonAll) maxLonAll = lonVal;
        });
        if (minLatAll !== Infinity && maxLatAll !== -Infinity) {
          warMinLat = minLatAll;
          warMaxLat = maxLatAll;
          warMinLon = minLonAll;
          warMaxLon = maxLonAll;
        }
      }
      overlay.innerHTML = '';
      const width = mapContainer.clientWidth;
      const height = mapContainer.clientHeight;
      stores.forEach(s => {
        if (!s.Latitude || !s.Longitude) return;
        const lat = parseFloat(s.Latitude);
        const lon = parseFloat(s.Longitude);
        // 使用計算出的邊界或預設邊界來計算在容器中的位置百分比
        const xPct = (lon - minLon) / (maxLon - minLon);
        const yPct = 1 - (lat - minLat) / (maxLat - minLat);
        const leftPx = xPct * width;
        const topPx = yPct * height;
        // Determine marker colour based on risk
        let color = '#22c55e';
        const type = s.Alert_Type || '';
        if (type.includes('缺貨')) {
          color = '#f97373';
        } else if (type.includes('過期')) {
          color = '#a855f7';
        } else if (type.includes('滯銷')) {
          color = '#facc15';
        } else if (type.includes('高庫存')) {
          color = '#38bdf8';
        }
        const dot = document.createElement('div');
        dot.className = 'war-marker-dot';
        dot.style.backgroundColor = color;
        // 直接使用定位座標，讓 transform:translate(-50%,-50%) 負責偏移
        dot.style.left = leftPx + 'px';
        dot.style.top = topPx + 'px';
        dot.addEventListener('click', e => {
          e.stopPropagation();
          handleWarMarkerClick(s);
        });
        overlay.appendChild(dot);
      });
    }
    // 使用者定位標記（Leaflet 已不再使用，但保留變數供未來擴充）
    let warUserMarker = null;
    // 儲存戰情地圖的緯度經度邊界，用於自訂座標轉換
    let warMinLat = null;
    let warMaxLat = null;
    let warMinLon = null;
    let warMaxLon = null;

    // 固定台灣的緯經度邊界，用於在地圖模式中計算標記位置。若動態計算失敗，可使用這些值確保標記顯示
    const TAIWAN_MIN_LAT = 21.5;
    const TAIWAN_MAX_LAT = 25.5;
    const TAIWAN_MIN_LON = 119.0;
    const TAIWAN_MAX_LON = 122.5;
    // 用於主門市列表的區域篩選（門市分佈）
    let currentRegionFilter = "";
    // 追蹤區域下拉選單是否顯示中，供返回鍵關閉使用
    let regionDropdownVisible = false;
    // 追蹤全部門市表格的排序方式，支援 distance/sales/growth
    let tableSortBy = "";

    
    /**
     * 統一縣市欄位格式：去除空白、台 → 臺（不砍字）
     * - 去除前後與中間所有空白字元（含全形空白）
     * - 將「台」一律轉為「臺」
     */
    function normalizeRegion(input) {
      if (input == null) return '';
      let s = String(input);
      s = s.replace(/\s+/g, '');
      s = s.replace(/台/g, '臺');
      return s;
    }

    /**
     * 將可能包含逗號、箭頭符號、百分比等格式的數值轉成 Number。
     * e.g. "97", "1,256", "▲27.3%", "▼-1.5%"。
     */
    function parseNumeric(input) {
      if (input == null) return NaN;
      if (typeof input === 'number') return Number.isFinite(input) ? input : NaN;
      const s = String(input).trim();
      if (!s) return NaN;
      const cleaned = s
        .replace(/,/g, '')
        .replace(/[▲▼]/g, '');
      const m = cleaned.match(/-?\d+(?:\.\d+)?/);
      return m ? parseFloat(m[0]) : NaN;
    }

    /**
     * 解析成「成長率」的小數值。
     * - 若含 %：視為百分比（27.3% => 0.273）
     * - 若不含 % 但絕對值 > 1：視為百分比（27.3 => 0.273）
     * - 其餘視為小數（0.273 => 0.273）
     */
    function parseRate(input) {
      if (input == null) return NaN;
      if (typeof input === 'number') {
        if (!Number.isFinite(input)) return NaN;
        return Math.abs(input) > 1 ? (input / 100) : input;
      }
      const s = String(input).trim();
      if (!s) return NaN;
      const hasPercent = s.includes('%');
      const n = parseNumeric(s);
      if (!Number.isFinite(n)) return NaN;
      if (hasPercent) return n / 100;
      return Math.abs(n) > 1 ? (n / 100) : n;
    }

    // 台灣各縣市逆時針排序，用於區域相關功能（門市分佈、地區消長）
    const countyOrder = [
      '基隆市','新北市','臺北市','台北市','桃園市','新竹市','新竹縣','苗栗縣',
      '臺中市','台中市','彰化縣','南投縣','雲林縣','嘉義市','嘉義縣','臺南市','台南市',
      '高雄市','屏東縣','臺東縣','台東縣','花蓮縣','宜蘭縣','澎湖縣','金門縣','連江縣'
    ];

    function openWarMode(skipPush = false) {
      const warOverlay = document.getElementById('war-map-overlay');
      if (!warOverlay) return;
      // Show the overlay
      warOverlay.style.display = 'flex';
      // Hide any existing war popup when entering war mode
      hideWarPopup();
      // Push state for war mode navigation if not suppressed
      if (!skipPush) {
        history.pushState({ warMode: true }, "");
      }
      warOverlayOpen = true;
      // We no longer rely on Leaflet for map rendering. Instead, we
      // compute the lat/lon bounds for all stores once and draw markers
      // relative to the map container. Recompute bounds so markers scale
      // appropriately when opening.
      warMinLat = null;
      warMaxLat = null;
      warMinLon = null;
      warMaxLon = null;
      // Render markers onto the overlay layer. 由於地圖元素在顯示時才會有正確尺寸，
      // 因此先立即更新一次，再以短延遲重新計算位置，避免容器寬高為 0 導致標記消失。
      updateWarMarkerLayer();
      setTimeout(() => {
        if (warOverlayOpen) updateWarMarkerLayer();
      }, 50);
    }

    /**
     * Handle click on a marker in war mode. Closes the war map overlay and
     * opens the store detail view. Does not push additional history state
     * because openBottomSheet will push its own state. The warMode state
     * remains in the history stack so the user can return to the map via
     * the browser back button.
     * @param {Object} store
     */
    function handleWarMarkerClick(store) {
      // 點擊戰情模式中的標記時，僅顯示小卡，不立即開啟詳細頁
      showWarPopup(store);
    }

    /**
     * Schedule a daily reset at midnight to clear all processed store marks.
     * Calculates the milliseconds until the next midnight and sets a timeout.
     */
    function scheduleDoneReset() {
      const now = new Date();
      const nextMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0);
      const msUntilMidnight = nextMidnight.getTime() - now.getTime();
      setTimeout(() => {
        // Clear processed flags
        stores.forEach(s => {
          s.__done = false;
        });
        renderStoreList();
        initSummary();
        // Schedule the next reset
        scheduleDoneReset();
      }, msUntilMidnight);
    }

    // Whenever the browser window is resized, recalculate war-map marker positions
    // if the war map overlay is currently open. This listener is placed outside
    // of updateWarMarkerLayer() to avoid adding multiple handlers on every call.
    window.addEventListener('resize', () => {
      if (typeof warOverlayOpen !== 'undefined' && warOverlayOpen) {
        updateWarMarkerLayer();
      }
    });

    function closeWarMode() {
      const warOverlay = document.getElementById('war-map-overlay');
      if (!warOverlay) return;
      warOverlay.style.display = 'none';
      warOverlayOpen = false;
      // 關閉戰情地圖時也隱藏門市彈窗
      hideWarPopup();
      // 清除最後彈出的小卡資訊
      lastWarPopupStore = null;
    }

    /**
     * 顯示戰情模式的小卡彈窗。按下店鋪標記後顯示店鋪資訊，整個彈窗可點擊以打開詳細資料。
     * @param {Object} store
     */
    function showWarPopup(store) {
      selectedWarStore = store;
      // 記錄最後彈出的小卡，以便返回時重新顯示
      lastWarPopupStore = store;
      const popup = document.getElementById('war-popup');
      if (!popup) return;
      // 組建內容：顯示狀態顏色點、門市名稱、週銷售與週成長率
      const riskClass = getRiskClass(store);
      const criticalClass = store.Alert_Level === 'critical' ? 'is-critical' : '';
      const growth = (store.Weekly_Growth_Rate || 0) * 100;
      const sign = growth >= 0 ? '+' : '';
      const sales = store.Weekly_Sales || 0;
      const growthClassName = growth >= 0 ? 'popup-growth-positive' : 'popup-growth-negative';
      popup.innerHTML = `
        <div class="popup-title">
          <span class="status-dot ${riskClass} ${criticalClass}" style="margin-right:6px;"></span>
          ${store.Store_Name}
        </div>
        <div class="popup-subtitle">週銷售 ${sales} · <span class="${growthClassName}">${sign}${growth.toFixed(0)}%</span></div>
      `;
      popup.classList.remove('hidden');
      popup.style.display = 'block';
      // 依照標記位置調整小卡上下位置，使其不遮擋標記
      try {
        const mapEl = document.getElementById('war-map');
        if (mapEl && warMinLat !== null) {
          const lat = parseFloat(store.Latitude);
          const lon = parseFloat(store.Longitude);
          const yPct = 1 - (lat - warMinLat) / (warMaxLat - warMinLat);
          const mapHeight = mapEl.clientHeight;
          const yPos = yPct * mapHeight;
          popup.style.left = '16px';
          popup.style.right = '16px';
          if (yPos < mapHeight / 2) {
            popup.style.top = (yPos + 30) + 'px';
            popup.style.bottom = 'auto';
          } else {
            popup.style.bottom = (mapHeight - yPos + 30) + 'px';
            popup.style.top = 'auto';
          }
        } else {
          // fallback: default bottom position
          popup.style.bottom = '80px';
          popup.style.top = 'auto';
        }
      } catch (e) {
        // fallback: default bottom position
        popup.style.bottom = '80px';
        popup.style.top = 'auto';
      }
      // 點擊彈窗打開詳細資訊
      popup.onclick = () => {
        // 隱藏彈窗
        hideWarPopup();
        // 顯示詳細資訊
        if (typeof isDesktop === 'function' && isDesktop()) {
          renderDetailDesktop(store);
        } else {
          renderDetailMobile(store);
        }
      };
    }

    /**
     * 隱藏戰情模式的小卡彈窗並清除選擇。
     */
    function hideWarPopup() {
      const popup = document.getElementById('war-popup');
      if (popup) {
        popup.style.display = 'none';
        popup.classList.add('hidden');
        popup.innerHTML = '';
      }
      selectedWarStore = null;
    }

    function toggleOverlayHeat() {
      if (!overlayMap) return;
      if (overlayHeatCircles.length === 0) {
        const maxSales = Math.max(...stores.map(s => s.Weekly_Sales || 1));
        stores.forEach(store => {
          const intensity = Math.max(store.Weekly_Sales || 1, 1) / maxSales;
          const circle = L.circle([store.Latitude, store.Longitude], {
            radius: 5000,
            color: 'transparent',
            fillColor: '#f97373',
            fillOpacity: Math.min(intensity * 2, 1)
          });
          circle.addTo(overlayMap);
          overlayHeatCircles.push(circle);
        });
      } else {
        overlayHeatCircles.forEach(c => overlayMap.removeLayer(c));
        overlayHeatCircles = [];
      }
    }

    // Override legacy war-room toggles to no-op since war overlay uses its own logic
    function initWarModeControls() {}

    // 全域主題切換函式，用於按鈕 onclick 呼叫
    function toggleTheme() {
      const bodyEl = document.body;
      const isLight = bodyEl.classList.toggle('light-theme');
      localStorage.setItem('theme', isLight ? 'light' : 'dark');
    }

    document.addEventListener('DOMContentLoaded', () => {
      const baseBtn2 = document.getElementById('overlay-base-toggle');
      if (baseBtn2) {
        baseBtn2.addEventListener('click', e => {
          e.stopPropagation();
          toggleOverlayBase();
        });
      }
      const heatBtn2 = document.getElementById('overlay-heat-toggle');
      if (heatBtn2) {
        heatBtn2.addEventListener('click', e => {
          e.stopPropagation();
          toggleOverlayHeat();
        });
      }
      const overlayEl = document.getElementById('map-overlay');
      if (overlayEl) {
        overlayEl.addEventListener('click', e => {
          // 如果點擊的是地圖上的控制按鈕，則不要觸發放大
          if (e.target.closest('.overlay-map-controls')) return;
          toggleOverlayExpansion();
        });
      }
      const listEl = document.getElementById('store-list');
      if (listEl) {
        listEl.addEventListener('scroll', () => {
          closeMapOverlay();
        });
      }
      window.addEventListener('scroll', () => {
        closeMapOverlay();
      });

      // 地圖模式按鈕：打開全螢幕地圖覆蓋層。原戰情模式已整合進地圖模式。
      const warBtn = document.getElementById('mode-switch');
      if (warBtn) {
        warBtn.addEventListener('click', () => {
          // 滑動至頂端後開啟地圖覆蓋層
          window.scrollTo({ top: 0, behavior: 'smooth' });
          openFullscreenMap();
        });
      }
      // 戰情模式返回鈕：使用 history.back() 以觸發 popstate 邏輯
      const warBackBtn = document.getElementById('war-back-button');
      if (warBackBtn) {
        warBackBtn.addEventListener('click', () => {
          history.back();
        });
      }
      // 戰情模式 Here 按鈕
      const warHereBtn = document.getElementById('war-here-button');
      if (warHereBtn) {
        warHereBtn.addEventListener('click', () => {
          // 在自訂地圖中進行定位：取得使用者位置並在標記層上繪製一個藍點
          if (!navigator.geolocation) {
            alert('無法取得定位：瀏覽器不支援');
            return;
          }
          navigator.geolocation.getCurrentPosition(
            pos => {
              const { latitude, longitude } = pos.coords;
              // 若尚未計算邊界，先計算
              if (warMinLat === null) {
                warMinLat = Infinity;
                warMaxLat = -Infinity;
                warMinLon = Infinity;
                warMaxLon = -Infinity;
                stores.forEach(s => {
                  if (!s.Latitude || !s.Longitude) return;
                  const lat = parseFloat(s.Latitude);
                  const lon = parseFloat(s.Longitude);
                  if (lat < warMinLat) warMinLat = lat;
                  if (lat > warMaxLat) warMaxLat = lat;
                  if (lon < warMinLon) warMinLon = lon;
                  if (lon > warMaxLon) warMaxLon = lon;
                });
              }
              const overlay = document.getElementById('war-marker-layer');
              const mapContainer = document.getElementById('war-map');
              if (!overlay || !mapContainer) return;
              // 移除舊的 user 標記
              const oldUser = overlay.querySelector('.war-user-dot');
              if (oldUser) oldUser.remove();
              const width = mapContainer.clientWidth;
              const height = mapContainer.clientHeight;
              const xPct = (longitude - warMinLon) / (warMaxLon - warMinLon);
              const yPct = 1 - (latitude - warMinLat) / (warMaxLat - warMinLat);
              const leftPx = xPct * width;
              const topPx = yPct * height;
              const marker = document.createElement('div');
              marker.className = 'war-user-dot';
              marker.style.left = leftPx + 'px';
              marker.style.top = topPx + 'px';
              overlay.appendChild(marker);
            },
            () => {
              alert('定位失敗，請確認位置權限已開啟');
            }
          );
        });
      }
      // 地區消長圖表關閉按鈕
      const regionCloseBtn = document.getElementById('region-modal-close');
      if (regionCloseBtn) {
        regionCloseBtn.addEventListener('click', () => {
          // 使用 history.back() 讓 popstate 處理關閉邏輯
          history.back();
        });
      }

      // 地區消長按鈕：點擊開啟地區銷售消長圖表
      const regionOpenBtn = document.getElementById('drawer-toggle-button');
      if (regionOpenBtn) {
        regionOpenBtn.addEventListener('click', () => {
          // 打開地區消長圖表時捲動至頂端
          window.scrollTo({ top: 0, behavior: 'smooth' });
          openRegionChart();
        });
      }

      // 取消已處理標記按鈕：清除所有已標記門市
      const cancelMarkBtn = document.getElementById('cancel-mark-button');
      if (cancelMarkBtn) {
        cancelMarkBtn.addEventListener('click', () => {
          // 返回頁首
          window.scrollTo({ top: 0, behavior: 'smooth' });
          stores.forEach(s => {
            s.__done = false;
          });
          renderStoreList();
          initSummary();
        });
      }

      // 安排每天午夜重置已處理標記
      scheduleDoneReset();

      /*
       * 移除離開頁面確認提示：在本地文件環境下使用瀏覽器返回鍵
       * 時常引發不必要的「離開網站」對話框，導致無法正常關閉
       * 全螢幕地圖或區域圖表。若需要離開確認，可自行恢復此事件監聽。
       */
      // window.addEventListener('beforeunload', e => {
      //   e.preventDefault();
      //   e.returnValue = '確認離開嗎？';
      // });

      // 主題切換事件由 toggleTheme() 函式及 onclick 直接處理
      // 初始化主題：根據 localStorage 設置初始主題
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'light') {
        document.body.classList.add('light-theme');
      }
    });
  </script>
  <!-- Fullscreen map overlay and ripple effects -->
  <script>
    // Global variables for the fullscreen map
    let fullMapInitialized = false;
    let fullMap;
    let fullMapCluster;
    // Track whether the fullscreen map overlay is currently open.  This
    // state is used together with history.pushState/popstate to ensure
    // that pressing the browser back button closes the overlay instead
    // of navigating away from the application.
    let fullscreenMapOpen = false;

    function openFullscreenMap(skipHistory = false) {
      const overlay = document.getElementById('fullscreen-map-overlay');
      if (!overlay) return;
      // When opening the fullscreen map, push a history state so that the back
      // button will close the overlay.  Only push once when the overlay is
      // not already open and history entry is not being restored (skipHistory).
      if (!fullscreenMapOpen) {
        if (!skipHistory) {
          history.pushState({ fullscreenMap: true }, "");
        }
        fullscreenMapOpen = true;
      }
      overlay.style.display = 'flex';
      // Prevent body from scrolling while overlay is shown
      document.body.style.overflow = 'hidden';
      if (!fullMapInitialized) {
        // Initialize a new Leaflet map for the fullscreen overlay
        fullMap = L.map('fullscreen-map-container', {
          zoomControl: true,
          attributionControl: false
        }).setView([23.7, 121], 7);
        // Use a dark CartoDB tile for consistency with the dark theme
        const fullTile = L.tileLayer(
          'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
          { maxZoom: 19 }
        );
        fullTile.addTo(fullMap);
        // Initialize a marker cluster group for better performance on large maps
        fullMapCluster = L.markerClusterGroup({
          maxClusterRadius: 40,
          disableClusteringAtZoom: 15,
          showCoverageOnHover: false
        });
        // Add markers for each store with sales information and growth indicator.
        stores.forEach(store => {
          const color = getPinColor(store.__salesColor || 'gray');
          const marker = L.circleMarker([store.Latitude, store.Longitude], {
            radius: 8,
            fillColor: color,
            color: '#ffffff',
            weight: 1,
            opacity: 1,
            fillOpacity: 0.85
          });
          // Bind popup content showing store name, weekly sales and growth
          const growthRate = store.Weekly_Growth_Rate || 0;
          const growthPercent = Math.abs(growthRate * 100).toFixed(1) + '%';
          const arrow = growthRate >= 0 ? '▲' : '▼';
          const growthColor = growthRate >= 0 ? '#ef4444' : '#10b981';
          const popupContent = `<strong>${store.Store_Name}</strong><br>` +
            `銷售量：${store.Weekly_Sales} 箱<br>` +
            `增減量：<span style="color:${growthColor}">${arrow} ${growthPercent}</span>`;
          marker.bindPopup(popupContent, { offset: [0, -8] });
          // Do not automatically open the detail panel when clicking markers in fullscreen map.
          // Clicking the marker will simply show the popup with store information.
          fullMapCluster.addLayer(marker);
        });
        fullMapCluster.addTo(fullMap);
        fullMapInitialized = true;
      } else {
        // Refresh size if the overlay has been displayed before
        fullMap.invalidateSize();
      }
    }

    function closeFullscreenMap() {
      // When closing the fullscreen map via the close button, trigger history
      // back to pop the fullscreenMap state and let the popstate handler
      // perform overlay cleanup.  If the overlay is not open, do nothing.
      if (fullscreenMapOpen) {
        history.back();
      }
    }

    // Attach events after DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      // Bind open and close buttons if they exist
      const fullBtn = document.getElementById('full-map-button');
      if (fullBtn) {
        fullBtn.addEventListener('click', openFullscreenMap);
      }
      const closeBtn = document.getElementById('fullscreen-map-close');
      if (closeBtn) {
        closeBtn.addEventListener('click', closeFullscreenMap);
      }
      // Apply ripple effects to chip and primary/secondary/ghost buttons
      const targets = document.querySelectorAll('.chip-button, .btn');
      targets.forEach(btn => {
        // Ensure the ripple container class is present
        btn.classList.add('btn-ripple');
        btn.addEventListener('click', function (e) {
          const rect = btn.getBoundingClientRect();
          const diameter = Math.max(rect.width, rect.height);
          const radius = diameter / 2;
          const ripple = document.createElement('span');
          ripple.classList.add('ripple');
          ripple.style.width = ripple.style.height = `${diameter}px`;
          // Determine click position relative to the button
          const offsetX = e.clientX - rect.left;
          const offsetY = e.clientY - rect.top;
          ripple.style.left = `${offsetX - radius}px`;
          ripple.style.top = `${offsetY - radius}px`;
          // Remove any existing ripple
          const existing = btn.querySelector('.ripple');
          if (existing) existing.remove();
          btn.appendChild(ripple);
          // Remove ripple after animation completes
          setTimeout(() => ripple.remove(), 600);
        });
      });
    });
  </script>
</body>
</html>
